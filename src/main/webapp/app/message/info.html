<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>聊天组信息</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/msg.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/member.css">

<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>
<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>

<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<style type="text/css">
.info_box1 .user_list li b img{
width:100%;height:100%;
}
</style>
</head>
<script type="text/javascript">
var groupId=getUrlParam("groupId");
var isGroud=getUrlParam("isGroud");

var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
	}
)
function getinfodetail(){
	console.log("连接成功");
}
function clearrecord(){
	
	swal({
		title : "",
		text : "确定要清楚聊天记录吗？",
		type : "info",
		showCancelButton : true,
		confirmButtonColor : "#ff7922",
		confirmButtonText : "确认",
		cancelButtonText : "取消",
		closeOnConfirm : true
	}, function(){
		$.ajax({
			type:"post",
			dataType:"json",
			url:projectpath+"/app/deleteChatRecord",
			data:{
				groupid:groupId,
				userid:userInfo.userid
			},
			success:function(data){
				if(data.success){
					  setTimeout(function(){  
						  swal({
								title : "",
								text : "清除成功",
								type : "success",
								showCancelButton : false,
								confirmButtonColor : "#ff7922",
								confirmButtonText : "确认",
								cancelButtonText : "取消",
								closeOnConfirm : true
							}, function(){
							
							});
					  }, 100); 
				}else{
					console.log("消息清楚失败！");
				}
			}
		})
	});
	
	
	 
}
var createid="";
var userIds=[];
function getGroupInfo(){
	$.ajax({
		type:"post",
		dataType:"json",
		url:projectpath+"/app/getGroupInfo",
		data:"userid="+userInfo.userid+"&groupid="+groupId+"&this_userid="+userInfo.userid,
		success:function(data){
			$('#groupuserid').val(data.groupInfo.groupuserid);
			$('#groupname').text(data.groupInfo.groupname);
			$('#groupid').val(data.groupInfo.groupid);
 			if(data.groupInfo.istop==1){
				$('#istop').attr("class","on");
				$('#istop').attr("onclick","updateIstop('0','off')");
			}else{
				$('#istop').attr("class","off");
				$('#istop').attr("onclick","updateIstop('1','on')");
			}
			if(data.groupInfo.isdisturb==1){
				$('#isdisturb').attr("class","on");
				$('#isdisturb').attr("onclick","updateIsdisturb('0','off')");
			}else{
				$('#isdisturb').attr("class","off");
				$('#isdisturb').attr("onclick","updateIsdisturb('1','on')");
			}
			if(isGroud==2){
				$(".isGroud1show,#numdiv").hide();
				//$("#numdiv").hide();
			}
			
			createid=data.groupInfo.createid;
			$('#numdiv').html("全部群聊成员（"+data.groupInfo.userlist.length+"）");
			var temp="";
			for(var i=0;i<data.groupInfo.userlist.length;i++){
				userIds[i]=data.groupInfo.userlist[i].userid;
				if(data.groupInfo.userlist[i].userid!=userInfo.userid || isGroud==1){
					temp+="<li><b><img src=\""+projectpath+data.groupInfo.userlist[i].headimage+"\" onerror=this.src='"+hrefurl+"/app/appcssjs/images/defaultheadimage.png'></b><span>"+data.groupInfo.userlist[i].realname+"</span></li>";
				}
			}
			$("#addbtn").before(temp);
		}
	})
}
function initUpdateName(obj){
	var groupname=$(obj).text();
	$('#updategroupname').val(groupname);
	if(createid==userInfo.userid){
		$('#groupnamediv').show();
		$('#bodyhtml').hide();
	}
}

//添加人员
function logical(){
	var examineuserid=$('#examineuserid').val();
	var status=0;
	for(var i=0;i<userIds.length;i++){
		if(examineuserid==userIds[i]){
			status=1;
			break;
		}
	}
	if(status==0){
		if(isGroud==2){//单聊
			var userlist = [];
			for(var i=0;i<userIds.length;i++){
				userlist.push({"userid":userIds[i]});
			}
			userlist.push({"userid":examineuserid});
			userlist = JSON.stringify({"userlist":userlist});
		    //查询所有用户 去重
			$.ajax({
				type:"post",
				dataType:"json",
				url:projectpath+"/app/createManyGroup",
				data:"userlist="+userlist+"&createid="+userInfo.userid,
				success:function(data){
					swal({
						title : "",
						text : "创建群聊成功",
						type : "success",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "进入",
						closeOnConfirm : true
					}, function(){
						//进入聊天会话窗口 或者群聊窗口
						location.href="talk.html?isGroud=1&groupId="+data.groupId;
					});
				}
			})
		}else if(isGroud==1){  //群聊
			$.ajax({
				type:"post",
				dataType:"json",
				url:projectpath+"/app/addUserGroup",
				data:"userid="+examineuserid+"&groupid="+groupId+"&groupname="+$('#groupname').text(),
				success:function(data){
					var temp="<li><b><img src=\""+projectpath+data.userInfo.headimage+"\" onerror=this.src='"+hrefurl+"/app/appcssjs/images/defaultheadimage.png'></b><span>"+data.userInfo.realname+"</span></li>";
					$("#addbtn").before(temp);
					userIds.push(examineuserid);
				}
			})
		}else{
			$.ajax({
				type:"post",
				dataType:"json",
				url:projectpath+"/app/addUserGroup",
				data:"userid="+examineuserid+"&groupid="+groupId+"&groupname="+$('#groupname').text(),
				success:function(data){
					var temp="<li><b><img src=\""+projectpath+data.userInfo.headimage+"\"></b><span>"+data.userInfo.realname+"</span></li>";
					$("#addbtn").before(temp);
				}
			})
		}
	}else{
		$('#organizeiframe').show();
		$('#htmlbody').hide();
		swal({
			title: "",   
			text: $('#examinename').text()+"已经添加，不可重复添加！",
			type:"info",
			timer: 1500,
			html:true,
			showConfirmButton: false 
		});
		$('#examinename').text("");
		$('#examineuserid').val("");
	}
}
</script>
<body onload="getGroupInfo();">
<div id="htmlbody">
<div id="bodyhtml" >
<div class="head_box">
	<a class="ico_back" onclick="location.href='talk.html?isGroud='+isGroud+'&groupId='+groupId;">返回</a>
    <div class="name">聊天组信息</div>
</div>
<input type="hidden" id="examineuserid"/>
<span id="examinename" style="display: none"></span>

<input type="hidden" id="groupid"/>
<input type="hidden" id="groupuserid"/>
<div class="head_none"></div>
<div class="info_box1">
	<div class="name isGroud1show"><span>群聊名称</span><i  style="overflow:hidden;text-overflow:ellipsis;width:60%;"><nobr id="groupname" style="float:right;" onclick="initUpdateName(this)"></nobr></i></div>
    <div class="user_list">
    	<div class="num" id="numdiv"></div>
        <div class="li_list">
            <ul>
                <li id="addbtn"><b class="add"  onclick="$('#organizeiframe').show();$('#htmlbody').hide();">添加</b></li>
            </ul>
            <div class="clear"></div>
        </div>        
    </div>
</div>
<div class="info_box2">
	<ul>
         	<li><span>置顶聊天</span><i class="off" id="istop"><em>操作</em></i></li>
	        <li><span>消息免打扰</span><i class="off" id="isdisturb"><em>操作</em></i></li>
         	<li><span onclick="clearrecord()">清空聊天记录</span></li>
    </ul>
</div>
</div>

<div id="groupnamediv"  style="display: none;">
	<div class="head_box">
		<a class="ico_back" onclick="$('#groupnamediv').hide();$('#bodyhtml').show();">返回</a>
	    <div class="name"  >修改名称</div>
	  <div class="link_yellow" onclick="savename()">保存</div>
	</div>
	<div class="head_none"></div>
	<div class="ch_info">
		<span  ><input type="text" class="t_text" placeholder="请输入名称"  id ="updategroupname" maxlength="15"></span>
	</div>
</div>
</div>
<script type="text/javascript" src="../appcssjs/script/selectuser.js"></script>
<script type="text/javascript">

function updateIstop(istop,status){
 	if(istop==1){
 		RongIMClient.prototype.setConversationToTop = function(callback) {
 				  RongIMLib.CheckParam.getInstance().check(["number", "string", "object"],"setConversationToTop");
 				  //alert(groupId);
 				  RongIMClient._dataAccessProvider.setConversationToTop(RongIMLib.ConversationType.GROUP,groupId,callback);
 				};
 	}
	//修改置顶
	$.ajax({
		type:"post",
		dataType:"json",
		url:projectpath+"/app/updateUserGroup",
		data:"updateid="+userInfo.userid+"&groupuserid="+$('#groupuserid').val()+"&istop="+istop,
		success:function(data){
			if(istop=='1'){
				$('#istop').attr("onclick","updateIstop('0','off')");
			}else{
				$('#istop').attr("onclick","updateIstop('1','on')");
			}
			
		}
	})
	$('#istop').attr("class",status);
}

function updateIsdisturb(isdisturb,status){
	//消息免打扰
	$.ajax({
		type:"post",
		dataType:"json",
		url:projectpath+"/app/updateUserGroup",
		data:"updateid="+userInfo.userid+"&groupuserid="+$('#groupuserid').val()+"&isdisturb="+isdisturb,
		success:function(data){
			if(isdisturb=='1'){
				$('#isdisturb').attr("onclick","updateIsdisturb('0','off')");
			}else{
				$('#isdisturb').attr("onclick","updateIsdisturb('1','on')");
			}
			
		}
	})
	$('#isdisturb').attr("class",status);
}

function savename(){
	$('#groupnamediv').hide();$('#bodyhtml').show();
	if($('#updategroupname').val()==""){
		swal({
			title : "",
			text : "请输入名称",
			type : "error",
			showCancelButton : false,
			confirmButtonColor : "#ff7922",
			confirmButtonText : "确认",
			cancelButtonText : "取消",
			closeOnConfirm : true
		}, function(){
		
		});
		return;
	}
	$('#groupname').text($('#updategroupname').val());
	//修改群名称　、、修改数据库
	$.ajax({
		type:"post",
		dataType:"json",
		url:projectpath+"/app/updateGroupName",
		data:"updateid="+userInfo.userid+"&groupid="+$('#groupid').val()+"&groupname="+$('#updategroupname').val(),
		success:function(data){
			
		}
	})
}
</script>
</body>
</html>
