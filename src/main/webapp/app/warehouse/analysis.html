<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>库存分析</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/stock.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/echarts-all.js"></script>
<script type='text/javascript' src='../appcssjs/script/touchScroll.js'></script>
<script type='text/javascript' src='../appcssjs/script/touchslider.dev.js'></script>
<link href="../appcssjs/style/mobiscroll.custom-2.6.2.min.css" type="text/css" rel="stylesheet"> 
<script src="../appcssjs/script/mobiscroll.custom-2.6.2.min.js"></script> 
<style type="text/css">
	.erweima {
    display: block;
    float: right;
    width: 24px;
    height: 36px;
    background: url(../appcssjs/images/public/ico_ewm.png) no-repeat center;
    background-size: 24px 24px;
    line-height: 36px;
    text-indent: -999px;
    overflow: hidden;
}
</style>
</head>
<script type="text/javascript">

function qrcodeshow(obj){
	var imgutil = {
			FDIMG:function(dom){
				    var src = $(dom).attr( "src" );
				    var imgurl=$(dom).attr("imgurl");
				    var img=new Image();
					 img.src=src;
				     var width=img.width;
				     var height=img.height;//图片大小
					 if(width == 0 && height == 0){
						 return;
					 }
			          imgutil.isPC(function(flg){
			        	  imgutil.alt(function(data){
							  var winHeight =  data.height;
							  var winWidth =   data.width ;
							   if(flg){
								/*   if(width > winWidth){
							        	 width = (winWidth)*0.8; 
							        }
							      if(height>winHeight){
							        	 height = (winHeight)*0.8;
							        }*/
						          imgutil.AutoResizeImage(width, height, winWidth, winHeight*0.98,function(o){
						        	  
						        	  width = o.w;
						        	  height = o.h;
						        	   
						           });
						        	 
							   }else{
							         /*if(width > winWidth){
							        	 width = winWidth; 
							         }
							         if(height>winHeight){
							        	 height = winHeight;	 
							         }*/
								   imgutil.AutoResizeImage(width, height, winWidth, winHeight,function(o){
							        	  
							        	  width = o.w;
							        	  height = o.h;
							        	   
							           });
							  }

							     var top  = ((winHeight-height)/2);
								 var left = ((winWidth-width)/2);
								 //var top  = 0;
								 //var left = 0;
								
								/*var  html='<div onclick="$(\'.carrousel\').remove();" style="width:'+width+';height:'+height+';top:'+top+',left:'+left+';display:block" class="carrousel"> <span class="close entypo-cancel"></span>'; 
								     html+='<div class="wrapper"> <img align="center" src="'+src+'"/> </div>';
								     html+='</div>';*/
								
							     var img_model = new Date().getTime()+"img";
							     var html = 
											'<div id="win_PMG">'+
											'<div onclick="$(\'#win_PMG\').remove();" style="width: 100%; height: 100%; opacity:0.8; position: fixed; top:0px; background-color: #333; z-index: 9000">'+
											'</div>'+
											'<img onclick="$(\'#win_PMG\').remove();" id="'+img_model+'" src="'+src+'"    align="center" style="position: fixed; top:'+top+'px; left:'+left+'px; z-index: 9001; width: '+width+'px;height: '+height+'px">'+
// 											'<span align="center" style="position: fixed; top:'+(top+height)+'px; z-index: 9001;left:'+(winWidth/2 - 50)+'px; height:30px; line-height:30px; width:100px; border:1px solid #ff9b30; color:white; border-radius: 2px;'+
// 										    'background: #ff9b30 url(../images/public/ico_find.png) no-repeat center;background-size: 16px 16px;" onclick="downloadqrcode(\''+src+'\')">下载</span>'+
											'<div style="position: fixed; top:'+(top+height)+'px; z-index: 9001;left:'+left+'px; height:30px; line-height:30px; width:'+width+'px; color:white;'+
 										    'background-color:white;"><span style="margin-left:15px; color:#929292;">客户满意度二维码</span><a style="float:right; margin-right:20px; color:#ff9b30;" href="javascript:void(0)" onclick="downloadewm(\''+imgurl+'\')">下载</a></div>'
											'</div>';
							     $("body").append(html);
							  
						  });  
			        	  
			          });
					 
			        
			},AutoResizeImage : function (w,h,maxWidth,maxHeight,call){
				var hRatio;
				var wRatio;
				var Ratio = 1;
				wRatio = maxWidth / w;
				hRatio = maxHeight / h;
				if (maxWidth ==0 && maxHeight==0){
				Ratio = 1;
				}else if (maxWidth==0){//
				if (hRatio<1) Ratio = hRatio;
				}else if (maxHeight==0){
				if (wRatio<1) Ratio = wRatio;
				}else if (wRatio<1 || hRatio<1){
				Ratio = (wRatio<=hRatio?wRatio:hRatio);
				}
				if (Ratio<1){
				w = w * Ratio;
				h = h * Ratio;
				}
				var co = {
						w:w,
						h:h
				};
				call(co);
				 
			},alt:function(call){
				 var s = "";
				    s += " 网页可见区域宽："+ document.body.clientWidth+"\n";
				    s += " 网页可见区域高："+ document.body.clientHeight+"\n";
				    s += " 网页可见区域宽："+ document.body.offsetWidth + " (包括边线和滚动条的宽)"+"\n";
				    s += " 网页可见区域高："+ document.body.offsetHeight + " (包括边线的宽)"+"\n";
				    s += " 网页正文全文宽："+ document.body.scrollWidth+"\n";
				    s += " 网页正文全文高："+ document.body.scrollHeight+"\n";
				    s += " 网页被卷去的高(ff)："+ document.body.scrollTop+"\n";
				    s += " 网页被卷去的高(ie)："+ document.documentElement.scrollTop+"\n";    
				    s += " 网页被卷去的左："+ document.body.scrollLeft+"\n";
				    s += " 网页正文部分上："+ window.screenTop+"\n";
				    s += " 网页正文部分左："+ window.screenLeft+"\n";      
				    s += " 屏幕分辨率的高："+ window.screen.height+"\n";
				    s += " 屏幕分辨率的宽："+ window.screen.width+"\n";
				    s += " 屏幕可用工作区高度："+ window.screen.availHeight+"\n";
				    s += " 屏幕可用工作区宽度："+ window.screen.availWidth+"\n";
				    s += " 你的屏幕设置是 "+ window.screen.colorDepth +" 位彩色"+"\n";
				    s += " 你的屏幕设置 "+ window.screen.deviceXDPI +" 像素/英寸"+"\n";
				    s += " window的页面可视部分实际高度(ff) "+window.innerHeight+" ";    
				    /*alert (s);*/
				    var data={
				    	width:window.innerWidth ,
				    	height:window.innerHeight
				    }
				    call(data);
			},isPC:function(call){//true pc
	            var userAgentInfo = navigator.userAgent; 
	            var Agents = new Array("Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"); 
	            var flag = true; 
	            for (var v = 0; v < Agents.length; v++) { 
	                if (userAgentInfo.indexOf(Agents[v]) > 0) { flag = false; break; } 
	            } 
	            call(flag);
	        }
	}
	var docm = $(obj).find('img');
	imgutil.FDIMG(docm);
}

var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
	}
)
var stime="";
var etime="";
function getnotice(starttime,endtime){
	stime=starttime+" 00:00:00";
	etime=endtime+" 23:59:59";
	$('#organizename').html(userInfo.organizename);
	
	$.ajax({
		type:'post',
		url:projectpath+'/app/getOrganizeName',
		data:userInfo,
		success:function(data){
			if(data != null && data != undefined){
				$('#qrcode').attr("src",projectpath+data.qrcode);
				$('#qrcode').attr("imgurl",data.qrcode);
			}
		}
	})
	
	//查询统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getMaterialGroupList?organizeid='+userInfo.organizeid+'&starttime='+starttime+'&endtime='+endtime+'&companyid='+userInfo.companyid,
		success:function(data){
			if(data.status==0){
				var nonecolors=['#7e6fe1','#fff299', '#ee5c5c', '#64cccb', '#f7a44b','#6ac868',  '#36adff', '#9484fc','#ffce99', '#ee715c', '#64ccba','#f7bccb','#85e299','#5aace4','#9d6fe1','#e3eb64','#b13b3b','#51a4cf','#b9b866','#95db5c','#1ebfee'];
				$('#starttime').val(data.map.starttime);
				$('#endtime').val(data.map.endtime);
				
				var dataArray = new Array() ;
				var sumprice=0;
				for(var i=0;i<data.typelist.length;i++){
					dataArray[i]=data.typelist[i].name;
					if(data.typelist[i].value != 'NaN'){
						sumprice+=parseFloat(data.typelist[i].value);
					}
				}
				var summaterialprice = data.purchaseMap.summaterialprice;
				var sumpayamount = data.purchaseMap.sumpayamount;
				
				var str="<div style=\"position:absolute;z-index:2;width:85px;padding:8px;height:220px;background-color:white;margin-bottom:-200px;\">";
				for(var i=0;i<data.typelist.length;i++){
					var nonenum=i%nonecolors.length;
					str+="<a onclick=\"materialDetail1('"+data.typelist[i].name+"','"+data.typelist[i].type+"',"+sumprice+");\"><span style=\"width:10px;height:5px;background-color:"+nonecolors[nonenum]+";color:"+nonecolors[nonenum]+";\">___</span>"+data.typelist[i].name+"</a><br/><div style=\"margin-top:5px;\"></div>";
				}
				str+="</div>";
				
				var allprice="";
				if(parseInt(sumprice)!=0){
					var payamountsumprice = sumprice*(sumpayamount/summaterialprice);
					allprice="实际金额\n￥"+payamountsumprice.toFixed(2)+"元";
				}
					option = {
						    legend: {
						        orient : 'vertical',
						        x : 'left',
						        data:dataArray,
						        selectedMode:false
						    },
						    toolbox: {
						        show : true,
						      
						    },
						    calculable : false,
						    series : [
						        { 
						            type:'pie', 
						            radius : [0,0], 
						            itemStyle : {
						                normal : {
						                    label : {
						                        position : 'inner',
						                        show : true, 
						                        textStyle:{
						                            color:'red'
						                        }
						                    },
						                    labelLine : {
						                        show : false
						                    },color:'#FFFFFF'
						                }
						            }, 
						            data:[
						                {
						                  value:335, name:allprice
						                }  
						            ]
						        },
						        {
						            name:'访问来源',
						            type:'pie',
						            radius : [65, 100],
						            selectedMode: 'single',
						            x: '60%',
						            width: '35%',
						            funnelAlign: 'left',
						            max: 1048,
						            
						            data:data.typelist, itemStyle : {
						                normal : {
						                    label : {
						                        position : 'inner',
						                        show : false, 
						                        textStyle:{
						                            color:'red'
						                        }
						                    },
						                    labelLine : {
						                        show : false
						                    }
						                }
						            }
						        }
						    ],
						    color:nonecolors,
						};
					
					var myChart = echarts.init(document.getElementById("echarts_one"));
					myChart.setOption(option);
					myChart.on('click', function (params) {
					    // 控制台打印数据的名称
					    $('#typename').text(params.name);
					    if(params.data.type==1){
					    	$('#tb_12').text(params.name+"单");
					    }else if(params.data.type==2){
					    	$('#tb_12').text(params.name+"单");
					    }else if(params.data.type==3){
					    	$('#tb_12').text(params.name+"单");
					    }else{
					    	$('#tb_12').text("库存采购(入库)单");
					    }
					    materialDetail(params.data.type,sumprice);
					});
					if(data.typelist.length>0){
						$('#typename').text(data.typelist[0].name);
					    if(data.typelist[0].type==1){
					    	$('#tb_12').text(data.typelist[0].name+"单");
					    }else if(data.typelist[0].type==2){
					    	$('#tb_12').text(data.typelist[0].name+"单");
					    }else if(data.typelist[0].type==3){
					    	$('#tb_12').text(data.typelist[0].name+"单");
					    }else{
					    	$('#tb_12').text("库存采购(入库)单");
					    }
						materialDetail(data.typelist[0].type,sumprice);
					}else{
						$('#martailtable').html("<tr class=\"head_td\"><td width=\"50%\">类别</td><td width=\"50%\">金额</td></tr>");
						$('#purchaseul').html("");
					}
					$("#nonespan").html(str);
			}
		}
	})
}
var typenow="";
function materialDetail1(name,type,sumprice){
	
	$('#typename').text(name);
    if(type==1){
    	$('#tb_12').text(name+"单");
    }else if(type==2){
    	$('#tb_12').text(name+"单");
    }else if(type==3){
    	$('#tb_12').text(name+"单");
    }else{
    	$('#tb_12').text("库存采购(入库)单");
    }
    materialDetail(type,sumprice);
}

function materialDetail(type,allsumprice){
	typenow=type;
	//查询统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getStockMaterialDetailByStatistics?organizeid='+userInfo.organizeid+'&type='+type+'&starttime='+stime+'&endtime='+etime,
		success:function(data){
			if(data.status==0){
				var temp="";
				var sumprice=0;
				for(var i=0;i<data.materiallist.length;i++){
					temp+="<tr><td>"+data.materiallist[i].type+"</td><td>￥"+data.materiallist[i].sumprice+"元</td></tr>";
					sumprice+=data.materiallist[i].sumprice;
				}
				$('#martailtable').html("<tr class=\"head_td\"><td width=\"50%\">类别</td><td width=\"50%\">金额</td></tr>");
				$('#martailtable').append(temp);

				$('#sumprice').text("￥"+sumprice.toFixed(2)+"元");
			    if(sumprice==0){
			    	$('#special').text(0);
			    }else{
			    	$('#special').text((sumprice*100/(allsumprice)).toFixed(2));
			    }
			}
		}
	})
	//查询各种单统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getStockOrderByStatistics?organizeid='+userInfo.organizeid+'&type='+type+'&starttime='+stime+'&endtime='+etime,
		success:function(data){
			if(data.status==0){
				var temp="";
				for(var i=0;i<data.orderlist.length;i++){
					if(type==1){
						temp+="<li onclick=\"location.href=\'use_detail1.html?orderid="+data.orderlist[i].orderid+"\'\">";
				    }else if(type==2){
				    	temp+="<li onclick=\"location.href=\'return_detail1.html?orderid="+data.orderlist[i].orderid+"\'\">";
				    }else if(type==3){
				    	temp+="<li onclick=\"location.href=\'reportloss_detail1.html?orderid="+data.orderlist[i].orderid+"\'\">";
				    }else{
				    	temp+="<li onclick=\"location.href=\'../purchase/purchase_detail1.html?orderid="+data.orderlist[i].orderid+"\'\">";
				    }
					temp+="<span>"+data.orderlist[i].orderno+"</span></li>";
				}
				$('#purchaseul').html(temp);
			}
		}
	})
	
	location.href='#s_name';
}

function logical(){
	userInfo.organizeid=$('#organizeid').val();
	userInfo.organizename=$('#organizename').text();
	JianKangCache.setGlobalData("userinfo",userInfo);
	$('#qrcode').attr("src",projectpath+$('#erweima').val());
	getnotice(GetDateStr(-30),GetDateStr(0));
}
$(function(){
	var currYear = (new Date()).getFullYear();	
	var opt={};
	opt.date = {preset : 'date', dateFormat: 'yy-mm-dd' };
	//opt.datetime = { preset : 'datetime', minDate: new Date(2012,3,10,9,22), maxDate: new Date(2014,7,30,15,44), stepMinute: 5  };
	opt.datetime = {preset : 'date', dateFormat: 'yy-mm-dd' }; 
	opt.time = {preset : 'time'};
	opt.default = { 
		theme: 'android-ics light', //皮肤样式  
        display: 'modal', //显示方式  
        mode: 'scroller', //日期选择模式
        dateOrder : 'yymmdd',  
		lang:'zh',
        startYear:currYear - 10, //开始年份
        endYear:currYear + 10 //结束年份
	};
	$('#starttime').scroller('destroy').scroller($.extend(opt['datetime'], opt['default']));
	$('#endtime').scroller('destroy').scroller($.extend(opt['datetime'], opt['default'])); 
})	


function downloadewm(src){
	downLoadQrcode(src,function(data){
		if(data.success){
			swal({
				title :"",
				text : "文件下载成功",
				type : "success",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
			});
		}else{
			swal({
				title : "",
				text : "文件下载失败！",
				type : "error",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
			});
		}
	});
}

function GetDateStr(AddDayCount) { 
	var dd = new Date(); 
	dd.setDate(dd.getDate()+AddDayCount);//获取AddDayCount天后的日期 
	var y = dd.getFullYear(); 
	var m = dd.getMonth()+1;//获取当前月份的日期 
	if(parseInt(m)<10){
		m="0"+m;
	}
	var d = dd.getDate();
	if(parseInt(d)<10){
		d="0"+d;
	}
	return y+"-"+m+"-"+d; 
} 
</script>
<body onload="getnotice(GetDateStr(-30),GetDateStr(0))" style="overflow-x: hidden; overflow-y: auto;">
<div id="htmlbody">
<div class="head_box">
	<a class="ico_back" onclick="location.href='warehouse_index.html'">返回</a>
    <div class="name">库存分析</div>
    <div class="link">帮助</div>
</div>
<div class="head_none"></div>

<div class="chart_box m_top" style="overflow-x: hidden; overflow-y: auto;">
	<input type="hidden" id="organizeid" />
	<div class="s_name s_bor" id="s_name"><span id="organizename"></span><i onclick="$('#htmlbody').hide();$('#organizeiframe').show();">切换门店</i>
	<i style="color:white;border:1px solid white; line-height: 26px; height:26px;" class="erweima" onclick="qrcodeshow(this)"><img alt="二维码" src="" imgurl="" id="qrcode"></i></div>
	
    <div class="top_sel m_bt">
        <div class="time"><input type="text" class="t_time" id="starttime" readonly="readonly" ></div>
	    <div class="span">-</div>
	    <div class="time"><input type="text" class="t_time" id="endtime"  readonly="readonly" ></div>
        <div class="span">&nbsp;</div>
        <div class="btn"><input type="button" value="" onclick="getnotice($('#starttime').val(),$('#endtime').val())"></div>
    </div>
    <span id="nonespan"></span>
    <div class="chart_img" id="echarts_one" style="width: 130%;height: 223px;"></div>
</div>

<div class="tab_box">
<!-- 	<div class="jt_top">箭头</div> -->
    <div class="xx" style="padding-right:0px;">
    	<span class="class" id="typename"></span>
        <span style="width:140px;">金额:<i id="sumprice"></i></span>
        <span style="width:90px;text-align: left;" class="num">占比:<i id="special"></i>%</span>
        <div class="clear"></div>
    </div>
    <div class="tab">
    	<div class="tab_name"><span class="active" id="tb_11" onClick="HoverLi(1,1,2);location.href='#s_name';">类别</span><span id="tb_12" onClick="HoverLi(1,2,2);location.href='#s_name';" ></span></div>
        <div class="dis" id="tbc_11" style="height:200px;overflow:hidden;overflow-y:visible;">
        	<table width="100%" border="0" cellpadding="0" cellspacing="0" id="martailtable">
            	<tr class="head_td">
                	<td width="50%">类别</td>
                    <td>金额</td>
                </tr>
            </table>
        </div>
        <div class="undis" id="tbc_12" style="height:200px;overflow:hidden;overflow-y:visible;">
        	<ul id="purchaseul">
            </ul>
        </div>
    </div>
</div>

</div>
<script type="text/javascript" src="../appcssjs/script/selectshop.js"></script>
</body>
</html>
