<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>采购(入库)单管理主页</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/purchase.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/echarts-all.js"></script>
<script type='text/javascript' src='../appcssjs/script/touchScroll.js'></script>
<script type='text/javascript' src='../appcssjs/script/touchslider.dev.js'></script>
</head>
<script type="text/javascript">
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
	}
)
function linkbuyer(name){
	var buyermap={};
	buyermap['name']=name;
	JianKangCache.setGlobalData('buyermap',buyermap);
	location.href='buyer_list.html';
}

function getnotice(){
	if(typeof(userInfo.powerMap.power1001010) != "undefined"){
		$('#purchasetongji').show();
	}
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getPurchaseNotreadNum?receiveid='+userInfo.userid+'&companyid='+userInfo.companyid,
		success:function(data){
			if(parseInt(data.applynum)> 0){
				$('#applynum').show();
				$('#applynum').html(data.applynum);
			}
			if(parseInt(data.purchasenum)> 0){
				$('#purchasenum').show();
				$('#purchasenum').html(data.purchasenum);
			}
		}
	})
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getBannerList?model=2&type=1',
		success:function(data){
			if(data.length>0){
				var slidertemp="";
				var pagediv="";
				for(var i=0;i<data.length;i++){
					slidertemp+="<li style=\"display: block\"><img src=\""+projectpath+"/"+data[i].imgurl+"\"  alt=\"\" width=\"100%\"></li>";
					pagediv+="<a href=\"javascript:void(0);\">"+data[i].id+"</a>";
				}
				var windowheight=(parseInt($(window).height())*24)/100;
				$('#slider').css("max-height",windowheight+"px");
				$('#slider').html(slidertemp);
				$('#pagenavi').html(pagediv);
				var active=0,
				as=document.getElementById('pagenavi').getElementsByTagName('a');
				
				for(var i=0;i<as.length;i++){
					(function(){
						var j=i;
						as[i].onclick=function(){
							t2.slide(j);
							return false;
						}
					})();
				}
	
				var t1=new TouchScroll({id:'wrapper','width':5,'opacity':0.7,color:'#555',minLength:20});
				var t2=new TouchSlider({id:'slider', speed:600, timeout:6000, before:function(index){
						as[active].className='';
						active=index;
						as[active].className='active';
				}});
			}
		}
	})
	
	$('#organizename').html(userInfo.organizename);
	//查询统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getPurchaseMaterialType?organizeid='+userInfo.organizeid,
		success:function(data){
			if(data.status==0){
				var dataArray = new Array() ;
				var sumprice=0;
				for(var i=0;i<data.typelist.length;i++){
					dataArray[i]=data.typelist[i].name;
					if(data.typelist[i].value != 'NaN'){
					sumprice+=parseFloat(data.typelist[i].value);
					}
				}
				var summaterialprice = data.purchaseMap.summaterialprice;
				var sumpayamount = data.purchaseMap.sumpayamount;
				
				var nonecolors=['#7e6fe1','#fff299', '#ee5c5c', '#64cccb', '#f7a44b','#6ac868',  '#36adff', '#9484fc','#ffce99', '#ee715c', '#64ccba','#f7bccb','#85e299','#5aace4','#9d6fe1','#e3eb64','#b13b3b','#51a4cf','#b9b866','#95db5c','#1ebfee'];
				var str="<div style=\"position:absolute;z-index:2;padding:8px;width:85px;height:auto;background-color:white;margin-bottom:0px;\">";
				for(var i=0;i<data.typelist.length;i++){
					var nonenum=i%nonecolors.length;
					str+="<a onclick=\"$('#typename').text('"+data.typelist[i].name+"');materialDetail('"+data.typelist[i].name+"','"+sumprice+"')\"><span style=\"width:10px;height:5px;background-color:"+nonecolors[nonenum]+";color:"+nonecolors[nonenum]+";\">___</span>"+data.typelist[i].name+"</a><br/><div style=\"margin-top:5px;\"></div>";
				}
				str+="</div>";
				
				var allprice="";
				if(parseInt(sumprice)!=0){
					var payamountsumprice = sumprice*(sumpayamount/summaterialprice);
					allprice="实际金额\n￥"+payamountsumprice.toFixed(2)+"元";
				}
				
				var dataArraylength =  dataArray.length;
				if((dataArraylength*24) > 223){
					$('#echarts_one').css("height",(dataArraylength*24));
				}
				
					option = {
						    legend: {
						        orient : 'vertical',
						        x : 'left',
						        data:dataArray,
						        selectedMode:false
						    },
						    toolbox: {
						        show : true,
						      
						    },
						    calculable : false,
						    series : [
						        { 
						            type:'pie', 
						            radius : [0,0],
						            itemStyle : {
						                normal : {
						                    label : {
						                        position : 'inner',
						                        show : true, 
						                        textStyle:{
						                            color:'red'
						                        }
						                    },
						                    labelLine : {
						                        show : false
						                    },color:'#FFFFFF'
						                }
						            }, 
						            data:[
						                {
						                  value:335, name:allprice
						                }  
						            ]
						        },
						        {
						            name:'访问来源',
						            type:'pie',
						            radius : [65, 100],
						            selectedMode: 'single',
						            x: '60%',
						            width: '35%',
						            funnelAlign: 'left',
						            max: 1048,
						            
						            data:data.typelist, itemStyle : {
						                normal : {
						                    label : {
						                        position : 'inner',
						                        show : false, 
						                        textStyle:{
						                            color:'red'
						                        }
						                    },
						                    labelLine : {
						                        show : false
						                    }
						                }
						            }
						        }
						    ],
						    color:nonecolors,
						};
					
					var myChart = echarts.init(document.getElementById("echarts_one"));
					myChart.setOption(option);
					myChart.on('click', function (params) {
					    // 控制台打印数据的名称
					    console.log(params.name);
					    $('#typename').text(params.name);
					    materialDetail(params.name,sumprice);
					});
					if(data.typelist.length>0){ 
						$('#typename').text(data.typelist[0].name);
						materialDetail(data.typelist[0].name,sumprice);
					}
					else{
						$('#martailtable').html("<tr class=\"head_td\"><td width=\"20%\">名称</td><td width=\"20%\">规格</td><td width=\"20%\">数量</td><td width=\"20%\">单价</td><td>总价</td></tr>");
						$('#purchaseul').html("");
						$('#typename').text("");
					    $('#sumprice').text(0);
					    $('#special').text(0);
					}
					$("#nonespan").html(str);
			}
		}
	})
}
var typenow="";
function materialDetail(type,allsumprice){
	typenow=type;
	//查询统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getPurchaseMaterialDetail?organizeid='+userInfo.organizeid+'&type='+type,
		success:function(data){
			if(data.status==0){
				var temp="";
				var sumprice = 0;
				for(var i=0;i<data.materiallist.length;i++){
					temp+="<tr onclick=\"linkbuyer('"+data.materiallist[i].name+"');\">"+
					"<td>"+data.materiallist[i].name+"</td><td>"+data.materiallist[i].specificationsall+"</td><td>"+data.materiallist[i].realnum+"</td><td>￥"+data.materiallist[i].realprice+"元</td><td>￥"+data.materiallist[i].sumprice+"元</td></tr>";
					sumprice+=(data.materiallist[i].sumprice);
				}
				$('#martailtable').html("<tr class=\"head_td\"><td width=\"20%\">名称</td><td width=\"20%\">规格</td><td width=\"20%\">数量</td><td width=\"20%\">单价</td><td>总价</td></tr>");
				$('#martailtable').append(temp);
				
				$('#sumprice').text("￥"+sumprice.toFixed(2)+"元");
				if(sumprice==0){
			    	$('#special').text(0);
			    }else{
			    	$('#special').text((sumprice*100/(allsumprice)).toFixed(2));
			    }
			}
		}
	})
	//查询采购(入库)单统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getPurchaseStatisticsList?organizeid='+userInfo.organizeid+'&type='+type,
		success:function(data){
			if(data.status==0){
				var temp="";
				for(var i=0;i<data.purchaselist.length;i++){
					temp+="<li onclick=\"location.href=\'purchase_detail1.html?orderid="+data.purchaselist[i].orderid+"\'\"><span>"+data.purchaselist[i].orderno+"</span></li>";
				}
				$('#purchaseul').html(temp);
			}
		}
	})
	
	location.href='#s_name';
}

function logical(){
	userInfo.organizeid=$('#organizeid').val();
	userInfo.organizename=$('#organizename').text();
	JianKangCache.setGlobalData("userinfo",userInfo);
	getnotice();
}
/* PageHelper({
	url:projectpath+'/app/getPurchaseMaterialDetail?organizeid='+userInfo.organizeid+'&type='+typenow,
	success:function(data){
		var temp="";
		for(var i=0;i<data.materiallist.length;i++){
			temp+="<tr><td>"+data.materiallist[i].name+"</td><td>"+data.materiallist[i].specifications+"</td><td>"+data.materiallist[i].num+"</td><td>￥"+data.materiallist[i].price+"</td></tr>";
		}
		$('#martailtable').append(temp);
	}
});
PageHelper({
	url:projectpath+'/app/getPurchaseStatisticsList?organizeid='+userInfo.organizeid+'&type='+typenow,
	success:function(data){
		var temp="";
		for(var i=0;i<data.purchaselist.length;i++){
			temp+="<li><span>"+data.purchaselist[i].orderno+"</span></li>";
		}
		$('#purchaseul').append(temp);
	}
}); */
</script>
<body onload="getnotice()" >
<div id="htmlbody">
<div class="head_box">
	<a class="ico_back" onclick="location.href='../login/index.html'">返回</a>
    <div class="name">采购管理</div>
    <div class="link">帮助</div>
</div>
<div class="head_none"></div>
<div class="contentWrap" style="min-height:125px;">
    <ul id="slider">
<!--     	<li style="display:block"><img src="../appcssjs/images/purchase/banner.png"  alt="" width="100%"></li> -->
    </ul>
    <div id="pagenavi">
<!--     	<a href="javascript:void(0);" class="active">1</a> -->
    </div>
</div>

<div class="index_menu">
	<ul>
    	<li><b class="bg1" onclick="location.href='apply_list0.html'"><img src="../appcssjs/images/purchase/menu_01.png"><i id="applynum" style="display: none" ></i></b><span>申购单</span></li>
        <li><b class="bg2" onclick="location.href='purchase_list0.html'"><img src="../appcssjs/images/purchase/menu_02.png"><i id="purchasenum" style="display: none" ></i></b><span>采购(入库)单</span></li>
        <li onclick="location.href='../supplier/supplier_list.html'"><b class="bg3"><img src="../appcssjs/images/purchase/menu_03.png"></b><span>供应商</span></li>
        <li onclick="linkmonthly()"><b class="bg4"><img src="../appcssjs/images/purchase/menu_04.png"></b><span>采购月报表</span></li>
    </ul>
    <div class="clear"></div>
</div>
<script type="text/javascript">
function linkmonthly(){
	if(typeof(userInfo.powerMap.power1001010) == "undefined"){
		//查询提示框
		$.ajax({
			type:"post",
			dataType:"json",
			url:projectpath+"/app/getPromptInfo",
			data:"datacode=personnopower",
			success:function(data){
				swal({
					title : "",
					text :  data.datamap.remark,
					type : "warning",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					
				});
			}
		})
	}else{
		location.href='monthly_report.html';
	}
}
</script>
<div id="purchasetongji" style="display: none">
<div class="chart_box"  style="overflow-x: hidden; overflow-y: auto;">
	<input type="hidden" id="organizeid" />
	<div class="s_name" id="s_name"><span id="organizename"></span><i onclick="$('#htmlbody').hide();$('#organizeiframe').show();">切换门店</i></div>
	<div class="chart_name" style="text-align:center;">近七天采购统计</div>
	<span id="nonespan"></span> 
    <div class="chart_img" id="echarts_one" style="width: 130%;height: 223px;"></div>
</div>

<div class="tab_box">
	<div class="xx" style="padding:0px 7px;">
    	<span class="class" id="typename"></span>
        <span style="width:140px;">金额:<i id="sumprice"></i></span>
        <span style="width:90px;" class="num">占比:<i id="special"></i>%</span>
        <div class="clear"></div>
    </div>
    <div class="tab">
    	<div class="tab_name"><span class="active" id="tb_11" onClick="HoverLi(1,1,2);location.href='#s_name';">明细</span><span id="tb_12" onClick="HoverLi(1,2,2);location.href='#s_name';">采购(入库)单</span></div>
        <div class="dis" id="tbc_11" style="height:200px;overflow:hidden;overflow-y:visible;">
        	<table width="100%" border="0" cellpadding="0" cellspacing="0" id="martailtable">
            	<tr class="head_td">
                	<td width="20%">名称</td>
                    <td width="20%">规格</td>
                    <td width="20%">数量</td>
                    <td width="20%">单价</td>
                    <td>总价</td>
                </tr>
            </table>
        </div>
        <div class="undis" id="tbc_12" style="height:200px;overflow:hidden;overflow-y:visible;">
        	<ul id="purchaseul">
            </ul>
        </div>
    </div>
</div>
</div>

</div>
<script type="text/javascript" src="../appcssjs/script/selectshop.js"></script>
</body>
</html>
