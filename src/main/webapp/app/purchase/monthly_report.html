<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>采购月报表</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/purchase.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/echarts-all.js"></script>
<link href="../appcssjs/style/mobiscroll.custom-2.6.2.min.css" type="text/css" rel="stylesheet"> 
<script src="../appcssjs/script/mobiscroll.custom-2.6.2.min.js"></script> 
</head>
<script type="text/javascript">
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
	}
)
function linkbuyer(name){
	var buyermap={};
	buyermap['name']=name;
	JianKangCache.setGlobalData('buyermap',buyermap);
	location.href='buyer_list.html';
}

var stime="";
var etime="";
function getnotice(starttime,endtime){
	stime=starttime+" 00:00:00";
	etime=endtime+" 23:59:59";
	$('#organizename').html(userInfo.organizename);
	//查询统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getPurchaseMaterialType?organizeid='+userInfo.organizeid+'&starttime='+starttime+'&endtime='+endtime+'&companyid='+userInfo.companyid,
		success:function(data){
			if(data.status==0){
				$('#starttime').val(data.map.starttime);
				$('#endtime').val(data.map.endtime);
				
				var dataArray = new Array() ;
				var sumprice=0;
				for(var i=0;i<data.typelist.length;i++){
					dataArray[i]=data.typelist[i].name;
					if(data.typelist[i].value != 'NaN'){
					sumprice+=parseFloat(data.typelist[i].value);
					}
				}
				var summaterialprice = data.purchaseMap.summaterialprice;
				var sumpayamount = data.purchaseMap.sumpayamount;
				
				var nonecolors=['#7e6fe1','#fff299', '#ee5c5c', '#64cccb', '#f7a44b','#6ac868',  '#36adff', '#9484fc','#ffce99', '#ee715c', '#64ccba','#f7bccb','#85e299','#5aace4','#9d6fe1','#e3eb64','#b13b3b','#51a4cf','#b9b866','#95db5c','#1ebfee'];
				var str="<div style=\"position:absolute;z-index:2;padding:8px;width:85px;height:auto;background-color:white;margin-bottom:-0px;\">";
				for(var i=0;i<data.typelist.length;i++){
					var nonenum=i%nonecolors.length;
					str+="<a onclick=\"$('#typename').text('"+data.typelist[i].name+"');materialDetail('"+data.typelist[i].name+"',"+sumprice+")\"><span style=\"width:10px;height:5px;background-color:"+nonecolors[nonenum]+";color:"+nonecolors[nonenum]+";\">___</span>"+data.typelist[i].name+"</a><br/><div style=\"margin-top:5px;\"></div>";
				}
				str+="</div>";
				
				var allprice="";
				if(parseInt(sumprice)!=0){
					var payamountsumprice = sumprice*(sumpayamount/summaterialprice);
					allprice="实际金额\n￥"+payamountsumprice.toFixed(2)+"元";
				}
				
				var dataArraylength =  dataArray.length;
				if((dataArraylength*24) > 223){
					$('#echarts_one').css("height",(dataArraylength*24));
				}
					option = {
						    legend: {
						        orient : 'vertical',
						        x : 'left',
						        data:dataArray,
						        selectedMode:false
						    },
						    toolbox: {
						        show : true
						      
						    },
						    radiusAxis:{
						    	boundaryGap: ['80%', '80%']
						    },
						    calculable : false,
						    series : [
						        { 
						            type:'pie', 
						            radius : [0,0], 
						            itemStyle : {
						                normal : {
						                    label : {
						                        position : 'inner',
						                        show : true, 
						                        textStyle:{
						                            color:'red'
						                        }
						                    },
						                    labelLine : {
						                        show : false
						                    },color:'#FFFFFF'
						                }
						            }, 
						            data:[
						                {
						                  value:335, name:allprice
						                }  
						            ]
						        },
						        {
						            name:'访问来源',
						            type:'pie',
						            radius : [65, 100],
						            selectedMode: 'single',
						            x: '60%',
						            width: '35%',
						            funnelAlign: 'left',
						            max: 1048,
						            
						            data:data.typelist, itemStyle : {
						                normal : {
						                    label : {
						                        position : 'inner',
						                        show : false, 
						                        textStyle:{
						                            color:'red'
						                        }
						                    },
						                    labelLine : {
						                        show : false
						                    }
						                }
						            }
						        }
						    ],
						    color:nonecolors,
						};
					
					var myChart = echarts.init(document.getElementById("echarts_one"));
					myChart.setOption(option);
					myChart.on('click', function (params) {
					    // 控制台打印数据的名称
					    console.log(params.name);
					    $('#typename').text(params.name);
					    materialDetail(params.name,sumprice);
					});
					if(data.typelist.length>0){
						$('#typename').text(data.typelist[0].name);
						materialDetail(data.typelist[0].name,sumprice);
					}else{
						$('#martailtable').html("<tr class=\"head_td\"><td width=\"20%\">名称</td><td width=\"20%\">规格</td><td width=\"20%\">数量</td><td width=\"20%\">单价</td><td>总价</td></tr>");
						$('#purchaseul').html("");
						$('#typename').text("");
					    $('#sumprice').text(0);
					    $('#special').text(0);
					}
					$("#nonespan").html(str);
			}
		}
	})
}
var typenow="";
function materialDetail(type,allsumprice){
	typenow=type;
	//查询统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getPurchaseMaterialDetail?organizeid='+userInfo.organizeid+'&type='+type+'&starttime='+stime+'&endtime='+etime,
		success:function(data){
			if(data.status==0){
				var temp="";
				var sumprice = 0;
				for(var i=0;i<data.materiallist.length;i++){
					temp+="<tr onclick=\"linkbuyer('"+data.materiallist[i].name+"');\">"+
					"<td>"+data.materiallist[i].name+"</td><td>"+data.materiallist[i].specificationsall+"</td><td>"+data.materiallist[i].realnum+"</td><td>￥"+data.materiallist[i].realprice+"元</td><td>￥"+data.materiallist[i].sumprice+"元</td></tr>";
					sumprice+=(data.materiallist[i].sumprice);
				}
				$('#martailtable').html("<tr class=\"head_td\"><td width=\"20%\">名称</td><td width=\"20%\">规格</td><td width=\"20%\">数量</td><td width=\"20%\">单价</td><td>总价</td></tr>");
				$('#martailtable').append(temp);
				
				$('#sumprice').text("￥"+sumprice.toFixed(2)+"元");
				if(sumprice==0){
			    	$('#special').text(0);
			    }else{
			    	$('#special').text((sumprice*100/(allsumprice)).toFixed(2));
			    }
			}
		}
	})
	//查询采购(入库)单统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getPurchaseStatisticsList?organizeid='+userInfo.organizeid+'&type='+type+'&starttime='+stime+'&endtime='+etime,
		success:function(data){
			if(data.status==0){
				var temp="";
				for(var i=0;i<data.purchaselist.length;i++){
					temp+="<li onclick=\"location.href=\'purchase_detail1.html?orderid="+data.purchaselist[i].orderid+"\'\"><span>"+data.purchaselist[i].orderno+"</span></li>";
				}
				$('#purchaseul').html(temp);
			}
		}
	})
	
	location.href='#s_name';
}
/* 
PageHelper({
	url:projectpath+'/app/getPurchaseMaterialDetail?organizeid='+userInfo.organizeid+'&type='+typenow,
	success:function(data){
		var temp="";
		for(var i=0;i<data.materiallist.length;i++){
			temp+="<tr><td>"+data.materiallist[i].name+"</td><td>"+data.materiallist[i].specifications+"</td><td>"+data.materiallist[i].num+"</td><td>￥"+data.materiallist[i].price+"</td></tr>";
		}
		$('#martailtable').append(temp);
	}
});
PageHelper({
	url:projectpath+'/app/getPurchaseStatisticsList?organizeid='+userInfo.organizeid+'&type='+typenow,
	success:function(data){
		var temp="";
		for(var i=0;i<data.purchaselist.length;i++){
			temp+="<li><span>"+data.purchaselist[i].orderno+"</span></li>";
		}
		$('#purchaseul').append(temp);
	}
}); */


function logical(){
	userInfo.organizeid=$('#organizeid').val();
	userInfo.organizename=$('#organizename').text();
	JianKangCache.setGlobalData("userinfo",userInfo);
	getnotice(GetDateStr(-30),GetDateStr(0));
}
$(function(){
	var currYear = (new Date()).getFullYear();	
	var opt={};
	opt.date = {preset : 'date', dateFormat: 'yy-mm-dd' };
	//opt.datetime = { preset : 'datetime', minDate: new Date(2012,3,10,9,22), maxDate: new Date(2014,7,30,15,44), stepMinute: 5  };
	opt.datetime = {preset : 'date', dateFormat: 'yy-mm-dd' }; 
	opt.time = {preset : 'time'};
	opt.default = { 
		theme: 'android-ics light', //皮肤样式  
        display: 'modal', //显示方式  
        mode: 'scroller', //日期选择模式
        dateOrder : 'yymmdd',  
		lang:'zh',
        startYear:currYear - 10, //开始年份
        endYear:currYear + 10 //结束年份
	};
	$('#starttime').scroller('destroy').scroller($.extend(opt['datetime'], opt['default']));
	$('#endtime').scroller('destroy').scroller($.extend(opt['datetime'], opt['default'])); 
})

function GetDateStr(AddDayCount) { 
	var dd = new Date(); 
	dd.setDate(dd.getDate()+AddDayCount);//获取AddDayCount天后的日期 
	var y = dd.getFullYear(); 
	var m = dd.getMonth()+1;//获取当前月份的日期 
	if(parseInt(m)<10){
		m="0"+m;
	}
	var d = dd.getDate();
	if(parseInt(d)<10){
		d="0"+d;
	}
	return y+"-"+m+"-"+d; 
} 
</script>

<body onload="getnotice(GetDateStr(-30),GetDateStr(0))" style="overflow-x: hidden; overflow-y: auto;">
<div id="htmlbody">
<div class="head_box">
	<a class="ico_back" onclick="goBackPage();">返回</a>
    <div class="name">采购月报表</div>
</div>
<div class="head_none"></div>
<div class="top_sel m_bt">
	<div class="time"><input type="text" class="t_time" id="starttime" readonly="readonly" ></div>
    <div class="span">-</div>
    <div class="time"><input type="text" class="t_time" id="endtime"  readonly="readonly" ></div>
    <div class="span">&nbsp;</div>
    <div class="btn"><input type="button" value="" onclick="getnotice($('#starttime').val(),$('#endtime').val())"></div>
</div>
<div class="chart_box" style="overflow-x: hidden; overflow-y: auto;">
	<input type="hidden" id="organizeid" />
	<div class="s_name" id="s_name"><span id="organizename"></span><i onclick="$('#htmlbody').hide();$('#organizeiframe').show();">切换门店</i></div>
	<span id="nonespan"></span>
    <div class="chart_img" id="echarts_one" style="width: 130%;height: 223px;"></div>
</div>
<div class="tab_box">
<!-- 	<div class="jt_top">箭头</div>
    <div class="xx">
    	<span class="class">肉类</span>
        <span>金额:<i>￥10000.00</i>元</span>
        <span class="num">占比:<i>33.04</i>%</span>
        <div class="clear"></div>
    </div> -->
    <div class="xx" style="padding:0px 7px;">
    	<span class="class" id="typename"></span>
        <span style="width:140px;">金额:<i id="sumprice"></i></span>
        <span style="width:90px;" class="num">占比:<i id="special"></i>%</span>
        <div class="clear"></div>
    </div>
    <div class="tab">
    	<div class="tab_name"><span class="active" id="tb_11" onClick="HoverLi(1,1,2);location.href='#s_name';">明细</span><span id="tb_12" onClick="HoverLi(1,2,2);location.href='#s_name';">采购(入库)单</span></div>
        <div class="dis" id="tbc_11" style="height:200px;overflow:hidden;overflow-y:visible;">
        	<table width="100%" border="0" cellpadding="0" cellspacing="0" id="martailtable">
            	<tr class="head_td">
                	<td width="20%">名称</td>
                    <td width="20%">规格</td>
                    <td width="20%">数量</td>
                    <td width="20%">单价</td>
                    <td>总价</td>
                </tr>
            </table>
        </div>
        <div class="undis" id="tbc_12" style="height:200px;overflow:hidden;overflow-y:visible;">
        	<ul id="purchaseul">
            </ul>
        </div>
    </div>
</div>

</div>
<script type="text/javascript" src="../appcssjs/script/selectshop.js"></script>

</body>
</html>
