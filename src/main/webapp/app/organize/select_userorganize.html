<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>组织架构</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/structure.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>

</head>
<script type="text/javascript">
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
})
function onloadData(){
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getNextOrgainize?companyid='+userInfo.companyid,
		success:function(data){
			if(data.organizelist.length > 0){
				$('#organizetext').text(data.organizelist[0].organizename);
				$('#organizetext').nextAll().remove();
				getorganizelist(0,data.organizelist[0].organizeid,data.organizelist[0].organizename,'#organizetext');
			}
			
		}
	})
}
function getorganizelist(num,organizeid,organizename,obj){
	if(obj !='#organizetext' &&  $(obj).parent().next("ul").length>0){
		if($(obj).parent().find("em").attr("class")=="em_down"){
			$(obj).parent().next("ul").show();
			$(obj).parent().find("em").attr("class","em_up");
			$(obj).parent().find("em").text("隐藏");
		}else{
			$(obj).parent().next("ul").hide();
			$(obj).parent().find("em").attr("class","em_down");
			$(obj).parent().find("em").text("显示");
		}
		return;
	}
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getNextOrgainize?companyid='+userInfo.companyid+'&organizeid='+organizeid,
		success:function(data){
			if(data.organizelist.length > 0 || data.userlist.length >0){
				var temp="";
				temp+="<ul class=\"quyu\">";
				temp+="<li class=\"leve_a\" >";
				for(var i=0;i<data.organizelist.length ;i++){
					temp+="<span class=\"leve_a_s\" style=\"padding:0px 15px 0px "+(num*30+15)+"px;background-position:"+(num*30+15)+"px 50%;\"><a class=\"check\" onclick=\"chooseorganize('"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"',this)\" name=\"choose\">选择</a><i  onclick=\"getorganizelist("+(num+1)+",'"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"',this)\" >"+data.organizelist[i].organizename+"</i><em class=\"em_down\"  onclick=\"getorganizelist("+(num+1)+",'"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"',this)\" >显示</em><div class=\"clear\"></div></span>";
				}
				if(data.userlist.length > 0){
					for(var j=0;j<data.userlist.length ;j++){
						temp+="<span class=\"leve_a_s\" style=\"padding:0px 15px 0px "+(num*30+15)+"px;background-position:"+(num*30+15)+"px 50%;\"><a class=\"check\"  onclick=\"chooseuser('"+data.userlist[j].userid+"','"+data.userlist[j].realname+"',this)\" name=\"choose\">选择</a><i>"+data.userlist[j].realname+"</i><em class=\"em_down\">显示</em><div class=\"clear\"></div></span>";
					}
				}
        		temp+="</li></ul>";
        		if(obj =='#organizetext'){
					$(obj).after(temp);
        		}else{
        			$(obj).parent().after(temp);
        		}
				$(obj).parent().find("em").attr("class","em_up");
				$(obj).parent().find("em").text("隐藏");
			}
		}
	})
}
function chooseorganize(organizeid,organizename,obj){
	if($(obj).attr("class")=="check"){
		var organizeli="<li><input type=\"hidden\" name=\"organizeid\" value=\""+organizeid+"\"/><span>"+organizename+"</span><i onclick=\"deletechoose(this)\">×</i></li>";
		$('#chooseul').append(organizeli);
		$(obj).attr("class","check_ed");
		
		if($(obj).parent().next("ul").length > 0){
			$.each($(obj).parent().next("ul").find("a[name=choose]"), function(i,val){
				if($(this).attr("class")=="check"){
					$(this).click();
				}
			});
		}
	}else{
		if($(obj).parents("ul").prev().length > 0){
			$.each($(obj).parents("ul").prev().find("a[name=choose]"), function(i,val){
				if($(this).attr("class")=="check_ed"){
					$(this).click();
				}
			});
		}
		$('#chooseul').find("input[value="+organizeid+"]").parent().remove();
		$(obj).attr("class","check");
	}
	
	if($('#chooseul').children("li").length>0){
		$('#confirmbtn').show();
	}else{
		$('#confirmbtn').hide();
	}
	event.stopPropagation();
}
function chooseuser(userid,realname,obj){
	if($(obj).attr("class")=="check"){
		var userli="<li><input type=\"hidden\" name=\"userid\" value=\""+userid+"\"/><span>"+realname+"</span><i onclick=\"deletechoose(this)\">×</i></li>";
		$('#chooseul').append(userli);
		$(obj).attr("class","check_ed");
		
		if($(obj).parent().next("ul").length > 0){
			$.each($(obj).parent().next("ul").find("a[name=choose]"), function(i,val){
				if($(this).attr("class")=="check"){
					$(this).click();
				}
			});
		}
	}else{
		if($(obj).parents("ul").prev().length > 0){
			$.each($(obj).parents("ul").prev().find("a[name=choose]"), function(i,val){
				if($(this).attr("class")=="check_ed"){
					$(this).click();
				}
			});
		}
		$('#chooseul').find("input[value="+userid+"]").parent().remove();
		$(obj).attr("class","check");
	}
	if($('#chooseul').children("li").length>0){
		$('#confirmbtn').show();
	}else{
		$('#confirmbtn').hide();
	}
	event.stopPropagation();
}
function deletechoose(obj){
	$("i:contains('"+$(obj).prev().text()+"')").prev().click();
	$(obj).parent().remove();
}
function confirmexanine(){
	var alldata={"userlist":[]};  
	$('input[name=userid]').each(function(index){
		var userlist={};
		userlist['userid']=$(this).val();
		alldata.userlist.push(userlist); 
	})
	$('input[name=organizeid]').each(function(index){
		var organizelist={};
		organizelist['organizeid']=$(this).val();
		alldata.userlist.push(organizelist); 
	})
	$('#userlist').val(alldata);
}

function searchinfo(obj){
	var searchname =$(obj).val();
	if(searchname.trim()!=""){
		$.ajax({
			type:'post',
			dataType:'json',
			url:projectpath+'/app/getOrganizeUserBySearch?companyid='+userInfo.companyid+'&searchname='+searchname,
			success:function(data){
				if(data.organizelist.length > 0 || data.userlist.length >0){
					var temp="";
					temp+="<ul class=\"quyu\">";
					temp+="<li class=\"leve_a\" >";
					for(var i=0;i<data.organizelist.length ;i++){
						temp+="<span class=\"leve_a_s\" style=\"padding:0px 15px 0px 15px;background-position:15px 50%;\"><a class=\"check\" onclick=\"chooseorganize('"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"',this)\" name=\"choose\">选择</a><i  onclick=\"getorganizelist(1,'"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"',this)\" >"+data.organizelist[i].organizename+"</i><em class=\"em_down\"  onclick=\"getorganizelist(1,'"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"',this)\" >显示</em><div class=\"clear\"></div></span>";
					}
					if(data.userlist.length > 0){
						for(var j=0;j<data.userlist.length ;j++){
							temp+="<span class=\"leve_a_s\" style=\"padding:0px 15px 0px 15px;background-position:15px 50%;\"><a class=\"check\"  onclick=\"chooseuser('"+data.userlist[j].userid+"','"+data.userlist[j].realname+"',this)\" name=\"choose\">选择</a><i>"+data.userlist[j].realname+"</i><em class=\"em_down\">显示</em><div class=\"clear\"></div></span>";
						}
					}
	        		temp+="</li></ul>";
	        		$('#organizetext').nextAll().remove();
					$('#organizetext').after(temp);
				}
				else{
					$('#organizetext').nextAll().remove();
				}
			}
		})
	}
}
</script>
<body onload="onloadData()">
<div class="head_box">
	<input type="hidden" id="userlist"/>
	<a class="ico_back" onclick="$('#organizeiframe').hide();$('#htmlbody').show();">返回</a>
    <div class="name">组织架构</div>
    <div class="link_yellow" id="confirmbtn" style="display: none;" onclick="confirmexanine()">确认</div>
</div>
<div class="head_none"></div>
<div class="stru_list">
	<div class="search_box"><input type="text" class="bg" placeholder="搜索" oninput="searchinfo(this)"></div>
    <div class="search_list" id="orgainizediv">
    	<ul id="chooseul">
        </ul>
        <div class="clear"></div>
    </div>
    <div class="title" id="organizetext" onclick="onloadData()"></div>
</div>
</body>
</html>
