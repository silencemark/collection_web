<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>主页</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/restaurant.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/echarts-all.js"></script>

<link href="../appcssjs/style/mobiscroll.custom-2.6.2.min.css" type="text/css" rel="stylesheet"> 
<script src="../appcssjs/script/report_mobiscroll.custom-2.6.2.min.js"></script>
</head>
<script type="text/javascript">
$(document).ready(function () {
    /*
    * 智能机浏览器版本信息:
    *
    */
    var browser = {
        versions: function () {
            var u = navigator.userAgent, app = navigator.appVersion;
            return {//<a href="http://www.suchso.com/productdesign/sharemobileappproductdesign.html" class="keylink" title=" 移动" target="_blank">移动</a>终端浏览器版本信息 
                trident: u.indexOf('Trident') > -1, //IE内核
                presto: u.indexOf('Presto') > -1, //opera内核
                webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
                gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
                mobile: !!u.match(/AppleWebKit.*Mobile.*/) || !!u.match(/AppleWebKit/), //是否为移动终端
                ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
                iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者QQHD浏览器
                iPad: u.indexOf('iPad') > -1, //是否iPad
                webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
            }; 
        }(), 
        language: (navigator.browserLanguage || navigator.language).toLowerCase() 
    }        
    //document.writeln("语言版本: "+browser.language);
    //document.writeln(" 是否为移动终端: "+browser.versions.mobile);
    //document.writeln(" ios终端: "+browser.versions.ios);
    //document.writeln(" android终端: "+browser.versions.android);
    //document.writeln(" 是否为iPhone: "+browser.versions.iPhone);
    //document.writeln(" 是否iPad: "+browser.versions.iPad);
    //document.writeln(navigator.userAgent);
    var pagewidth = $(window).width();
    var pageheight = $(window).height();
    if (browser.versions.mobile) {
        window.addEventListener("onorientationchange" in window ? "orientationchange" : "resize", hengshuping, false);
        $("#report_box").height(pageheight*0.6);
        $("#report_box").width(pagewidth * 0.95);
    }
    else {
        $("#report_box").height("500px");
        $("#report_box").width("700px");
    }
});
                
function hengshuping(){
    if(window.orientation==180||window.orientation==0){
        $("#report_box").height($(window).height()-20);
        $("#report_box").width("100%");
    }
    if(window.orientation==90||window.orientation==-90){
        $("#report_box").height($(window).height()-20);
        $("#report_box").width("100%");  
    }
}
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
	}
)

function getdata(){
	
	//查询统计数据
	$.ajax({
		type:'post',
		dataType:'json',
		data:"statisticsTime="+$("#statisticsTime").val(),
		url:projectpath+'/app/getReportSatisfyChart?organizeid='+userInfo.organizeid,
		success:function(data){
			if(data.status==0){
				/* if(data.monthlist.length>=15){
					$("#echarts_one").css({"width":"600px"});	
				} */
				var timedataArray = new Array() ;
				var onedataArray = new Array() ;
				var twodataArray = new Array() ;
				var threedataArray = new Array() ;
				var fourdataArray = new Array() ;
				var fivedataArray = new Array() ;
				
				var sumonedata = 0;
				var sumtwodata = 0;
				var sumthreedata = 0;
				var sumfourdata = 0;
				var sumfivedata = 0;
				
				var nextcount1=999;
				for(var i=data.monthlist.length-1;i>0;i--){
					if(data.monthlist[i].tastescore==0){
						nextcount1=i;
					}else{
						break;
					}
				}
				var firstcount1=-1;
				for(var i=0;i<data.monthlist.length;i++){
					if(data.monthlist[i].tastescore==0){
						firstcount1=i;
					}else{
						break;
					}
				}
				
				for(var i=0;i<data.monthlist.length;i++){
					timedataArray[i]=data.monthlist[i].comparetime;
					if(firstcount1<i && i<nextcount1){
						onedataArray[i]=data.monthlist[i].tastescore;
						sumonedata += parseInt(data.monthlist[i].tastescore);
					}
					//onedataArray[i]=data.monthlist[i].tastescore;
				}
				
				var nextcount2=999;
				for(var i=data.monthlist.length-1;i>0;i--){
					if(data.monthlist[i].environmentscore==0){
						nextcount2=i;
					}else{
						break;
					}
				}
				var firstcount2=-1;
				for(var i=0;i<data.monthlist.length;i++){
					if(data.monthlist[i].environmentscore==0){
						firstcount2=i;
					}else{
						break;
					}
				}
				
				for(var i=0;i<data.monthlist.length;i++){
					if(firstcount2<i && i<nextcount2){
						twodataArray[i]=data.monthlist[i].environmentscore;
						sumtwodata += parseInt(data.monthlist[i].environmentscore);
					}
					//twodataArray[i]=data.monthlist[i].environmentscore;
				}
				
				var nextcount3=999;
				for(var i=data.monthlist.length-1;i>0;i--){
					if(data.monthlist[i].servicescore==0){
						nextcount3=i;
					}else{
						break;
					}
				}
				var firstcount3=-1;
				for(var i=0;i<data.monthlist.length;i++){
					if(data.monthlist[i].servicescore==0){
						firstcount3=i;
					}else{
						break;
					}
				}
				
				for(var i=0;i<data.monthlist.length;i++){
					if(firstcount3<i && i<nextcount3){
						threedataArray[i]=data.monthlist[i].servicescore;
						sumthreedata += parseInt(data.monthlist[i].servicescore);
					}
					//threedataArray[i]=data.monthlist[i].servicescore;
				}
				
				var nextcount4=999;
				for(var i=data.monthlist.length-1;i>0;i--){
					if(data.monthlist[i].pricescore==0){
						nextcount4=i;
					}else{
						break;
					}
				}
				var firstcount4=-1;
				for(var i=0;i<data.monthlist.length;i++){
					if(data.monthlist[i].pricescore==0){
						firstcount4=i;
					}else{
						break;
					}
				}
				
				for(var i=0;i<data.monthlist.length;i++){
					if(firstcount4<i && i<nextcount4){
						fourdataArray[i]=data.monthlist[i].pricescore;
						sumfourdata += parseInt(data.monthlist[i].pricescore);
					}
					//fourdataArray[i]=data.monthlist[i].pricescore;
				}
				
				var nextcount5=999;
				for(var i=data.monthlist.length-1;i>0;i--){
					if(data.monthlist[i].averagescore==0){
						nextcount5=i;
					}else{
						break;
					}
				}
				var firstcount5=-1;
				for(var i=0;i<data.monthlist.length;i++){
					if(data.monthlist[i].averagescore==0){
						firstcount5=i;
					}else{
						break;
					}
				}
				
				for(var i=0;i<data.monthlist.length;i++){
					if(firstcount5<i && i<nextcount5){
						fivedataArray[i]=data.monthlist[i].averagescore;
						sumfivedata += parseInt(data.monthlist[i].averagescore);
					}
					//fivedataArray[i]=data.monthlist[i].averagescore;
				}
				
				var reportnum = data.reportnum;
				sumonedata = (sumonedata/reportnum).toFixed(1);
				sumtwodata = (sumtwodata/reportnum).toFixed(1);
				sumthreedata = (sumthreedata/reportnum).toFixed(1);
				sumfourdata = (sumfourdata/reportnum).toFixed(1);
				sumfivedata = (sumfivedata/reportnum).toFixed(1);
				
// 				if((fivedataArray.length!=0 || fourdataArray.length!=0 || threedataArray!=0 || twodataArray!=0 && onedataArray!=0) && data.monthlist.length>=15){
// 					$("#echarts_one").css({"width":"600px"});	
// 				}
				option = {
					    title: {
					    	
					    },
					    tooltip: {
					        trigger: 'axis',
					        axisPointer: {
					            type: 'none'
					        },
					        formatter: function(params,ticket,callback){
// 					        	console.log(JSON.stringify(params));
					            var res = '';  
					            var date = '';
					            for (var i = 0; i < params.length; i++) {  
					                 date = params[i][1]+"号<br/>";
					                 var firstnum = date.substring(0,1);
					                 if(firstnum == 0){
					                	 date = date.substring(1,date.length);
					                 }
					                 var htm = params[i][0];
					                 htm = htm.substring(0,htm.indexOf("："));
					                 var money = (params[i][2]+"").replace("-",0);
					                 res += htm+"："+money+"分<br/>";
					            }; 
					            return date+res;  
					        }
					    },
					    legend: {
					        data:["综合："+sumfivedata+"分","口味："+sumonedata+"分","环境："+sumtwodata+"分","服务："+sumthreedata+"分","价格："+sumfourdata+"分"],
					    },
					    toolbox: {
					        show: false,
					        feature: {
					            dataZoom: {
					                yAxisIndex: 'none'
					            }
					        }
					    },
					   	grid: {
					        x:20,y:80,
					        y2:40,x2:5
					    },
					    xAxis: {
					        type: 'category',
					        boundaryGap: false,
					        data: timedataArray,
					        splitLine: {
					            show: false
					        },
					        axisLabel: {
					        	interval: 0,
// 					            rotate:40,
					            margin:10,
					            formatter:function(val){
					            	if(data.monthlist.length <= 15){
					            		return val.split("01").join("1").split("03").join("3").split("05").join("5").split("07").join("7").split("09").join("9").split("02").join("2").split("04").join("4").split("06").join("6").split("08").join("8");
					            	}else{
					            		return val.split("01").join("1").split("03").join("3").split("05").join("5").split("07").join("7").split("09").join("9").split("02").join("").split("04").join("").split("06").join("").split("08").join("").split("10").join("").split("12").join("").split("14").join("").split("16").join("").split("18").join("").split("20").join("").split("22").join("").split("24").join("").split("26").join("").split("28").join("").split("30").join("");
					            	}
			                    }
					        },
					        axisLine:{
		             			lineStyle:{
		             				color:'#333',
		             				width:1,
		             			}
		             		}
					    },
					    yAxis: {
					        type: 'value',
					        splitLine: {
					            show: false
					        },
					        axisLine:{
		             			lineStyle:{
		             				color:'#333',
		             				width:1,
		             			}
		             		}
					    },
					    /* dataZoom: [
					        {
					            type: 'inside',
					            start:60,
					            end:100
					        },
					        {
					            show: false,
					            type: 'slider',
					            start:60,
					            end:100,
					        }
					    ], */
					    series: [
					        {
					            name:"综合："+sumfivedata+"分",
					            type:'line',
					            data:fivedataArray
					        },
					        {
					            name:"口味："+sumonedata+"分",
					            type:'line',
					            data:onedataArray
					        },
					        {
					            name:"环境："+sumtwodata+"分",
					            type:'line',
					            data:twodataArray
					        },
					        {
					            name:"服务："+sumthreedata+"分",
					            type:'line',
					            data:threedataArray
					        },
					        {
					            name:"价格："+sumfourdata+"分",
					            type:'line',
					            data:fourdataArray
					        }
					    ],
					    color:['#D3D3D3','#90EE90','#FFB6C1','#FFA07A','#20B2AA']
					};
				var myChart = echarts.init(document.getElementById("echarts_one"));
				myChart.setOption(option);
			}
		}
	})
}
function logical(){
	userInfo.organizeid=$('#organizeid').val();
	userInfo.organizename=$('#organizename').text();
	JianKangCache.setGlobalData("userinfo",userInfo);
	getdata();
}

$(function(){
	$('#organizename').html(userInfo.organizename);
	
	$('#statisticsTime').val(GetDateStr());
	var currYear = (new Date()).getFullYear();	
	var opt={};
		opt.date = {preset : 'date', dateFormat: 'yy-mm' };
		opt.default = { 
			theme: 'android-ics light', //皮肤样式  
	        display: 'modal', //显示方式  
	        mode: 'scroller', //日期选择模式
	        dateOrder : 'yymm',  
			lang:'zh',
	        startYear:currYear - 10, //开始年份
	        endYear:currYear + 10 //结束年份
		};
	//初始化时间插件
	$("#statisticsTime").scroller('destroy').scroller($.extend(opt['date'], opt['default']));
});
function GetDateStr() { 
	var dd = new Date(); 
	var y = dd.getFullYear(); 
	var m = dd.getMonth()+1;//获取当前月份的日期 
	if(parseInt(m)<10){
		m="0"+m;
	}
	return y+"-"+m; 
}
function preMonth(){
	var time = $("#statisticsTime").val();
	var times = time.split("-");
	var month = parseInt(times[1]) - 1;
	var year = parseInt(times[0]);
	if(month <= 0){
		month = 12;
		year = year - 1;
	}else if( month < 10 && month >= 1){
		month = "0"+month;
	}
	time = year+"-"+month;
	$("#statisticsTime").val(time);
	getdata();
}
function nextMonth(){
	var time = $("#statisticsTime").val();
	var times = time.split("-");
	var month = parseInt(times[1]) + 1;
	var year = parseInt(times[0]);
	if(month >= 13){
		month = "0"+1;
		year = year + 1;
	}else if( month < 10 && month >= 1){
		month = "0"+month;
	}
	time = year+"-"+month;
	$("#statisticsTime").val(time);
	getdata();
}

</script>
<body onload="getdata()">
<div id="htmlbody">
<div class="head_box">
	<a class="ico_back" onclick="location.href='restaurant_index.html'">返回</a>
    <div class="name">每日报表统计</div>
</div>
<div class="head_none"></div>
<div class="rst_report">
	<input type="hidden" id="organizeid" />
	<div class="s_name"><span id="organizename"></span><i onclick="$('#htmlbody').hide();$('#organizeiframe').show();">切换门店</i></div>
    <div class="nav_list">
    	<ul>
        	<li onclick="location.href='report_yye.html'">营业额</li>
            <li onclick="location.href='report_klle.html'">客流量</li>
            <li onclick="location.href='report_cql.html'">出勤人数</li>
            <li onclick="location.href='report_rjxf.html'">人均消费</li>
            <li onclick="location.href='report_cqjc.html'">餐前检查</li>
            <li onclick="location.href='report_cfjc.html'">厨房检查</li>
            <li onclick="location.href='report_ldbg.html'">离店报告</li>
            <li onclick="location.href='report_myd.html'" class="active">顾客满意度</li>
        </ul>
    </div>
    <div class=" report_chart" style="overflow: scroll;">
    	<div class="time_sel">
            <b><i class="pre" onclick="preMonth()">前一天</i><input id="statisticsTime" value="请选择时间" readonly="readonly" onchange="getdata()"/><i class="next" onclick="nextMonth()">后一天</i></b>
        </div>
    	<div id="echarts_one" style="width: 100%;height: 300px;"></div>
    </div>
</div>

</div>
<script type="text/javascript" src="../appcssjs/script/selectshop.js"></script>
</body>
</html>
