<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>巡店日志</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>

<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>
</head>

<body>
<div class="head_box">
	<a class="ico_back" onclick="location.href='restaurant_index.html'">返回</a>
    <div class="name">巡店日志</div>
    <div class="link_yellow" onclick="location.href='patrollog_add.html'" id="linkadd">新建</div>
</div>
<div class="head_none"></div>
<div class="span_nav">
	<span class="active" id="daichuli">待处理</span>
    <span class="last" onclick="location.href='patrollog_list2.html'">已处理</span>
</div>
<div class="page_list">
	<ul id="ul_list">
    </ul>
</div>
<script type="text/javascript">

var nodata = '<div class="list_none"><span><i class="yellow">Hello,我是大狮！</i><br>还没有巡店日志，赶紧添加一条吧~</span><b><img src="'+notDataImageUrl_havepower+'"></b></div>';
  function loadPatrollog(status){
	  JianKangCache.getGlobalData("userinfo",function(user){
		  if(typeof(user.powerMap.power6001010) != "undefined"){
				$('#linkadd').show();
		  }
		  var param = new Object();
		  param.userid = user.userid;
		  param.companyid = user.companyid;
		  getNotIsRead(param);
		  
		  var url = projectpath+'/app/getTourStoreList';
		    var key = "tourStoreList_data_list";
			$.ajax({
			    type:"post",
			    url:url,
			    data:{companyid:user.companyid,userid:user.userid,status:status},
			    success:function(data){
			    	//console.log(data);
			    	//console.log(user);
			    	if(data.requestlist != null && data.requestlist.length>0){
			    		$(".list_none").remove();
			    		$.each(data.requestlist,function(index,value){
			    			var temp = $("#store_temp").html();
			    			if(value.isread+"" == "0"){
			    				value.style="";
			    			}else {
			    				value.style="style=\"background-image:url(''	)\"";
			    			}
			    			$("#ul_list").append(replaceTemp(temp,value));
			    		});
			    		JianKangCache.setData(key,data.requestlist);
			    	}else{
			    		 $("#ul_list").parent().nextAll().remove();
			    		 $(".list_none").remove();
			    		 $("body").append(nodata);
			    	}
			    },error:function(e){
			    	JianKangCache.getData(key,function(result){
			    		$.each(result,function(index,value){
			    			var temp = $("#store_temp").html();
			    			if(value.isread+"" == "0"){
			    				value.style="";
			    			}else {
			    				value.style="style=\"background-image:url(''	)\"";
			    			}
			    			$("#ul_list").append(replaceTemp(temp,value));
			    		});
			    	});
			    }
			});
			
		   PageHelper({
				url:url,
				 data:{companyid:user.companyid,userid:user.userid,status:status},
				success:function(data){
					if(data.requestlist != null){
			    		$.each(data.requestlist,function(index,value){
			    			var temp = $("#store_temp").html();
			    			if(value.isread+"" == "0"){
			    				value.style="";
			    			}else {
			    				value.style="style=\"background-image:url(''	)\"";
			    			}
			    			$("#ul_list").append(replaceTemp(temp,value));
			    		});
			    	}  
				}
			});  
	  });
  }
  $(function(){
	  loadPatrollog(0);
	  
	  $("#daichuli").click(function(){
		  $("#ul_list").html("");
		  //loadPatrollog(0);
		  location.reload();
	  });
	  
  });
  
  //点击改为已读状态
  function changeToRead(forwardId,tourstoreid,isread){
	  if(isread+"" == "0"){
		  $.ajax({
              url:projectpath+"/app/updateReadStatus",
              type:"post",
              data:{dataid:forwardId},
              success:function(data){
            	  location.href='patrollog_detail.html?tourstoreid='+tourstoreid+'&forwarduserid='+forwardId;
              } 	   
		 });
    }else{
    	location.href='patrollog_detail.html?tourstoreid='+tourstoreid+'&forwarduserid='+forwardId;
	  }
 }
  
 function getNotIsRead(param){
		$.ajax({
			url:projectpath+"/app/getTourStoreAllNotRead",
			type:"post",
			data:param,
			success:function(data){
				if(data.status == 0 || data.status == '0'){
					var noexamiennum = data.noexaminenum;
					var examinenum = data.examinenum;
					if(noexamiennum > 0){
						$('.span_nav span:first').prepend(redPoint);
					}
					if(examinenum > 0){
						$('.span_nav span:last').prepend(redPoint);
					}
				}
			}
		});
	}
</script>
<script type="text/temple" id="store_temp">
         <li onclick="changeToRead('{forwarduserid}','{tourstoreid}','{isread}')">
        	 <div class="xx_01"><span {style} class="new">{organizename}</span><em class="red">待处理</em></div>
             <div class="xx_02"><span class="name">{createname}</span><i>{arrivetime}<em>至</em>{leavetime} </i></div>
        </li>
</script>
</body>
</html>
