<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>巡店日志</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>

<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<!-- 语音的录制 播放 上传 -->
<script type="text/javascript" src='../appcssjs/script/media.js'></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>
</head>

<body>
<div id="htmlbody">
<input type="hidden" id="examineuserid">
<span id="examinename" style="display:none"></span>
<div class="head_box">
	<a class="ico_back" onclick="goBackPage()">返回</a>
    <div class="name">巡店日志详情</div>
    <div class="link_yellow" style="display:none" id="send_user">发送</div>
</div>
<div class="head_none"></div>
<div class="detail_box">
	<ul>
    	<li><span class="em">所巡门店</span><i id="organizename"><!-- 浦东店 --></i></li>
        <li><span class="em">到店时间</span><i id="arrivetime"><!-- 2016-06-02 10:20 --></i></li>
        <li><span class="em">离店时间</span><i id="leavetime"><!-- 2016-06-02 10:20 --></i></li>
        <li>
        	<span class="em">发现问题</span>
            <div class="clear"></div>
            <p id="findproblem"><!-- 问题详情问题详情问题详情问题详情问题详情问题详情问题详情问题详情问题详情问题详情问题详情问题详情问题详情问题详情问题详情 --></p>
        </li>
        <li>
        	<span class="em">需解决问题</span>
            <div class="clear"></div>
            <p id="solveproblem"><!-- 需解决问题详情需解决问题详情需解决问题详情需解决问题详情需解决问题详情需解决问题详情需解决问题详情需解决问题详情需解决问题详情 --></p>
        </li>
        <li>
        	<span class="em">门店意见</span>
            <div class="clear"></div>
            <p id="opinion"><!-- 意见详情意见详情意见详情意见详情意见详情意见详情意见详情意见详情意见详情意见详情意见详情意见详情意见详情意见详情意见详情 --></p>
            <div class="img_list" id="files">
                <div class="clear"></div>
            </div>
        </li>
    </ul>
</div>
<div class="xx_user">
    <div class="txt">
        <span class="name">创建人：<em id="createname"><!-- 唐昭仪 --></em></span>
        <span class="time">创建时间：<em id="createtime"><!-- 2016-06-01 12:20 --></em></span>
        <div class="clear"></div>
    </div>
    <div class="txt">
        <span class="name">点评人：<em id="copyname"><!-- 唐昭仪 --></em></span>
        <span class="name" style="width:98%;text-overflow:ellipsis ; overflow:hidden; white-space:nowrap;">抄送人：<em id="CCusernames"><!-- 唐昭仪 --></em></span>
        <div class="clear"></div>
    </div>
    <div class="txt">
        <span class="name" style="width:98%;text-overflow:ellipsis ; overflow:hidden; white-space:nowrap;">转发人：<em id="sendname"></em></span>
        <div class="clear"></div>
    </div>
    <div class="txt last">
        <span class="name" style="font-weight: bold;">点评人意见</span>
        <textarea class="text_area" id="copyopinion"  placeholder="请输入抄送人意见，最多允许输入800字符" maxlength="800"></textarea>
        <div class="clear"></div>
     </div>        
</div>
<div class="comment">
	<div class="name">共有<em id="dataCount"><!-- 2 --></em>条评论</div>
    <ul id="ul_list">
    	<!-- <li>
        	<div class="xx"><b><img src="../appcssjs/images/public/user_img.png"></b><span>shuyi</span><i>2016-01-01 10:10</i></div>
            <div class="txt">企业采购部门向原材料、燃料、零部件、办公用品等的供应者发出的是采购(入库)单，这张采购(入库)单对于供应商来说就是他们的订单。</div>
        </li>
        <li>
        	<div class="xx"><b><img src="../appcssjs/images/public/user_img.png"></b><span>shuyi</span><i>2016-01-01 10:10</i></div>
            <div class="txt">企业采购部门向原材料、燃料、零部件、办公用品等的供应者发出的是采购(入库)单，这张采购(入库)单对于供应商来说就是他们的订单。</div>
        </li> -->
    </ul>
</div>
<!-- <div class="fbtn_none" style="display: none;"></div>
<div class="foot_btn" style="display: none;">
	<span onclick="initforwarding()" class="active">转发</span>
    <span  onclick="">评论</span>
</div> -->
<div class="bt_none"></div>
<div class="tool_detail">
    <div class="talk_detail">
        <div class="a_box">
            <input type="text" readonly="readonly" onclick="initaddcomment();" class="text" placeholder="写评论.意见或建议">
            <a class="zf" onclick="initforwarding();"><img src="../appcssjs/images/share/zf.png"></a>
        </div>
    </div>
</div>
</div>
<script type="text/javascript">
var actiontype;
var createid="";
   var user;
   var userInfo;
   JianKangCache.getGlobalData('userinfo',function(data){
	   userInfo=user=data;
   });
	  var tourstoreid = getUrlParam("tourstoreid");
	  var forwarduserid = getUrlParam("forwarduserid");
	  $.ajax({
		  url:projectpath+"/app/getTourStoreInfo",
		  type:"post",
		  data:{tourstoreid:tourstoreid},
		  success:function(data){
			  console.log(data);
			  if(data.status+"" == "0"){
				  $("#organizename").text(data.tourstoreinfo.organizename);
				  $("#arrivetime").text(data.tourstoreinfo.arrivetime);
				  $("#leavetime").text(data.tourstoreinfo.leavetime);
				  $("#createtime").text(fomartDate(data.tourstoreinfo.createtime));
				  $("#findproblem").text(data.tourstoreinfo.findproblem);
				  $("#solveproblem").text(data.tourstoreinfo.solveproblem);
				  $("#opinion").text(data.tourstoreinfo.opinion);
				  $("#createname").text(data.tourstoreinfo.createname);
				  $("#createname").text(data.tourstoreinfo.createname);
				  $("#copyname").text(data.tourstoreinfo.copyname);
				  
				  $('#createname').attr("onclick","location.href='../member/homepage_info.html?userid="+data.tourstoreinfo.createid+"'");
				  $('#copyname').attr("onclick","location.href='../member/homepage_info.html?userid="+data.tourstoreinfo.copyuserid+"'");
				  var temp="";
				  var filelist = data.tourstoreinfo.filelist;
				  for(var i=0;i<filelist.length;i++){
					  if(filelist[i].type == 1){
						  temp+="<div class=\"img\"><b><img onclick=\"showbigimg(this)\" src=\""+projectpath+filelist[i].visiturl+"\"></b></div>"
					  }else if(filelist[i].type == 2){
						  temp += '<div class="talk" recordAudio="'+filelist[i].visiturl+'" onclick="playRecordAudioSound(this)">语言文件</div>';
					  }
					  
				  }
				  $('#files').prepend(temp);
				  $('#CCusernames').text(data.tourstoreinfo.CCusernames);
				  createid=data.tourstoreinfo.createid;
				  if(data.tourstoreinfo.copyuserid == user.userid && data.tourstoreinfo.copyopinion==""){
					  $("#send_user").show();
				  }else{
					  $("#copyopinion").val(data.tourstoreinfo.copyopinion==""?" ":data.tourstoreinfo.copyopinion).attr("readonly",true);
					  $('.fbtn_none').show();
					  $('.foot_btn').show();
				  }
			  }
		  }
	  });
	  
	  getSendName(forwarduserid,"#sendname");
	  
	  //得到评论列表
	  $.ajax({
		  url:projectpath+"/app/getOrderComment",
		  type:"post",
		  data:{orderid:tourstoreid,resourcetype:22},
		  success:function(data){
			  console.log(data);
			  if(data.commentlist != null && data.commentlist.length>0){
				  showcomment(data);
				  $("#dataCount").text(data.commentlist.length);
			  }else{
				  $("#dataCount").text(0);
			  }
		  }
	  });
	  
	  PageHelper({
		    url:projectpath+"/app/getOrderComment",
			data:{orderid:tourstoreid,resourcetype:22},
			success:function(data){
				showcomment(data);
			}
		});  
	  
	  function showcomment(data){
		if(data.commentlist.length > 0){
			var temp="";
			for(var i=0;i<data.commentlist.length;i++){
				temp+="<li><div class=\"xx\"><b><img src=\""+projectpath+data.commentlist[i].headimage+"\"  onclick=\"location.href='../member/homepage_info.html?userid="+data.commentlist[i].userid+"'\"  /></b>";
				if(data.commentlist[i].replyname!= ""){
					temp+="<span onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">"+data.commentlist[i].realname+"<i>回复</i><em style=\"color:#666;\">"+data.commentlist[i].replyname+"</em></span>";
				}else{
					temp+="<span onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">"+data.commentlist[i].realname+"</span>";
				}
				if(data.commentlist[i].type == "2"){
					temp+="<i>转发</i><em>"+data.commentlist[i].forwardusernames+"</em>";
				}
				temp+="</div><div class=\"txt\" onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+data.commentlist[i].content+"</div><div class=\"time\"><i>"+appBase.parseDateMinute(data.commentlist[i].createtime)+"</i></div></li>";
			}
			$('#ul_list').append(temp);
		}
	}
   //抄送人意见
  $(function(){
	 $("#send_user").click(function(){
         if($("#copyopinion").val().trim() == ""){
        	 swal({
  				title : "",
  				text : "抄送意见不能为空",
  				type : "error",
  				showCancelButton : false,
  				confirmButtonColor : "#ff7922",
  				confirmButtonText : "确认",
  				cancelButtonText : "取消",
  				closeOnConfirm : true
  			}, function(){
  				$("#copyopinion").focus();
  			});
        	 return false;
         } 
         
         $.ajax({
   		  url:projectpath+"/app/examineTourStore",
   		  type:"post",
   		beforeSend:function(a,b){
   			ajaxbefore();
   		},
   		complete:function(a,b){
   			ajaxcomplete();
   		},
   		  data:{tourstoreid:tourstoreid,userid:user.userid,copyopinion:$("#copyopinion").val().trim()},
   		  success:function(data){
   			  if(data.status+"" == "0"){
   				 swal({
   	  				title : "",
   	  				text : "意见填写成功",
   	  				type : "success",
   	  				showCancelButton : false,
   	  				confirmButtonColor : "#ff7922",
   	  				confirmButtonText : "确认",
   	  				cancelButtonText : "取消",
   	  				closeOnConfirm : true
   	  			}, function(){
	   	  			
   	  			   $("#send_user").hide();
   	  			   $("#copyopinion").attr("readonly",true);
   	  			
	   	  			changeIsread(createid,tourstoreid);
					var title= $("#copyname").text()+"对您发布的巡店日志，填写了抄送意见,请及时查看";
					var url="/restaurant/patrollog_detail.html?tourstoreid="+tourstoreid;
					pushMessage(createid,title,url);
					
					window.history.go(-1);
   	  			});
   			  }
   		  },error:function(e){
   			 swal({
   				title : "",
   				text : "意见填写失败，请稍后再试",
   				type : "error",
   				showCancelButton : false,
   				confirmButtonColor : "#ff7922",
   				confirmButtonText : "确认",
   				cancelButtonText : "取消",
   				closeOnConfirm : true
   			}, function(){
   				 
   			});
   		  }
        });
	 }); 
	 //确认评论
	 $("#addcomment").click(function(){
		 if(actiontype==1){
			 sendComment(1,"","");
				location.reload(false);
			}else{
				$('.div_mask').hide();
				$('#commentdiv').hide();
				$('#organizeiframe').show();
				$('#htmlbody').hide();
			}	
  	 });
});
   
  function sendComment(type,forwardusernames,forwarduserids){
		 if($("#content").val().trim() == ""){
     	 swal({
				title : "",
				text : "评论内容不能为空",
				type : "error",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
				$("#content").focus();
			});
     	 return false;
      } 
	     $.ajax({
	   		  url:projectpath+"/app/insertComment",
	   		  type:"post",
	   		  data:{resourceid:tourstoreid,userid:user.userid,resourcetype:22,content:$("#content").val().trim(),parentid:$("#parentid").val(),
	   			  type:type,forwardusernames:forwardusernames,forwarduserids:forwarduserids},
	   		  success:function(data){
	   			  if(data.status+"" == "0"){
	   				/* swal({
		   				title : "",
		   				text : "评论成功",
		   				type : "success",
		   				showCancelButton : false,
		   				confirmButtonColor : "#ff7922",
		   				confirmButtonText : "确认",
		   				cancelButtonText : "取消",
		   				closeOnConfirm : true
		   			}, function(){
		   				 
		   			}); */
	   				changeIsread(createid,tourstoreid);
	   				 //把被评论者对应的数据改变成未读
	   				 $.ajax({
	   					url:projectpath+"/app/updateIsread",
	  		   		    type:"post",
	  		   		    data:{resourceid:tourstoreid,receiveid:$("#comment_bei_userid").val(),isread:0,},
	  		   		    success:function(data){
		  		   		   	  		   		    	
	  		   		    },error:function(e){
	  		   		    	
	  		   		    }
	   				 });
	   			  }else{
	   				swal({
		   				title : "",
		   				text : "评论失败，请稍后再试",
		   				type : "error",
		   				showCancelButton : false,
		   				confirmButtonColor : "#ff7922",
		   				confirmButtonText : "确认",
		   				cancelButtonText : "取消",
		   				closeOnConfirm : true
		   			}, function(){
		   				 
		   			});
	   			  }
	   			  
	   		  },error:function(e){
	   			 swal({
	   				title : "",
	   				text : "评论失败，请稍后再试",
	   				type : "error",
	   				showCancelButton : false,
	   				confirmButtonColor : "#ff7922",
	   				confirmButtonText : "确认",
	   				cancelButtonText : "取消",
	   				closeOnConfirm : true
	   			}, function(){
	   				 
	   			});
			 }  
		 });
	 }
  //取消评论
  function cancel(){
	  $(".div_mask").hide();
	  $("#commentdiv").hide();
  }
  function initforwarding(parentid,parentuserid){
		actiontype=0;
		$('#content').val("");
		$('#parentid').val(parentid);
		$('#parentuserid').val(parentuserid);
		$('.div_mask').show();
		$('#commentdiv').show();
		$('#content').focus();
	}
  //添加评论 弹出评论层
  function initaddcomment(parentid,userid){
	  actiontype=1;
	  $('#content').val("");
	  $(".div_mask").show();
	  $("#commentdiv").show();
	  $("#parentid").val(parentid);
	  $("#comment_bei_userid").val(userid);//被评论者id
	  $('#content').focus();
  }
  //转发
  function logical(){
	  swal({
			title : "",
			text : "确认转发给"+$('#examinename').text()+"？",
			type : "success",
			showCancelButton : true,
			confirmButtonColor : "#ff7922",
			confirmButtonText : "确认",
			cancelButtonText : "取消",
			closeOnConfirm : true
		}, function(){
			sendComment(2,$('#examinename').text(),$('#examineuserid').val());
			userForword(userInfo.companyid,tourstoreid,$('#examineuserid').val(),userInfo.userid,22);
			location.reload(false);
		});
  }
  
  
</script>
<script type="text/temple" id="comment_temp">
  <li>
     <div class="xx"><b><img src="{headimage}" onclick=\"location.href='../member/homepage_info.html?userid={userid}'\" /></b><span  onclick="showCommentDive('{commentid}','{userid}')">{realname}</span><i>{createtime}</i></div>
     <div class="txt"  onclick="showCommentDive('{commentid}','{userid}')">{content}</div>
  </li>
</script>

<div class="div_mask" style="display: none" onclick="cancel();"></div>
<div class="tc_comment" style="display: none" id="commentdiv">
	<!-- <div class="name">评论</div> -->
	 <input type="hidden" id="parentid" />
	 <input type="hidden" id="comment_bei_userid" />
    <div class="text_box"><textarea id="content"></textarea></div>
    <div class="btn_box">
    	<!-- <input type="button" value="提交" class="btn_01" > -->
        <input type="button" value="发表" class="btn_02" id="addcomment" style="margin-left:180px;">
    </div>
</div>

<script type="text/javascript" src="../appcssjs/script/selectuser_forward.js"></script>
</body>
</html>
