<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>巡店日志</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>

<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<!-- 语音的录制 播放 上传 -->
<script type="text/javascript" src='../appcssjs/script/media.js'></script>

<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script> 
<link href="../appcssjs/style/mobiscroll.custom-2.6.2.min.css" type="text/css" rel="stylesheet"> 
<script src="../appcssjs/script/mobiscroll.custom-2.6.2.min.js"></script> 

<script type="text/javascript">
function onPhotoDataSuccess(imageData,fileSize) {
	if($('#imagediv').find('div[class=img]').length < 3){
		var temp="<div class=\"img\"><b><input type=\"hidden\" name=\"imageurl\" filesize=\""+fileSize+"\" value=\""+imageData+"\"/><img onclick=\"showbigimg(this)\" src=\""+projectpath+imageData+"\" /></b><div class=\"del\" onclick=\"delimage(this)\">删除</div></div>";
		$('#addimgbtn').before(temp);
	}else{
		swal({
			title : "",
			text : "上传失败,最多上传三张图片",
			type : "error",
			showCancelButton : false,
			confirmButtonColor : "#ff7922",
			confirmButtonText : "确认",
			cancelButtonText : "取消",
			closeOnConfirm : true
		}, function(){
			 
		});
	}
}
function delimage(obj){
	$(obj).parent().remove();
	$('#moduleimage').val("");
}
</script>
</head>

<body>
<div id="htmlbody">
<div class="head_box">
	<a class="ico_back" onclick="location.href='patrollog_list1.html'">返回</a>
    <div class="name">新建巡店日志</div>
    <div class="link_yellow" id="save_btn">保存</div>
</div>
<div class="head_none"></div>
<div class="detail_box">
<form  id="data_form">
	<ul>
    	<li><span class="em">所巡门店</span><input type="text" readonly="readonly" id="dianmian" class="t_sel" placeholder="请选择门店"></li>
        <li><span class="em">到店时间</span><input type="text" id="arrivetime" readonly="readonly" name="arrivetime" class="text" placeholder="请输入到店时间"></li>
        <li><span class="em">离店时间</span><input type="text" id="leavetime" readonly="readonly"  name="leavetime"  class="text" placeholder="请输入离店时间"></li>
        <li>
        	<span class="em">发现问题</span>
            <div class="clear"></div>
            <p><textarea class="text_area" id="findproblem" name="findproblem" maxlength="800" placeholder="请输入发现问题内容，最多允许输入800字符" ></textarea></p>
        </li>
        <li>
        	<span class="em">需解决问题</span>
            <div class="clear"></div>
            <p><textarea class="text_area" id="solveproblem" name="solveproblem" maxlength="800" placeholder="请输入解决问题内容，最多允许输入800字符" ></textarea></p>
        </li>
        <li>
        	<span class="em">门店意见</span>
            <div class="clear"></div>
            <p><textarea class="text_area" id="opinion" name="opinion" maxlength="800" placeholder="请输入门店意见，最多允许输入800字符"></textarea></p>
            <div class="img_list"  id="imagediv">
                <div class="img_add" onclick="getPhoto(pictureSource.PHOTOLIBRARY,{type:11});" id="addimgbtn">添加图片</div>
                <div class="talk_add">添加语言</div>
                <div class="clear"></div>
            </div>
        </li>
    </ul>
    <input type="hidden" id="companyid" name="companyid" />
    <input type="hidden" id="createid" name="createid" />
    <input type="hidden" id="organizeid" name="organizeid" />
    <input type="hidden" id="examineuserid" name="copyuserid" />
    <input type="hidden" name="filelist" id="filelist"/>
    <span id="organizename" style="display: none;"></span>
 </form>
</div>
<div class="xx_adduser">
	<ul>
    	<li><span>点&nbsp;评&nbsp;人：</span><i id="examinename"><!-- 唐昭仪,唐昭仪 --></i><a onclick="$('#useriframe').show();$('#htmlbody').hide();"><img src="../appcssjs/images/public/btn_add.png"></a></li>
        <li><span>抄&nbsp;送&nbsp;人：</span><i id="CCusernames" style="text-overflow:ellipsis ; overflow:hidden; white-space:nowrap; max-width:59%;"></i><a onclick="$('#CCmorechange_organizeiframe').show();$('#htmlbody').hide();"><img src="../appcssjs/images/public/btn_add.png"></a></li>
        <li><span>申&nbsp;请&nbsp;人：</span><i id="realName"><!-- 唐昭仪 --></i></li>
        <li><span>填写时间：</span><i id="nowTime"><!-- 2016-06-01 12:20 --></i></li>
    </ul>
</div>
</div>
<script type="text/javascript">
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
});
$(function(){
	//从缓存中取出用户信息
	$("#companyid").val(userInfo.companyid);
	$("#createid").val(userInfo.userid);
	$("#realName").text(userInfo.realname);
	$('#realName').attr("onclick","location.href='../member/homepage_info.html?userid="+userInfo.userid+"'");
	$("#nowTime").text(getNowTime());
	//初始化时间控件
	var opt={ 
		preset : 'datetime',   				    //格式
		theme: 'android-ics light', 		//皮肤样式
        display: 'modal', 					//显示方式 
        mode: 'scroller',	 				//日期选择模式
		lang:'zh',         					// 国际化 中文
		dateOrder: 'yymmdd', //面板中日期排列格
		dateFormat: 'yyyy-mm-dd', // 日期格式
		endYear:(new Date()).getFullYear()
	}; 
    $("#arrivetime").scroller(opt);
    $("#leavetime").scroller(opt);
    
    //点击店面
    $("#dianmian").click(function(){
    	$('#htmlbody').hide();
    	$('#organizeiframe').show();
    });
    
    //点击背景色
    $(".div_mask").click(function(){
    	$(".div_mask").hide();
    	$("#organize_div").hide();
    });
  
    $(document).delegate("#organize_div li","click",function(){
    	$(this).attr("class","active");
    	$(this).siblings().attr("class","");
    });
    // 点击保存门店值
    $("#sure_btn").click(function(){
      var value = $("#organize_div li[class='active']").attr("value");
      var text = $("#organize_div li[class='active']").text();
      $("#organizeid").val(value);
      $("#dianmian").val(text);
      $(".div_mask").click();
    });
    
    //点击保存
    $("#save_btn").click(function(){
    	var time1 = $("#arrivetime").val();
    	var time2 = $("#leavetime").val();
    	if($("#organizeid").val() == ""){
    		 swal({
 				title : "",
 				text : "请选择门店",
 				type : "error",
 				showCancelButton : false,
 				confirmButtonColor : "#ff7922",
 				confirmButtonText : "确认",
 				cancelButtonText : "取消",
 				closeOnConfirm : true
 			}, function(){
 				 
 			});
    		 return false;
    	}
    	
    	if(time1 == ""){
   		 swal({
				title : "",
				text : "请选择到店时间",
				type : "error",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
				 
			});
   		 return false;
   	    }
    	
    	
    	if(time2 == ""){
   		 swal({
				title : "",
				text : "请选择离店时间",
				type : "error",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
				 
			});
   		 return false;
   	}
    	
    	if(compareTime(time1,time2)){
    	   swal({
				title : "",
				text : "到店时间不能大于离店时间",
				type : "error",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
				 
			});
    	   return false;
    	}
    	
    	var flg = 0;
    	if(flg == 0){
    		flg = 1;
    		var alldata={"filelist":[]};
    		if($('#imagediv').find("input[name=imageurl]").length > 0){
	    		$('#imagediv').find("input[name=imageurl]").each(function(index){
	    			var imagemap={};
	    			imagemap['visiturl']=$(this).val();
	    			imagemap['resourcetype']=22;
	    			imagemap['type']=1;
	    			imagemap['size']=parseInt($(this).attr("filesize"));
	    			alldata.filelist.push(imagemap); 
	    		});
	    		//$('#filelist').val(JSON.stringify(alldata));
	    	}
    		var soundurl = localStorage.http_audio_foldname_url;
    		if(soundurl != ""){
    			var imagemap={};
    			imagemap['visiturl']=soundurl;
    			imagemap['resourcetype']=22;
    			imagemap['type']=2;
    			imagemap['size']="";
    			alldata.filelist.push(imagemap); 
    		}
    		
	    	var jsonData = getFormBean("data_form");
	    	jsonData.userlist = $("#userlist").val();
	    	jsonData.CCusernames = $('#releaserange').text();
	    	jsonData.filelist = JSON.stringify(alldata);
	    	
    		 $.ajax({
	               url:projectpath+"/app/insertTourStore",
	               type:"post",
	               data:jsonData,
	               success:function(data){
	            	   if(data.status+"" == "0"){
	            		   swal({
	   	       				title : "",
	   	       				text : "保存成功！",
	   	       				type : "success",
	   	       				showCancelButton : false,
	   	       				confirmButtonColor : "#ff7922",
	   	       				confirmButtonText : "确认",
	   	       				cancelButtonText : "取消",
	   	       				closeOnConfirm : true
	   	       			}, function(){
	   	       				 location.href='patrollog_list1.html';
	   	       			}); 
	            	   }else{
	            		   swal({
	   	       				title : "",
	   	       				text : "保存失败，请稍后再试",
	   	       				type : "error",
	   	       				showCancelButton : false,
	   	       				confirmButtonColor : "#ff7922",
	   	       				confirmButtonText : "确认",
	   	       				cancelButtonText : "取消",
	   	       				closeOnConfirm : true
	   	       			}, function(){
	   	       				 
	   	       			}); 
	            	   }
	               },error:function(e){
	            	   swal({
		       				title : "",
		       				text : "保存失败，请稍后再试",
		       				type : "error",
		       				showCancelButton : false,
		       				confirmButtonColor : "#ff7922",
		       				confirmButtonText : "确认",
		       				cancelButtonText : "取消",
		       				closeOnConfirm : true
		       			}, function(){
		       				 
		       			}); 
	               }
    		 });
    	}
    });
     
});

function compareTime(time1,time2){
	var date1 = new Date(time1.replace(/-/g,'/')).getTime();
	var date2 = new Date(time2.replace(/-/g,'/')).getTime();
	return date1>date2;
}

function getNowTime(){
	  var date = new Date();
	  this.year = date.getFullYear();
	  this.month = date.getMonth() + 1;
	  this.date = date.getDate();
	  this.month=this.month<10?"0"+this.month:this.month;
	  this.date=this.date<10?"0"+this.date:this.date;
	  this.hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
	  this.minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
	  var currentTime = this.year + "-" + this.month + "-" + this.date + " " + this.hour + ":" + this.minute;
      return currentTime;
}
function logical(){
	if($('#organizename').text()!= ""){
		$('#dianmian').val($('#organizename').text());
	}
}
</script>
<script type="text/javascript" src="../appcssjs/script/selectshop.js"></script>
<script type="text/javascript" src="../appcssjs/script/selectuser2.js"></script>
<script type="text/javascript" src="../appcssjs/script/select_xiebanren2.js"></script>
</body>
</html>
