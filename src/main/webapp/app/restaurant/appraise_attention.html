<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>顾客满意度-我的关注</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/restaurant.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>
<link href="../appcssjs/style/mobiscroll.custom-2.6.2.min.css" type="text/css" rel="stylesheet"> 
<script src="../appcssjs/script/mobiscroll.custom-2.6.2.min.js"></script> 
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script> 
</head>
<body>
<div id="htmlbody">
<input type="hidden" id="organizeid" name="organizeid" />
<span id="organizename" style="display: none;"></span>
<div class="head_box">
	<a class="ico_back" onclick="location.href='appraise_list.html'">返回</a>
    <div class="name">我的关注</div>
</div>
<div class="head_none"></div>
<div class="top_sel">
	<div class="other"><input type="text" class="t_sel" id="organize_option" readonly="readonly" value="" onclick="$('#htmlbody').hide();$('#organizeiframe').show();" >
	</div>
    <div class="span">-</div>
    <div class="time"><input type="text" class="t_time" id="begintime" readonly="readonly" placeholder="请输入时间" value=""></div>
    <div class="span">&nbsp;</div>
    <div class="btn"><input type="button" value="" id="search_btn"></div>
</div>
<div class="appraise_list">
	<ul id="ul_list">
    </ul>
</div>
<script type="text/javascript">
var userInfo;
JianKangCache.getGlobalData("userinfo",function(data){
	userInfo=data;
})
var nodata = '<div class="list_none"><span><i class="yellow">Hello,我是大狮！</i><br>还没有关注顾客满意度，赶紧添加一条吧~</span><b><img src="'+notDataImageUrl_havepower+'"></b></div>';
function loadStoreEvaluate(createtime,organizeid){
	JianKangCache.getGlobalData("userinfo",function(user){
		if(organizeid == null){
			organizeid = user.organizeid;
			$('#organize_option').val(user.organizename);
		}
	    var url = projectpath+'/app/getStoreEvaluateList';
	    var key = "storeEvaluateList_data_list";
		$.ajax({
		    type:"post",
		    url:url,
		    data:{companyid:user.companyid,createtime:createtime,organizeid:organizeid,createid:user.userid,isfollow:1},
		    success:function(data){
		    	$(".list_none").remove();
		    	if(data.punishlist != null && data.punishlist.length>0){
		    		$.each(data.punishlist,function(index,value){
		    			 if(value.isfollow+"" ==  "0"){
		    				 value.isfollow_txt = "关注";
		    			 }else{
		    				 value.isfollow_txt = "取消关注";
		    			 }
		    			 value.tastStar =getStar(value.tastescore);
		    			 value.envirementStar =getStar(value.environmentscore);
		    			 value.servierStar =getStar(value.servicescore);
		    			 value.priceStar =getStar(value.pricescore);
		    			 value.createid = user.userid;
		    			 value.createtime = appBase.parseDateMinute(value.createtime);
		    			var temp = $("#storeEvaluate_temp").html();
		    			$("#ul_list").append(replaceTemp(temp,value));
		    		});
		    		JianKangCache.setData(key,data.punishlist);
		    	}else{
		    		$("#ul_list").parent().nextAll().remove();
		    		$("body").append(nodata);
		    	}
		    },error:function(e){
		    	JianKangCache.getData(key,function(result){
		    		$.each(result,function(index,value){
		    			var temp = $("#storeEvaluate_temp").html();
		    			if(value.isfollow+"" ==  "0"){
		    				 value.isfollow_txt = "关注";
		    			 }else{
		    				 value.isfollow_txt = "取消关注";
		    			 }
		    			 value.tastStar =getStar(value.tastescore);
		    			 value.envirementStar =getStar(value.environmentscore);
		    			 value.servierStar =getStar(value.servicescore);
		    			 value.priceStar =getStar(value.pricescore);
		    			 value.createid = user.userid;
		    			 value.createtime = appBase.parseDateMinute(value.createtime);
		    			$("#ul_list").append(replaceTemp(temp,value));
		    		});
		    	});
		    }
		}); 
		
	   PageHelper({
			url:url,
			data:{companyid:user.companyid,createtime:createtime,organizeid:organizeid},
			success:function(data){
				if(data.punishlist != null){
		    		$.each(data.punishlist,function(index,value){
		    			var temp = $("#storeEvaluate_temp").html();
		    			if(value.isfollow+"" ==  "0"){
		    				 value.isfollow_txt = "关注";
		    			 }else{
		    				 value.isfollow_txt = "取消关注";
		    			 }
		    			 value.tastStar =getStar(value.tastescore);
		    			 value.envirementStar =getStar(value.environmentscore);
		    			 value.servierStar =getStar(value.servicescore);
		    			 value.priceStar =getStar(value.pricescore);
		    			 value.createid = user.userid;
		    			 value.createtime = appBase.parseDateMinute(value.createtime);
		    			$("#ul_list").append(replaceTemp(temp,value));
		    		});
		    	}  
			}
		});
	});
}
$(function(){
	loadStoreEvaluate(null,null);
	var opt={ 
 			preset : 'date',   				    //格式
			theme: 'android-ics light', 		//皮肤样式
	        display: 'modal', 					//显示方式 
	        mode: 'scroller', 	 				//日期选择模式
			lang:'zh',         					// 国际化 中文
			dateOrder: 'yymmdd', //面板中日期排列格
			dateFormat: 'yyyy-mm-dd', // 日期格式
			endYear:(new Date()).getFullYear() + 100
		}; 
	$("#begintime").scroller(opt);
	//搜索
	$("#search_btn").click(function(){
		    var createtime = $("#begintime").val();
		    var organizeid = $("#organize_option").val();
		    $("#ul_list").html("");
			loadStoreEvaluate(createtime,organizeid);
		});
});
function getStar(data){
	var star = "";
	for(var i=0;i<parseInt(data);i++){
		star+='<em><img src="../appcssjs/images/public/start2.png"></em>';
	}
	for(var i=0;i<5-parseInt(data);i++){
		star+='<em><img src="../appcssjs/images/public/start3.png"></em>';
	}
	return star;
}
function toggleShow(obj){
	if($(obj).attr("class") == "down"){
		$(obj).parent().next().show();
		$(obj).attr("class","up");	
	}else{
		$(obj).parent().next().hide();
		$(obj).attr("class","down");
	}
	$(obj).parent().parent().siblings().find(".start_box").hide();
	$(obj).parent().parent().siblings().find(".head_line span:eq(0)").attr("class","down");
}

//关注
function attention(createid,evaluateid,companyid,isfollow,obj){
	var opt = {
			createid:createid,
			evaluateid:evaluateid,
			companyid:companyid,
			isattention:isfollow
	}
	$.ajax({
		url:projectpath+"/app/followStoreEvaluate",
		type:"post",
		data:opt,
		success:function(data){
          	//console.log(data);	
          	if(data.status+"" == "0"){
          		$("#search_btn").click();
          		/* var txt = "";
          		if(data.isfollow+"" == "0"){
          		    txt = "关注";
          		}else if(data.isfollow+"" == "1"){
          			txt = "取消关注";
          		}
          		$(obj).attr("onclick","attention(\'"+createid+"\',\'"+evaluateid+"\',\'"+companyid+"\',\'"+data.isfollow+"\',this)").text(txt); */
          	}else{
          		swal({
					title : "",
					text : "操作失败，请稍后再试",
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					 
				});
          	}
			
		},error:function(data){
			   swal({
					title : "",
					text : "操作失败，请稍后再试",
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					 
				});
		}
	});
}
function logical(){
	if($('#organizename').text()!= ""){
		$('#organize_option').val($('#organizename').text());
		userInfo.organizeid=$('#organizeid').val();
		userInfo.organizename=$('#organizename').text();
		JianKangCache.setGlobalData("userinfo",userInfo);
	}
}
</script>
<script type="text/temple" id="storeEvaluate_temp">
<li>
        	<div class="head_line" style="padding:0px 10px;"><span class="down" onclick="toggleShow(this);">{createtime}</span><i>综合得分：<em>{averagescore}分</em></i><a style="width:58px; font-size:12px;" onclick="attention('{createid}','{evaluateid}','{companyid}','{isfollow}',this)">{isfollow_txt}</a></div>
            <div class="start_box" style="display:none">
                <div class="start"><span>口味得分</span>
                  <b>
                     {tastStar}
                  </b>
                </div>
                <div class="start"><span>环境得分</span>
                  <b>
                     {envirementStar}
                  </b>
                </div>
                <div class="start"><span>服务得分</span>
                   <b>
                      {servierStar}
                  </b>
                </div>
                <div class="start"><span>价格得分</span>
                  <b>
                      {priceStar}
                  </b>
                </div>
                <div class="span_box">
                    <span class="name">{name}</span>
                    <span class="tel">{phone}</span>
                    <span class="num">{seat}</span>
                </div>
                <div class="p_box">{opinion}</div>
            </div>
        </li>
</script>
</div>
<script type="text/javascript" src="../appcssjs/script/selectshop.js"></script>
</body>
</html>
