 <!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>权限管理-授权</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/member.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>
<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>


<script type="text/javascript">
var noneusermap;
JianKangCache.getGlobalData('noneusermap',function(data){
	noneusermap=data;
})
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
})
this.userid= noneusermap.userid;

//加载数据
function showdata(){
	
	if(noneusermap.userid==null || noneusermap.userid==undefined || noneusermap.userid==""){
		goback();
		return;
	}
	$("#realname").text(noneusermap.realname);
	$("#userid").val(noneusermap.userid);
	//查询权限数据
	$.ajax({
		type:"post",
		dataType:"json",
		url:projectpath+"/app/getSelectPowerCompanynew?companyid="+userInfo.companyid+"&userid="+ noneusermap.userid,
		success:function(data){
			if(data.listone != null || data.listone.length != ""){
				var temp="";
				temp += "<li class=\"leve_a\" style=\"display:block;\"><span class=\"leve_a_s\"><i></i><a style=\"margin-top:-25px;\" class=\"check\" onclick=\"clickall(this)\">选择</a><div class=\"clear\"></div></span>";
				for(var i= 0;i<data.listone.length;i++){
					//temp += "<tr><td rowspan=\""+data.listone[i].childnum+"\">"+data.listone[i].powername+"</td>";
					//temp += "<li class=\"leve_a\"><span class=\"leve_a_s bg_hidden\"><i onclick=\"clickone(this)\">"+data.listone[i].powername+"</i><a class=\"check\" name=\"onemune"+i+"\" onclick=\"checkone(this)\" value=\""+data.listone[i].powerid+"\">选择</a><div class=\"clear\"></div></span>";
					if(data.datalist.length != null || data.datalist.length != ""){
						
						var rumnumber = 0;
						for(var j= 0;j<data.datalist.length;j++){
							if(data.listone[i].powerid == data.datalist[j].parentid){
								
									//temp += "<td>"+data.datalist[j].powername+"</td>"+
									//"<td>"+info+"<a href=\"#\" class=\"blue\"  onclick=\"details('"+data.datalist[j].powerid+"')\">详情</a></td>";
									if(data.datalist[j].edition==1){
										//temp+="<td><i class=\"green\">已获得</i>（普通)</td><td>&nbsp;</td>";
										temp+="<li class=\"leve_a\"><span class=\"leve_a_s\"><i>"+data.listone[i].powername+" - "+data.datalist[j].powername+"</i><a class=\""+(data.datalist[j].isshow==1?"check_ed":"check")+" twomune\" parentname=\"onemune"+i+"\" onclick=\"checktwo(this)\" value=\""+data.datalist[j].powerid+"\">选择</a><div class=\"clear\"></div></span></li>";
									}else{
										if(data.datalist[j].result==1){
												//temp += "<td><i class=\"green\">已获得</i>（专业版)</td><td>&nbsp;</td>";
											temp+="<li class=\"leve_a\"><span class=\"leve_a_s\"><i>"+data.listone[i].powername+" - "+data.datalist[j].powername+"</i><a class=\""+(data.datalist[j].isshow==1?"check_ed":"check")+" twomune\" parentname=\"onemune"+i+"\" onclick=\"checktwo(this)\" value=\""+data.datalist[j].powerid+"\">选择</a><div class=\"clear\"></div></span></li>";
										}else if(data.datalist[j].status ==2){
												//temp+="<td>未获得<td><i class=\"green\">申请中</i></br>"+data.datalist[j].createtime+"</td>";
										}else{
											if(typeof(userInfo.powerMap.power7001710) != "undefined"){
												//temp+="<td>未获得<td><a href=\"#\" class=\"blue\" onclick=\"checkPweroCompany('"+data.datalist[j].powercompanyid+"')\" >申请</a></td>";	
											}
										}
									}	
							}
						}
						
					}
					
				}
				$('#power_list_data').html(temp);
			}else{
				$('#power_list_data').html("");
			}	
				
		}
	})
}

/* //点击1级模块展开所属二级
function clickone(obj){
	if($(obj).parent("span").attr("class")=="leve_a_s bg_hidden"){
		$(obj).parent("span").attr("class","leve_a_s bg_show");
		$(obj).parent("span").next("ul").show();
	}else{
		$(obj).parent("span").attr("class","leve_a_s bg_hidden");
		$(obj).parent("span").next("ul").hide();
	}
}

//选择一级模块
function checkone(obj){
	if($(obj).attr("class")=="check"){
		$(obj).attr("class","check_ed");
		$("a[parentname="+$(obj).attr("name")+"]").attr("class","check_ed twomune");
	}else{
		$(obj).attr("class","check");
		$("a[parentname="+$(obj).attr("name")+"]").attr("class","check twomune");
	}
} */

//点击全选
function clickall(obj){
	if($(obj).attr("class")=="check"){
		$(obj).attr("class","check_ed");
		$("#power_list_data .twomune").attr("class","check_ed twomune");
	}else{
		$(obj).attr("class","check");
		$("#power_list_data .twomune").attr("class","check twomune");
	}
}

//选择二级
function checktwo(obj){
	if($(obj).attr("class")=="check twomune"){
		$(obj).attr("class","check_ed twomune");
	}else{
		$(obj).attr("class","check twomune");
	}
}

//点击保存
function submitdata(){
	var ownerid=$("#userid").val();
	var listInsrt = [];
	var i = 0;
	var  param = new Object();
	param.ownerid=ownerid;
	param.userid=userInfo.userid;
	$("#power_list_data a[class='check_ed twomune']").each(function(index,dom){
		if($(this).attr("value")!=null && $(this).attr("value")!=undefined && $(this).attr("value")!=""){
			listInsrt[i] = {powerid:$(this).attr("value")};
			i++;
		}
	})	
	param.listInsrt = JSON.stringify(listInsrt);
	
	var listDelete = [];
	var j = 0;
	$("#power_list_data a[class='check twomune']").each(function(index,dom){
		if($(this).attr("value")!=null && $(this).attr("value")!=undefined && $(this).attr("value")!=""){
			listDelete[j] = {powerid:$(this).attr("value")};
			j++;
		}
	})	
	param.listDelete = JSON.stringify(listDelete);
	
	if(param != null){
		$.ajax({
			type:"post",
			dataType:"json",
			url:projectpath+"/app/insertUserPowerInfonew",
			data:param,
			beforeSend:function(a,b){
				ajaxbefore();
			},
			complete:function(a,b){
				ajaxcomplete();
			},
			success:function(data){
				if(data.status==1){
					swal({
						title : "",
						text : data.errors,
						type : "error",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
						goback();
					});
				}else{
					swal({
						title : "",
						text : data.success,
						type : "success",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
						goback();
					});	
				}
			}
		})
	}	
}

function goback(){
	location.href="personnel_list.html";
}
</script>
</head>

<body onload="showdata()">
<div class="head_box">
	<a class="ico_back" onclick="goback()">返回</a>
    <div class="name">权限分配</div>
    <div class="link_yellow" onclick="submitdata()">保存</div>
</div>
<div class="head_none"></div>

<div class="user_power">
	<div class="name"><span id="realname"></span><input type="hidden" value="" id="userid"/>
		
        	
        
	</div>
    <ul class="power_list" id="power_list_data">
    	<!-- <li class="leve_a">
        	<span class="leve_a_s bg_hidden"><i>模块1</i><a class="check">选择</a><div class="clear"></div></span>
        </li>
    	<li class="leve_a">
        	<span class="leve_a_s bg_show"><i>模块2</i><a class="check">选择</a><div class="clear"></div></span>
            <ul>
            	<li class="leve_b">
                	<span class="leve_b_s bg_hidden"><i>子模块</i><a class="check">选择</a><div class="clear"></div></span>
                </li>
                <li class="leve_b">
                	<span class="leve_b_s bg_show"><i>子模块</i><a class="check">选择</a><div class="clear"></div></span>
                    <ul>                    	
                        <li class="leve_c"><i>孙模块</i><a class="check_ed">选择</a><div class="clear"></div></li>
                        <li class="leve_c"><i>孙模块</i><a class="check">选择</a><div class="clear"></div></li>
                        <li class="leve_c"><i>孙模块</i><a class="check">选择</a><div class="clear"></div></li>
                    </ul>
                </li>
            </ul>
        </li>
        <li class="leve_a">
        	<span class="leve_a_s bg_hidden"><i>模块3</i><a class="check_ed">选择</a><div class="clear"></div></span>
        </li>
        <li class="leve_a">
        	<span class="leve_a_s bg_hidden"><i>模块4</i><a class="check">选择</a><div class="clear"></div></span>
        </li> -->
    </ul>
</div>

</body>
</html>
