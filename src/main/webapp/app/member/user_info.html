<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>个人信息</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/member.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<link href="../appcssjs/style/mobiscroll.custom-2.6.2.min.css" type="text/css" rel="stylesheet"> 
<script src="../appcssjs/script/mobiscroll.custom-2.6.2.min.js"></script> 
</head>
<script type="text/javascript">
var userInfo,organizeid,
	number = 0;
var  sex = "1";
var organizeList = [];

//接受传进来的userid
var userid="";
JianKangCache.getGlobalData('userid',function(data){
	userid=data.userid;
})

JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
})


//切换div
function checkUpdate(obj){
	if(obj == "name"){
		$("#realnames").val($("#realname").html());
		$("#personal").hide();
		$("#name").show();
	}else if (obj == "sexs" ){
		var ses=$("#sex").html()
		if( ses == "女" ){
			sex = "0";
			$("#boy").attr("class","check");
			$("#girl").attr("class","check_ed");
		}else{
			sex="1";
			$("#boy").attr("class","check_ed");
			$("#girl").attr("class","check");
		}
		$("#personal").hide();
		$("#sexs").show();
	}else if(obj == "birth"){
		$("#birthdays").val($("#birthday").html());
		$("#personal").hide();
		$("#birth").show();
		$("#birthdays").click();
	}else if(obj == "emal"){
		$("#emails").val($("#email").html());
		$("#personal").hide();
		$("#emal").show();
	}else if(obj == "position"){
		$("#posions").val($("#position").html());
		$("#personal").hide();
		$("#posion").show();
	}
}

//返回  
function checkReturn(obj){
	if(obj == "name"){
		$("#personal").show();
		$("#name").hide();
	}else if (obj == "sexs" ){
		$("#personal").show();
		$("#sexs").hide();
	}else if(obj == "birth"){
		$("#personal").show();
		$("#birth").hide();
	}else if(obj == "emal"){
		$("#personal").show();
		$("#emal").hide();
	}else if(obj == "posion"){
		$("#personal").show();
		$("#posion").hide();
	}
}
//姓名修改
function checkUpdateName(){
	var realname=$("#realnames").val();
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/updateOrganizeUserInfo?userid='+userid+'&realname='+realname,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					
				});
			}else{
				userInfo.realname=realname;
				JianKangCache.setGlobalData('userinfo',userInfo);
				swal({
					title : "",
					text : "修改成功",
					type : "success",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
				$("#realname").html(realname);
				$("#personal").show();
				$("#name").hide();
			}
		}
	})	
}

//职位修改
function checkUpdatePosition(){
	var position=$("#posions").val();
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/updateOrganizeUserInfo?userid='+userInfo.userid+'&position='+position,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					
				});
			}else{
				userInfo.realname=realname;
				JianKangCache.setGlobalData('userinfo',userInfo);
				swal({
					title : "",
					text : "修改成功",
					type : "success",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
				$("#position").html(position);
				$("#personal").show();
				$("#posion").hide();
			}
		}
	})	
}

//生日修改
function checkUpdateBirthday(){
	var birthday=$("#birthdays").val();
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/updateOrganizeUserInfo?userid='+userid+'&birthday='+birthday,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
			}else{
				userInfo.birthday=birthday;
				JianKangCache.setGlobalData('userinfo',userInfo);
				swal({
					title : "",
					text : "修改成功",
					type : "success",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
				$("#birthday").html(birthday);
				$("#personal").show();
				$("#birth").hide();
			}
		}
	})	
}

//性别修改
function checkUpdateSex(){
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/updateOrganizeUserInfo?userid='+userid+'&sex='+sex,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
			}else{
				userInfo.sex=sex;
				JianKangCache.setGlobalData('userinfo',userInfo);
				swal({
					title : "",
					text : "修改成功",
					type : "success",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
				if(sex==0){
					$("#sex").html("女");
				}else{
					$("#sex").html("男");
				}
				$("#personal").show();
				$("#sexs").hide();
				location.reload(false);
			}
		}
	})
}

//单选按钮切换选择
function checkout(obj){
	if( obj == 0 ){
		sex = "0";
		$("#boy").attr("class","check");
		$("#girl").attr("class","check_ed");
	}else{
		sex="1";
		$("#boy").attr("class","check_ed");
		$("#girl").attr("class","check");
	}
}

//手机号码是否公开
function checkUpdateOn(){
    var isshowphone=$("#isshowphone").val();
	if(isshowphone ==1){
		isshowphone=0;
		$("#handle").attr("class","off");
		$("#opens").html("保密");
	     var phone = $("#phone").html();
         var mphone =phone.substr(3,4);
         var lphone = phone.replace(mphone,"****");
         $("#phone").html(lphone);
	}else{
		isshowphone=1;
		$("#handle").attr("class","on");
		$("#opens").html("公开");
         $("#phone").html(userInfo.phone);
	}
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/updateOrganizeUserInfo?userid='+userid+'&isshowphone='+isshowphone,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
			}else{
				userInfo.isshowphone=isshowphone;
				JianKangCache.setGlobalData('userinfo',userInfo);
				$("#isshowphone").val(isshowphone);
			}
		}
	})
}

//邮箱修改
function checkUpdateEamil(){
	//获取页面输出的邮箱号
	var email =$("#emails").val();
	var myreg =/\w+[@]{1}\w+[.]\w+/; 
	///^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/;
	///^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
	if (myreg.test(email))   {   
			$.ajax({
				type:'post',
				dataType:'json',
				url:projectpath+'/app/updateOrganizeUserInfo?userid='+userid+'&email='+email,
				success:function(data){
					if(data.status==1){
						swal({
							title : "",
							text :data.message,
							type : "error",
							showCancelButton : false,
							confirmButtonColor : "#ff7922",
							confirmButtonText : "确认",
							cancelButtonText : "取消",
							closeOnConfirm : true
						}, function(){
						
						});
						
					}else{
						userInfo.email=email;
						JianKangCache.setGlobalData('userinfo',userInfo);
						swal({
							title : "",
							text : "修改成功",
							type : "success",
							showCancelButton : false,
							confirmButtonColor : "#ff7922",
							confirmButtonText : "确认",
							cancelButtonText : "取消",
							closeOnConfirm : true
						}, function(){
						
						});
						$("#email").html(email);
						$("#personal").show();
						$("#emal").hide();
					}
				}
			})
  }else{   
		  swal({
				title : "",
				text : "邮箱格式错误,请重新输入....",
				type : "error",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
			
			});
	
    }   	
}

//判断是谁进来这个页面：1：本人进来，可以修改基本信息；2：点击头像进来，判断是否有权修改，	$("#").attr({ "disabled": "disabled" });
function onloadData(){
	$("#headimage").attr("src",projectpath+'/upload/images/9405816_202118647149_2.jpg');
	fundispaly();
	/* 
	var param = new Object();
	param.userid= userid;
	$.ajax({
		type:'post',
		url:projectpath+'/app/getUserIndexPage',
		data:param,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.msg,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
			}else{
				$("#headimage").attr("src",projectpath+data.dataMap.userMap.headimage);
				$("#realname").text(data.dataMap.userMap.realname);
				$("#birthday").text(data.dataMap.userMap.birthday==undefined?" ":data.dataMap.userMap.birthday);
				$("#email").text(data.dataMap.userMap.email==undefined?" ":data.dataMap.userMap.email);
				$("#position").text(data.dataMap.userMap.position);
				
				$("#isshowphone").val(data.dataMap.userMap.isshowphone);
				
				if(userInfo.isshowphone==1){
					$("#handle").attr("class","on");
					$("#opens").text("公开");
			         $("#phone").text(data.dataMap.userMap.phone);
				}else{
					$("#handle").attr("class","off");
					$("#opens").text("保密");
				     var phone = data.dataMap.userMap.phone;
			         var mphone =phone.substr(3,4);
			         var lphone = phone.replace(mphone,"****");
			         $("#phone").text(lphone);
				}
				
				if(userInfo.sex == 0){
					$("#sex").html("女");
				}else if(userInfo.sex == 1){
					$("#sex").html("男");
				}
				$("#name").hide();
				$("#birth").hide();
				$("#sexs").hide();
				$("#emal").hide();
				$("#posion").hide();
				
				//日期框
				var currYear = (new Date()).getFullYear();	
				var opt={};
					opt.date = {preset : 'date', dateFormat: 'yy-mm-dd' };
					//opt.datetime = { preset : 'datetime', minDate: new Date(2012,3,10,9,22), maxDate: new Date(2014,7,30,15,44), stepMinute: 5  };
					opt.datetime = {preset : 'date', dateFormat: 'yy-mm-dd' }; 
					opt.time = {preset : 'time'};
					opt.default = { 
						theme: 'android-ics light', //皮肤样式  
				        display: 'modal', //显示方式  
				        mode: 'scroller', //日期选择模式
				        dateOrder : 'yymmdd',  
						lang:'zh',
				        startYear:currYear - 50, //开始年份
				        endYear:currYear + 50 //结束年份
					};
				//初始化时间插件
				$("#birthdays").scroller('destroy').scroller($.extend(opt['datetime'], opt['default']));
				if(data.dataMap.userMap!=null ){
					//查询用户的部门
					oncheckOrgan(data.dataMap.userMap.userid,data.dataMap.userMap.companyid);	
				}	
				//判断用户是否修改权限\
				if(userInfo.managerole == 3){
					fundispaly();
					$("#organamedivli").attr("onclick","$('#htmlbody').hide();$('#organizeiframe').show();onloadSelect();");
					$("#organamediv").attr("class","");
					$("#positiondivli").attr("onclick","checkUpdate('position')");
					$("#positiondiv").attr("class","");
				}else if(userInfo.managerole == 2){
					fundispaly();
					$.ajax({
						type:'post',
						dataType:'json',
						url:projectpath+'/app/getPersonalByUserId?userid='+userid.userid+'&resourceid='+userInfo.userid,
						success:function(data){
							if(data.status==1){
								swal({
									title : "",
									text : data.message,
									type : "error",
									showCancelButton : false,
									confirmButtonColor : "#ff7922",
									confirmButtonText : "确认",
									cancelButtonText : "取消",
									closeOnConfirm : true
								}, function(){
								
								});
							}else{
								if(data != null){
									if(data.releOrganIdList.length > 0){
										if(data.userOrganIdLsit.length > 0){
										for(var i= 0 ; i< data.releOrganIdList.length;i++){
												for(var j=0 ;j < data.userOrganIdLsit.length;j++){
													var releOrganId = data.releOrganIdList[i].organizeid;
													var userorganId = data.userOrganIdLsit[j].organizeid;
													if(releOrganId == userorganId){
														number ++;
														organizeid = releOrganId;
														$("#organamedivli").attr("onclick","$('#htmlbody').hide();$('#organizeiframe').show();onloadSelect();");
														$("#organamediv").attr("class","");
														$("#position").attr("onclick","checkUpdate('position')");
														$("#positiondiv").attr("class","");
														organizeList[number]={organizeid:releOrganId};
												}
											}
										}
											
										}//releOrganIdList
										
									}
								}			
								
							}//if else
						}
					})
				}else{
					if(data.dataMap.userMap.userid == userInfo.userid){
						fundispaly();
					}
						
				}
			}
		}
	}) */
}
function onPhotoDataSuccess(imageData){
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/updateOrganizeUserInfo?userid='+userid+'&headimage='+imageData,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
			}else{
				$('#headimage').attr("src",projectpath+imageData);
				swal({
					title : "",
					text : "修改成功",
					type : "success",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				});
			}
		}
	});
}

function fundispaly(){
	$("#headimagedivli").attr("onclick","getPhoto(pictureSource.PHOTOLIBRARY,{type:13})");
	$("#headimagediv").attr("class","tx");
	$("#realnamedivli").attr("onclick","checkUpdate('name')");
	$("#realnamediv").attr("class","");
	$("#birthdaydivli").attr("onclick","checkUpdate('birth')");
	$("#birthdaydiv").attr("class","");
	$("#sexsli").attr("onclick","checkUpdate('sexs')");
	$("#sexdiv").attr("class","");
	$("#phone").attr("onclick","checkUpdateOn()");
	$("#handle").show();
	$("#opens").show();
	$("#emaildivli").attr("onclick","checkUpdate('emal')");
	$("#emaildiv").attr("class","");
}

//查询当前用户部门
function oncheckOrgan(userid,companyid){
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getOrganizeByUser?userid='+userid+'&companyid='+companyid,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					
				});
			}else{
				if(data.organizelist.length > 0){
					var temp="";
					if(data.organizelist.length > 1){
						for(var j=0;j<data.organizelist.length ;j++){
							if(j > 0){
								temp +=",";
							}
							temp += data.organizelist[j].organizename;
						}
					}else{
						temp += data.organizelist[0].organizename;
					}
					
					$('#organame').text(temp.substring(0,15));
				}else{
					$('#organame').text(userInfo.companyname);
				}
			}
		}
	})	

}

//部门修改
function logical(){
	var param = new Object();
	param.organizeidUpdate=$("#organizeid").val();
	param.organizeid =organizeid;
	param.organizename=$("#organizename").val();
	param.userid=userInfo.userid;
	param.companyid=userInfo.companyid;
	$.ajax({
		type:'post',
		url:projectpath+'/app/updateOrganizeUserInfo',
		data:param,	
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
			}else{
				swal({
					title : "",
					text : data.message,
					type : "success",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					$("#organame").html($("#organizename").val());
					$("#personal").show();
				});
			
			}
		}
	})
}


</script>	
<body onload="onloadData()">
<div id="htmlbody" >
<div id="personal">
	<div class="head_box">
		<a class="ico_back"  onclick="goBackPage()" >返回</a>
	    <div class="name">个人信息</div>
	</div>
	<div class="head_none"></div>
	<div class="user_xx" >
		<ul >
	    	<li id="headimagedivli"><span class="tx">头像</span><i class="no" id="headimagediv" > <div class="img"><img src="" id="headimage"></div></i><div class="clear"></div></li>
	        <li id="realnamedivli"><span>姓名</span><i class="no" id="realnamediv" ><span id="realname"  ></span></i></li>
	        <li id="birthdaydivli"><span>生日</span><i class="no" id="birthdaydiv"><span id="birthday" ></span></i></li>
	        <li id="sexsli"><span>性别</span><i class="no" id="sexdiv"><span id="sex"></span></i></li>
	        <li id="headimagedivli">
	        	<span>账号(手机号)</span>
	            <div class="tel" >
		            <div class="xx" style="margin-right: 0px;">
		            	<span id="phone" ></span>
		            </div>
			            <div class="xx" style="margin-right: 0px;display:none; font-size:16px;"  id="opens"></div>
			            <div class="on" onclick="checkUpdateOn()" style="display:none;" id ="handle"><em>操作</em></div>

	            </div><!--不公开的样式为off-->
	        	 <!--隐藏域-->
	        	 <input id="isshowphone"  type="hidden" ></input> 
	        </li>
	        <li id="emaildivli"><span>邮箱</span><i class="no" id="emaildiv"><span id="email" onclick="checkUpdate('emal')"></span></i></li>
	        <li id="organamedivli"><span>部门</span><i class="no"  id="organamediv"><span id="organame" ></span>
	        	    <input type ="hidden"  id="organizeid" />
	        	     <input type ="hidden"  id="manageid" />
    				<input type ="hidden"  id="organizename" />
	        </i></li>
	        <li id="positiondivli" ><span>职位</span><i class="no" id="positiondiv"><span id="position" ></span></i></li>
	    </ul>
	</div>
</div>
</div>


<div  id="name" >
	<div class="head_box">
		<a class="ico_back" onclick="checkReturn('name')">返回</a>
	    <div class="name"  >修改姓名</div>
	  <div class="link_yellow" onclick="checkUpdateName()">保存</div>
	</div>
	<div class="head_none"></div>
	<div class="ch_info">
		<span  ><input type="text" class="t_text" placeholder="请输入真实姓名"  id ="realnames"></span>
	</div>
</div>

<div id="birth">
	<div class="head_box">
		<a class="ico_back" onclick="checkReturn('birth')">返回</a>
	    <div class="name">修改生日</div>
  		<div class="link_yellow" onclick="checkUpdateBirthday()">保存</div>
	</div>
	<div class="head_none"></div>
	<div class="ch_info">
		<span><input type="text" class="t_text" placeholder="请选择生日"  id="birthdays" ></span>
	</div>
</div>

<div id="sexs">
		<div class="head_box">
			<a class="ico_back" onclick="checkReturn('sexs')">返回</a>
			<div class="name">修改性别</div>
			<div class="link_yellow"  onclick="checkUpdateSex()">保存</div>
		</div>
		<div class="head_none"></div>
		<div class="ch_info">
			<span class="sex">
				<a class="check_ed" 	onclick="checkout(1)" id ="boy" >选择</a><i>男</i>
				<a class="check"  onclick="checkout(0)" id="girl">选择</a><i>女</i>
			</span>
		</div>
</div>

<div id="emal">
	<div class="head_box">
		<a class="ico_back" onclick="checkReturn('emal')">返回</a>
	    <div class="name">修改邮箱</div>
  		<div class="link_yellow" onclick="checkUpdateEamil()" id="saveEmail">保存</div>		
	</div>
	<div class="head_none"></div>
	<div class="ch_info">
		<span><input type="text" class="t_text" placeholder="请输入邮箱账号"  id="emails"></span>
	 </div>
</div>

<div  id="posion" >
	<div class="head_box">
		<a class="ico_back" onclick="checkReturn('posion')">返回</a>
	    <div class="name"  >修改职位</div>
	  <div class="link_yellow" onclick="checkUpdatePosition()">保存</div>
	</div>
	<div class="head_none"></div>
	<div class="ch_info">
		<span  ><input type="text" class="t_text" placeholder="请输入职位"  id ="posions"></span>
	</div>
</div>




<script type="text/javascript" src="../appcssjs/script/select_release_range.js"></script>
</body>
</html>
