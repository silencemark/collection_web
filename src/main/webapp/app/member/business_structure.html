 <!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>企业架构</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/member.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/structure.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
</head>
<script type="text/javascript">
var userInfo,
	type,
	organizeid="";

JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;

})
this.userid= userInfo.userid;

var organizelistall = "";
function onloadData(){
	if(typeof(userInfo.powerMap.power7001010) == "undefined"){
		$('#poweradd').hide();
	}
	$("#chenge").hide();
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getStructureMangeOrganizeList?companyid='+userInfo.companyid+'&userid='+userInfo.userid,
		beforeSend:function(a,b){
			ajaxbefore();
		},
		complete:function(a,b){
			ajaxcomplete();
		},
		success:function(data){
			organizelistall = data.organizelist;
			$.each(organizelistall,function(i,map){
				if(map.parentid == undefined){
					$('#organdiv').text(map.organizename);
					$('#organdiv').nextAll().remove();
					
					getorganizelist(0,map.organizeid,map.organizename,'#organdiv',map.childnum);
				}
			});
		}
	})
}

function getorganizelist(num,organizeid,organizename,obj,childnum){
	$("#nodata").css("display","none");
	if(obj !='#organdiv' &&  $(obj).parent().next("ul[class=quyu]").length>0){
		if($(obj).parent().attr("class")=="leve_a_s bg_hidden"){
			$(obj).parent().parent().find("span").hide();
			$(obj).parent().parent().find("ul").hide();
			$(obj).parent().show();
			$(obj).parent().attr("class","leve_a_s bg_show");
			$(obj).parent().next("ul").show();
			$(obj).parent().next("ul").find("span").show();
			$(obj).parent().next("ul").find("span").attr("class","leve_a_s bg_hidden");		
			$(obj).parent().next("ul").find("span[name=levea]").attr("class","leve_a_s");		
			
		}else{
			$(obj).parent().next("ul").hide();
			$(obj).parent().attr("class","leve_a_s bg_hidden");
			$(obj).parent().parent().find("span").show();
		}
		return;
	}
	
	if(organizelistall.length > 0 ){
		var temp="";
		temp+="<ul class=\"quyu\">";
		temp+="<li class=\"leve_a\" >";
		for(var i=0;i<organizelistall.length ;i++){
			if(organizelistall[i].parentid == organizeid){
				if(organizelistall[i].childnum>0){
					temp+="<span class=\"leve_a_s bg_hidden\" style=\"padding:0px 15px 0px "+(num*15+30)+"px;background-position:"+(num*15+15)+"px 50%;\"><i class=\""+changeorganizetype(organizelistall[i].type)+"\" onclick=\"getorganizelist("+(num+1)+",'"+organizelistall[i].organizeid+"','"+organizelistall[i].organizename+"',this)\" >"+organizelistall[i].organizename+"</i>";
					if(organizelistall[i].isnopower == 0){
						if(typeof(userInfo.powerMap.power7001010) != "undefined"){
							temp+="<a class=\"ico_edit ico_a\" onclick=\"checkChenge('"+organizelistall[i].organizeid+"','"+organizelistall[i].organizename+"','"+organizelistall[i].type+"','"+organizelistall[i].datacode+"','"+organizelistall[i].companyid+"','"+organizelistall[i].address+"',this,'"+organizelistall[i].parentid+"','"+organizelistall[i].priority+"')\">修改</a>";
							temp+="<a class=\"ico_del ico_a\" onclick=\"checkDel('"+organizelistall[i].companyid+"','"+organizelistall[i].organizeid+"','"+organizelistall[i].datacode+"','"+organizelistall[i].parentid+"',this,'"+organizelistall[i].parentid+"')\">删除</a>";
						}
					}
					temp +="<div class=\"clear\"></div></span>";	
				}else{
					temp+="<span class=\"leve_a_s\" name=\"levea\" style=\"padding:0px 15px 0px "+(num*15+30)+"px;background-position:"+(num*15+15)+"px 50%;\"><i class=\""+changeorganizetype(organizelistall[i].type)+"\">"+organizelistall[i].organizename+"</i>";
					if(organizelistall[i].isnopower == 0){
						if(typeof(userInfo.powerMap.power7001010) != "undefined"){
							temp+="<a class=\"ico_edit ico_a\" onclick=\"checkChenge('"+organizelistall[i].organizeid+"','"+organizelistall[i].organizename+"','"+organizelistall[i].type+"','"+organizelistall[i].datacode+"','"+organizelistall[i].companyid+"','"+organizelistall[i].address+"',this,'"+organizelistall[i].parentid+"','"+organizelistall[i].priority+"')\">修改</a>";
							temp+="<a class=\"ico_del ico_a\" onclick=\"checkDel('"+organizelistall[i].companyid+"','"+organizelistall[i].organizeid+"','"+organizelistall[i].datacode+"','"+organizelistall[i].parentid+"',this,'"+organizelistall[i].parentid+"')\">删除</a>";
						}
					}
					temp +="<div class=\"clear\"></div></span>";
				}
			}
		}
		temp+="</li></ul>";
		if(obj =='#organdiv'){
			$(obj).after(temp);
      		}else{
      			$(obj).parent().parent().find("span").hide();
      			$(obj).parent().parent().find("ul").hide();
      			$(obj).parent().show();
      			$(obj).parent().attr("class","leve_a_s bg_show");
      			$(obj).parent().after(temp);
      		}
      		if(obj !='#organdiv'){
				$(obj).parent().attr("class","leve_a_s bg_show");
      		}
	}else{
		if(obj !='#organdiv'){
				$(obj).parent().attr("class","leve_a_s");
      		}
	}
		
}

function checkSearch(){
	var param = new Object();
	param.companyid = userInfo.companyid;
	var organizename = $("#organizename").val();
	param.organizename = organizename;
	if(organizename != "" && organizename !=null){
		$.ajax({
			type:'post',
			url:projectpath+'/app/getOrganizeBySearch',
			data:param,	
			beforeSend:function(a,b){
				ajaxbefore();
			},
			complete:function(a,b){
				ajaxcomplete();
			},
			success:function(data){
				if(data.status==1){
					swal({
						title : "",
						text : data.message,
						type : "error",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
					
					});
				}else{
					if(data.organizelist.length > 0 ){
						var temp="";
						temp+="<ul class=\"quyu\">";
						temp+="<li class=\"leve_a\" >";
						for(var i=0;i<data.organizelist.length ;i++){
							if(data.organizelist[i].childnum>0){
								temp+="<span class=\"leve_a_s bg_hidden\" style=\"padding:0px 15px 0px "+(30)+"px;background-position:"+(15)+"px 50%;\"><i class=\""+changeorganizetype(organizelistall[i].type)+"\" onclick=\"getorganizelist("+(1)+",'"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"',this)\" >"+data.organizelist[i].organizename+"</i><a class=\"ico_edit ico_a\" onclick=\"checkChenge('"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"','"+data.organizelist[i].type+"','"+data.organizelist[i].datacode+"','"+data.organizelist[i].companyid+"','"+data.organizelist[i].address+"',this,'"+data.organizelist[i].parentid+"','"+data.organizelist[i].priority+"')\">修改</a>";
								if(typeof(userInfo.powerMap.power7001010) != "undefined"){
									temp+="<a class=\"ico_del ico_a\" onclick=\"checkDel('"+data.organizelist[i].companyid+"','"+data.organizelist[i].organizeid+"','"+data.organizelist[i].datacode+"','"+data.organizelist[i].parentid+"',this,'"+data.organizelist[i].parentid+"')\">删除</a>";
								}
								temp +="<div class=\"clear\"></div></span>";	
							}else{
								temp+="<span class=\"leve_a_s\" name=\"levea\" style=\"padding:0px 15px 0px "+(30)+"px;background-position:"+(15)+"px 50%;\"><i class=\""+changeorganizetype(organizelistall[i].type)+"\">"+data.organizelist[i].organizename+"</i><a class=\"ico_edit ico_a\" onclick=\"checkChenge('"+data.organizelist[i].organizeid+"','"+data.organizelist[i].organizename+"','"+data.organizelist[i].type+"','"+data.organizelist[i].datacode+"','"+data.organizelist[i].companyid+"','"+data.organizelist[i].address+"',this,'"+data.organizelist[i].parentid+"','"+data.organizelist[i].priority+"')\">修改</a>";
								if(typeof(userInfo.powerMap.power7001010) != "undefined"){
									temp+="<a class=\"ico_del ico_a\" onclick=\"checkDel('"+data.organizelist[i].companyid+"','"+data.organizelist[i].organizeid+"','"+data.organizelist[i].datacode+"','"+data.organizelist[i].parentid+"',this,'"+data.organizelist[i].parentid+"')\">删除</a>";
								}
								temp +="<div class=\"clear\"></div></span>";
							}
							
						}
						temp+="</li></ul>";
						$("#nodata").css("display","none");
						$("#organdiv").nextAll().remove();
						$("#organdiv").after(temp);
					}else{
						$("#organdiv").nextAll().remove();
						$("#nodata").css("display","block");
					}
					
					
				}
			}
		})
	}else{
		swal({
			title : "",
			text : "请输入关键字",
			type : "error",
			showCancelButton : false,
			confirmButtonColor : "#ff7922",
			confirmButtonText : "确认",
			cancelButtonText : "取消",
			closeOnConfirm : true
		}, function(){
		
		});
	}
	
}


//删除
function checkDel(companyid,organizeid,datacode){
	var param = new Object();
	param.lastorganizeid = organizeid;
	param.lastcompanyid = companyid;
	param.dcode = datacode;
	if(organizename != "" && organizename !=null){
		$.ajax({
			type:'post',
			url:projectpath+'/app/updateOrganizeDelete',
			data:param,	
			beforeSend:function(a,b){
				ajaxbefore();
			},
			complete:function(a,b){
				ajaxcomplete();
			},
			success:function(data){
				if(data.status==1){
					swal({
						title : "",
						text : data.message,
						type : "error",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
					
					});
				}else{
					swal({
						title : "",
						text : data.message,
						type : "success",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
						onloadData();
					});
				}
			}
		})
	}
}
function checkChenge(organizeid,organizename,type,datacode,companyid,address,obj,parentid,priority){
	var organizemap={};
	organizemap['organizeid']=organizeid;
	organizemap['organizename']=organizename;
	organizemap['type']=type;
	organizemap['datacode']=datacode;
	organizemap['companyid']=companyid;
	organizemap['address']=address;
	organizemap['parentid']=parentid;
	organizemap['num']=0;
	organizemap['priority']=priority;
	var orgaName = $(obj).parent().parent().parent().prev("div").text();
	if(orgaName != null && orgaName != ""){
		organizemap['parentOrgaName']=orgaName;
	}else{
		organizemap['parentOrgaName']=$(obj).parent().parent().parent().prev().find("i").text();
	}
	JianKangCache.setGlobalData("organizemap",organizemap);
	
	location.href= 'business_structure_change.html';
}

function checkInsert(){
	var organizemap={};
	organizemap['num']=1;
	JianKangCache.setGlobalData("organizemap",organizemap);
	location.href= 'business_structure_change.html';
}


function checkfun(){
	location.href= 'business_index.html';
}


</script>
<body	onload="onloadData()">

<!-- 查询 -->
<div id="structure">
	<div class="head_box" >
		<a class="ico_back" onclick="checkfun()">返回</a>
	    <div class="name" >企业架构</div>
	    <div class="link_yellow" onclick="checkInsert()" id="poweradd">新增</div>
	</div>
	<div class="head_none"></div>
	
	<div class="top_sel">
	    <div class="long"><input type="text" class="t_text" placeholder="请输入关键字" id="organizename"></div>
	    <div class="span">&nbsp;</div>
	    <div class="btn"><input type="button" onclick="checkSearch()"></div>
	</div>
	<div class="stru_list">
	  <div class="title" id="organdiv" onclick="onloadData()"></div>
	</div>
</div>	

<!-- 修改 -->
<div id="chenge">
<input type="hidden" id="cheng_orgid"/>
	<div class="head_box" >
		<a class="ico_back" onclick="$('#structure').show();$('#chenge').hide();">返回</a>
		   <div class="name" id="update">修改</div>
	  <div class="link_yellow">保存</div>
	</div>
	<div class="head_none"></div>
	<div class="ch_info">
		<span><input type="text" class="t_text" id="chenge_organizename"></span>
	    <span><input type="text" class="t_sel" id="chenge_"  onclick="checkType()" ></span>
	    <span class="kind"><em>类别：</em>
	    <a class="check_ed" onclick="checkOut(1)" id="type_a">选择</a><i>区域</i>
	    <a class="check" onclick="checkOut(2)" id="type_b">选择</a><i>部门</i>
	    <a class="check" onclick="checkOut(3)" id="type_c">选择</a><i>店面</i></span>
	</div>
</div>


<div class="load_more" style="display: none;" id="nodata"><a>暂无数据</a></div>


</body>
</html>
