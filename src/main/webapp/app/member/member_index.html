<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>主页</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/member.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
</head>
<script type="text/javascript">
var userInfo,
	organizeid;
var userid="";

JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
})
var orgizeid = userInfo.organizeid;
organizeid = userInfo.organizeid;
userid=userInfo.userid;
var param = new Object();
param.userid = userid;
param.companyid = userInfo.companyid;
param.organizeid="-12351";
$.ajax({
	type:'post',
	dataType:'json',
	async:false,
	url:projectpath+'/app/getShopListByUser?userid='+userid+'&companyid='+userInfo.companyid,
	success:function(data1){
		if(data1!=null && data1!=undefined && data1!=="" && data1.shoplist!=null && data1.shoplist!=undefined && data1.shoplist!="" && data1.shoplist.length>0 && data1.shoplist[0].organizeid!=null && data1.shoplist[0].organizeid!=undefined){
			param.organizeid = data1.shoplist[0].organizeid!=null && data1.shoplist[0].organizeid!=undefined?data1.shoplist[0].organizeid:"";	
		}
	}
});


function queryuserinfo(){

	//查询个人首页
	$.ajax({
		type:'post',
		url:projectpath+'/app/getUserIndexPage',
		data:param,
		success:function(data){
			if(data.status==1){
				/* swal({
					title : "",
					text : data.msg,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				}); */
			}else{
				var managerole = "";
				if(userInfo.managerole == 3){
					managerole="超级管理员";
				}else if(userInfo.managerole == 2){
					managerole="普通管理员";
				}else{
					$("#managerdiv").hide();
				}
				if(data.dataMap.organizeMap!=null){
					var addr = data.dataMap.organizeMap.address;
					if(addr == undefined){
						data.dataMap.organizeMap.address = "";
					}
					$('#organizename').text(data.dataMap.organizeMap.organizename);
					$('#address').text(data.dataMap.organizeMap.address);
					$("#qrcode").attr("src",projectpath+data.dataMap.organizeMap.qrcode);
				}else{
					$("#emul").hide();
					$('#organizename').text(userInfo.companyname);	
				}
				$("#managerole").text(managerole)
				$('#headimage').attr("src",projectpath+data.dataMap.userMap.headimage);
				$('#realname').text(data.dataMap.userMap.realname);
				$('#userid').val(data.dataMap.userMap.userid);
				$('#position').text(data.dataMap.userMap.position);
				$('#kpiCount').text(data.dataMap.kpiCount);

				$('#totalPersonal').text(data.dataMap.totalPersonal==undefined?"0":data.dataMap.totalPersonal);
				xing(data);			
			}
		}
	});
}



function logical(){
	param.organizeid = $("#organizeid").val();
	$.ajax({
		type:'post',
		url:projectpath+'/app/getUserIndexPage',
		data:param,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.msg,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
			}else{
				$("#qrcode").attr("src",projectpath+data.dataMap.organizeMap.qrcode);
				xing(data);
			}
		}
	})
}


//查询改用户未查看的公告
// $.ajax({
// 	type:'post',
// 	dataType:'json',
// 	url:projectpath+'/app/getSystemMessageListByUser?userid='+userid,
// 	success:function(data){
// 		if(data.status==1){
// 			swal({
// 				title : "",
// 				text : data.msg,
// 				type : "error",
// 				showCancelButton : false,
// 				confirmButtonColor : "#ff7922",
// 				confirmButtonText : "确认",
// 				cancelButtonText : "取消",
// 				closeOnConfirm : true
// 			}, function(){
			
// 			});
// 		}else{
			
// 		}
// 	}
// })

	

function checkPersonal(){
	JianKangCache.setGlobalData('userid',$("#userid").val());
	location.href='user_info.html';
}

function checkNotice(){
	location.href='notice_list.html';
}

function checkSystem(){
	location.href='system_set.html';
}

function checkBusiness(){
	location.href='business_index.html';
}


function xing(data){
	$('#totalPersonal').html(data.dataMap.totalPersonal);
	if(data.dataMap.starMap == null){
		$('#averagescore').html(0);
		var kpi_a="",kpi_b="",kpi_c="",kpi_d="";
		for(var i=0;i<5;i++){
				kpi_a += '<em><img src="../appcssjs/images/public/start3.png"></em>';
				kpi_b += '<em><img src="../appcssjs/images/public/start3.png"></em>';
				kpi_c += '<em><img src="../appcssjs/images/public/start3.png"></em>';
				kpi_d += '<em><img src="../appcssjs/images/public/start3.png"></em>';
		}
		$('#tastescore').html(kpi_a);
		$('#environmentscore').html(kpi_b);
		$('#servicescore').html(kpi_c);
		$('#pricescore').html(kpi_d);
		
	}else{
		var tastescore = data.dataMap.starMap.tastescore;
		var environmentscore = data.dataMap.starMap.environmentscore;
		var servicescore = data.dataMap.starMap.servicescore;
		var pricescore = data.dataMap.starMap.pricescore;
		var totalEvluate = data.dataMap.totalEvluate;
		$('#averagescore').html(parseFloat(data.dataMap.starMap.averagescore/totalEvluate).toFixed(1));
		var kpi_a="",kpi_b="",kpi_c="",kpi_d="";
		var num_a=0,num_b=0,num_c=0,num_d=0;
		for(var i=0;i<5;i++){
			var num = parseInt(tastescore/totalEvluate);
			var yu_num = tastescore%totalEvluate;		
			var xs = yu_num/totalEvluate;
			//口味得分
			if(xs == 0){
				num_a = 1;
			}
			if(xs > 0.8){
				num = num + 1;
			}
			if(i<num){
				kpi_a += '<em><img src="../appcssjs/images/public/start2.png"></em>';	
			}else if(xs<=0.2 && num_a== 0){	
				num_a++;
				kpi_a += '<em><img src="../appcssjs/images/public/start_02.png"></em>';	
			}else if(xs<=0.4 && num_a== 0){	
				num_a++;
				kpi_a += '<em><img src="../appcssjs/images/public/start_04.png"></em>';	
			}else if(xs<=0.6 && num_a== 0 ){	
				num_a++;
				kpi_a += '<em><img src="../appcssjs/images/public/start_06.png"></em>';	
			}else if(xs<=0.8 && num_a== 0){	
				num_a++;
				kpi_a += '<em><img src="../appcssjs/images/public/start_08.png"></em>';	
			}else{
				num_a++;
				kpi_a += '<em><img src="../appcssjs/images/public/start3.png"></em>';
			}
			//环境得分
			if(xs == 0){
				num_b = 1;
			}
			num = parseInt(environmentscore/totalEvluate);
			yu_num = environmentscore%totalEvluate;		
			xs = yu_num/totalEvluate;
			if(xs > 0.8){
				num = num + 1;
			}
			if(i<num){
				kpi_b += '<em><img src="../appcssjs/images/public/start2.png"></em>';	
			}else if(xs<=0.2 && num_b== 0){	
				num_b++;
				kpi_b += '<em><img src="../appcssjs/images/public/start_02.png"></em>';	
			}else if(xs<=0.4 && num_b== 0){	
				num_b++;
				kpi_b += '<em><img src="../appcssjs/images/public/start_04.png"></em>';	
			}else if(xs<=0.6 && num_b== 0 ){	
				num_b++;
				kpi_b += '<em><img src="../appcssjs/images/public/start_06.png"></em>';	
			}else if(xs<=0.8 && num_b== 0){	
				num_b++;
				kpi_b += '<em><img src="../appcssjs/images/public/start_08.png"></em>';	
			}else{
				num_b++;
				kpi_b += '<em><img src="../appcssjs/images/public/start3.png"></em>';
			}
			//服务得分
			if(xs == 0){
				num_c = 1;
			}
			num = parseInt(environmentscore/totalEvluate);
			yu_num = environmentscore%totalEvluate;		
			xs = yu_num/totalEvluate;
			if(xs > 0.8){
				num = num + 1;
			}
			if(i<num){
				kpi_c += '<em><img src="../appcssjs/images/public/start2.png"></em>';	
			}else if(xs<=0.2 && num_c== 0){	
				num_c++;
				kpi_c += '<em><img src="../appcssjs/images/public/start_02.png"></em>';	
			}else if(xs<=0.4 && num_c== 0){	
				num_c++;
				kpi_c += '<em><img src="../appcssjs/images/public/start_04.png"></em>';	
			}else if(xs<=0.6 && num_c== 0 ){	
				num_c++;
				kpi_c += '<em><img src="../appcssjs/images/public/start_06.png"></em>';	
			}else if(xs<=0.8 && num_c== 0){	
				num_c++;
				kpi_c += '<em><img src="../appcssjs/images/public/start_08.png"></em>';	
			}else{
				num_c++;
				kpi_c += '<em><img src="../appcssjs/images/public/start3.png"></em>';
			}
			//价格得分
			if(xs == 0){
				num_d = 1;
			}
			num = parseInt(servicescore/totalEvluate);
			yu_num = pricescore%totalEvluate;		
			xs = pricescore/totalEvluate;
			if(xs > 0.8){
				num = num + 1;
			}
			if(i<num){
				kpi_d += '<em><img src="../appcssjs/images/public/start2.png"></em>';	
			}else if(xs<=0.2 && num_d== 0){	
				num_d++;
				kpi_d += '<em><img src="../appcssjs/images/public/start_02.png"></em>';	
			}else if(xs<=0.4 && num_d== 0){	
				num_d++;
				kpi_d += '<em><img src="../appcssjs/images/public/start_04.png"></em>';	
			}else if(xs<=0.6 && num_d== 0 ){	
				num_d++;
				kpi_d += '<em><img src="../appcssjs/images/public/start_06.png"></em>';	
			}else if(xs<=0.8 && num_d== 0){	
				num_d++;
				kpi_d += '<em><img src="../appcssjs/images/public/start_08.png"></em>';	
			}else{
				num_d++;
				kpi_d += '<em><img src="../appcssjs/images/public/start3.png"></em>';
			}
			
			
		}
		$('#tastescore').html(kpi_a);
		$('#environmentscore').html(kpi_b);
		$('#servicescore').html(kpi_c);
		$('#pricescore').html(kpi_d);
	
		
	}
}
function onloaddata(){
	//更新底部新消息数量
	$.ajax({
		type:"post",
		dataType:"json",
		url:projectpath+"/app/getChatRecordStatusCount",
		data:{ 
			userid:userInfo.userid
		},
		success:function(data){
			if(data.success && data.count>0){
				$('#messagecount').text(data.count);
				$('#messagecount').show(); 
			}else{
				$('#messagecount').hide(); 
			}
		}
	})
}
</script>
<body onload="onloaddata();queryuserinfo();">
<div id="htmlbody">
<div class="head_box">
    <div class="name">我的</div>
</div>
<div class="head_none"></div>
<div class="banner_box" onclick="checkPersonal()">
	<input type = "hidden"  id="userid" />
	<div class="user_img"><img src="" id="headimage"></div>
    <div class="name"><span id="realname"></span><i><span id="position" ></span></i></div>
    <div class="kpi"><span id="kpiCount"></span></div>
    <div class="clear"></div>
</div>
<div class="menu_list">
	<ul>
    	<li onclick="checkNotice()"><b><img src="../appcssjs/images/member/ico_menu01.png"><i id="applynum" style="display: none" ></i></b><span>系统公告</span><i>详情</i></li>
        <li onclick="checkBusiness()"><b><img src="../appcssjs/images/member/ico_menu02.png"></b><span>企业管理</span><i>详情</i></li>
        <li onclick="checkSystem()"  ><b><img src="../appcssjs/images/member/ico_menu03.png"></b><span>系统设置</span><i>详情</i></li>
    </ul>
</div>
<div class="sp_xxbox">
	<input type="hidden" id="organizeid"/>
	<div class="name"><span id="organizename" onclick="$('#htmlbody').hide();$('#organizeiframe').show();" ></span>
	<i onclick="imgutil.FDIMG('#qrcode')"><img alt="二维码" src=""  id="qrcode"></i></div>
    <ul id="emul">
    	<li><span>店面人数</span><i><span id="totalPersonal" ></span></i></li>
        <li><span>综合得分</span><i><span id="averagescore" ></span></i></li>
        <li><span>口味得分</span><b id="tastescore"></b></li>
        <li><span>环境得分</span><b id="environmentscore"></b></li>
        <li><span>服务得分</span><b id="servicescore"></b></li>
        <li><span>价格得分</span><b id="pricescore"></b></li>
        <li><span>地址</span><i id="address"></i><div class="clear"></div></li>
    </ul>
</div>
<div class="ts_xx" id="managerdiv">您当前的权限角色是：<span id="managerole"></span></div>
<div class="bt_none"></div>
<div class="bt_menu">
	<ul>
    	<li><a href="../login/index.html"><b class="bg_home"></b><span>首页</span></a></li>
        <li><a href="../message/index.html"><b class="bg_msg"></b><span>消息</span></a><em id="messagecount" style="display:none"></em></li>
        <li><a href="../memorandum/memorandum_index.html"><b class="bg_memo"></b><span>备忘录</span></a></li>
        <li><a href="../share/index.html"><b class="bg_share"></b><span>分享圈</span></a><em id="sharenum" style="display: none;"></em></li>
        <li class="dq"><a><b class="bg_user"></b><span>我的</span></a></li>
    </ul>
</div>
</div>
<script type="text/javascript">
	$(function(){
		var param = new Object();
		param.createid = userInfo.userid;
		$.ajax({
			url:projectpath+"/app/getShareNotReadNumByUser",
			type:"post",
			data:param,
			success:function(data){
				var num = data.num;
				if(num > 0){
					$('#sharenum').show().text(num);
				}
			}
		});
	});
</script>
<script type="text/javascript" src="../appcssjs/script/selectUserinfoShop.js"></script>
</body>
</html>
