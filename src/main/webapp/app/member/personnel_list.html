 <!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>企业架构</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/member.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/structure.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
</head>
<script type="text/javascript">
var userInfo,
	type,
	organizeid="";
	organizeName="";

JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;

})
this.userid= userInfo.userid;

function panduan(){
	if(typeof(userInfo.powerMap.power7001010) == "undefined"){
		$('#poweradd').hide();
		$(".ico_jinyong").hide();
		$(".ico_edit").hide();
		$(".ico_yaoqing2").hide();
		$(".ico_shouquan").hide();
		$("#distable").hide();
		$("#call").hide();
		$(".check_ed").hide();
		$(".check").hide();
		$(".first").hide();
	}
}

var organizelistall = "";
function onloadData(){
	panduan();
	
	$("#chenge").hide();
	var realnme = $('#realname').val();
	if(realnme == ""){
		$.ajax({
			type:'post',
			dataType:'json',
			url:projectpath+'/app/getStructureMangeOrganizeList?companyid='+userInfo.companyid+'&userid='+userInfo.userid,
			beforeSend:function(a,b){
				ajaxbefore();
			},
			complete:function(a,b){
				ajaxcomplete();
			},
			success:function(data){
				organizelistall = data.organizelist;
				$.each(organizelistall,function(i,map){
					if(map.parentid == undefined){
						$('#organdiv').text(map.organizename);
						$('#organdiv').nextAll().remove();
						organizeName=map.organizename;
						getorganizelist(0,map.organizeid,map.organizename,'#organdiv',map.isnopower);
					}
				})
			}
		});
	}else{
		checkSearch();
	}
}

function getorganizelist(num,organizeid,organizename,obj,isnopower){
	$("#ckout").attr("class","check");
	$("#checkeds a[class=check_ed]").attr("class","check");
	if(obj !='#organdiv' &&  $(obj).parent().next("ul[class=quyu]").length>0){
		if($(obj).parent().attr("class")=="leve_a_s bg_hidden"){
			$(obj).parent().parent().find("span").hide();
			$(obj).parent().parent().find("ul").hide();
			$(obj).parent().nextAll("div[name=person]").hide();
			$(obj).parent().show();
			$(obj).parent().attr("class","leve_a_s bg_show");
			$(obj).parent().next("ul").show();
			$(obj).parent().next("ul").find("span").show();
			$(obj).parent().next("ul").find("div[name=person]").show();
			$(obj).parent().next("ul").find("span").attr("class","leve_a_s bg_hidden");		
			$(obj).parent().next("ul").find("span").attr("class","leve_a_s bg_hidden");		
			$(obj).parent().next("ul").find("span[name=levea]").attr("class","leve_a_s");		
			return;
		}else{
			$(obj).parent().next("ul").hide();
			$(obj).parent().attr("class","leve_a_s bg_hidden");
			
			$(obj).hide();
			num = num -1;
			organizeid = $(obj).attr("parentid");
		}
	}
	
	if(organizelistall!=null ){
		var temp="";
		temp+="<ul class=\"quyu\">";
		temp+="<li class=\"leve_a\" >";
		if(organizelistall.length > 0 ){
			for(var i=0;i<organizelistall.length ;i++){
				if(organizelistall[i].parentid == organizeid){
					if(organizelistall[i].childnum>0 ||organizelistall[i].usernum>0 ){
						temp+="<span class=\"leve_a_s bg_hidden\" style=\"padding:0px 15px 0px "+(num*15+30)+"px;background-position:"+(num*15+15)+"px 50%;\"><i class=\""+changeorganizetype(organizelistall[i].type)+"\" onclick=\"getorganizelist("+(num+1)+",'"+organizelistall[i].organizeid+"','"+organizelistall[i].organizename+"',this,'"+organizelistall[i].isnopower+"')\" parentid=\""+organizelistall[i].parentid+"\" >"+organizelistall[i].organizename+"</i><div class=\"clear\"></div></span>";
					}else{
						temp+="<span class=\"leve_a_s\" name=\"levea\" style=\"padding:0px 15px 0px "+(num*15+30)+"px;background-position:"+(num*15+15)+"px 50%;\"><i class=\""+changeorganizetype(organizelistall[i].type)+"\">"+organizelistall[i].organizename+"</i><div class=\"clear\"></div></span>";
					}
				}
			}
			for(var i=0;i<organizelistall.length ;i++){
				var data = organizelistall[i];
				if(data.userlist != undefined && data.userlist.length > 0){
					for(var j=0;j<data.userlist.length ;j++){
						if(organizelistall[i].organizeid == organizeid){
							temp+="<div name=\"person\" style=\"display: block;line-height:30px;  \"><i style=\" display: block;float:left; padding:0px 15px 0px "+(num*15+30)+"px\">"+
							"<a class=\"check\" style=\"float:left;\" onclick=\"checkedOut(this)\" userid="+data.userlist[j].userid+" organizeid="+data.userlist[j].organizeid+" phone="+data.userlist[j].phone+" username='"+data.userlist[j].realname+"'>选择</a><font class=\"ico_person\">"+data.userlist[j].realname+"</font></i>";
							if(typeof(userInfo.powerMap.power7001010) != "undefined" && userInfo.userid != data.userlist[j].userid){
								temp += "<i class=\"ico_jinyong\"  style=\"display: block;float:right;  line-height:30px;margin-right: 5px;  margin-left:1%;\" onclick=\"checkStauts('"+data.userlist[j].userid+"','"+data.userlist[j].organizeid+"')\">禁用</i>";
								temp += "<i class=\"ico_edit\" style=\"display: block;float:right;  line-height:30px;  margin-left:1%; \" onclick=\"checkUpdate('"+data.userlist[j].phone+"','"+data.userlist[j].userid+"','"+data.userlist[j].realname+"','"+data.userlist[j].position+"','"+data.userlist[j].organizename+"','"+data.userlist[j].organizeid+"','"+data.userlist[j].manageid+"')\">修改</i>";
								if(data.userlist[j].isinvite == 1){
									temp += "<i class=\"ico_yaoqing2\" style=\" display: block;float:right;  line-height:30px; margin-left:1%;\" onclick=\"checkCall('"+data.userlist[j].phone+"','"+data.userlist[j].userid+"','"+data.userlist[j].realname+"')\">邀请</i>";
								}else{	
									temp += "<i class=\"ico_yaoqing\" style=\" display: block;float:right;  line-height:30px;  margin-left:1%;\" onclick=\"checkCall('"+data.userlist[j].phone+"','"+data.userlist[j].userid+"','"+data.userlist[j].realname+"')\">邀请</i>";
								}
								if(data.userlist[j].managerole != 2 && data.userlist[j].managerole != 3){
									temp+="<i class=\"ico_shouquan\" style=\" display: block;float:right;  line-height:30px;  margin-left:1%;\" onclick=\"shouquan('"+data.userlist[j].userid+"','"+data.userlist[j].realname+"')\">授权</i><div class=\"clear\"></div></div>";
								}else{
									temp+="<i class=\"ico_shouquan\" style=\" display: block;float:right;  line-height:30px;  margin-left:1%;\"></i><div class=\"clear\"></div></div>";
								}
							}else{
								temp+="<i class=\"ico_shouquan\" style=\" display: block;float:right;  line-height:30px;  margin-left:1%;\"></i><div class=\"clear\"></div></div>";
							}
							
						}
					}
				}
			}
		}
		
		temp+="</li></ul>";
		if(obj =='#organdiv'){
			$(obj).after(temp);
      		}else{
      			$(obj).parent().parent().find("span").hide();
      			$(obj).parent().parent().find("ul").hide();
      			$(obj).parent().parent().find("div[name=person]").hide();
      			$(obj).parent().show();
      			$(obj).parent().attr("class","leve_a_s bg_show");
      			$(obj).parent().after(temp);
      		}
      		if(obj !='#organdiv'){
				$(obj).parent().attr("class","leve_a_s bg_show");
      		}
	}else{
		if(obj !='#organdiv'){
				$(obj).parent().attr("class","leve_a_s");
      		}
	}
	panduan();
	
}

function checkSearch(){
	var param = new Object();
	param.companyid = userInfo.companyid;
	var realname = $("#realname").val();
	param.searchname = realname;
	if(realname != "" && realname !=null){
		$.ajax({
			type:'post',
			url:projectpath+'/app/getUserBySearch',
			data:param,	
			beforeSend:function(a,b){
				ajaxbefore();
			},
			complete:function(a,b){
				ajaxcomplete();
			},
			success:function(data){
				if(data.status==1){
					swal({
						title : "",
						text : data.message,
						type : "error",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
					
					});
				}else{		
					if(data.userlist.length > 0){
						var temp="";
						temp+="<ul class=\"quyu\">";
						temp+="<li class=\"leve_a\" >";
						for(var j=0;j<data.userlist.length ;j++){
							temp+="<div name=\"person\" style=\"display: block;line-height:30px;  \"><i  style=\" display: block;float:left; padding:0px 15px 0px 30px; overflow:hidden; white-space:nowrap; width:40%;\">"+
							"<a class=\"check\" onclick=\"checkedOut(this)\" userid="+data.userlist[j].userid+" organizeid="+data.userlist[j].organizeid+" phone="+data.userlist[j].phone+"  username='"+data.userlist[j].realname+"' >选择</a><font class=\"ico_person\">"+data.userlist[j].realname+"-"+data.userlist[j].organizename+"</font></i>";
							if(typeof(userInfo.powerMap.power7001010) != "undefined" && userInfo.userid != data.userlist[j].userid){
								temp += "<i class=\"ico_jinyong\"  style=\"display: block;float:right;  line-height:30px;margin-right: 5px;  margin-left:1%;\" onclick=\"checkStauts('"+data.userlist[j].userid+"','"+data.userlist[j].organizeid+"')\">禁用</i>";
								temp += "<i class=\"ico_edit\" style=\"display: block;float:right;  line-height:30px;  margin-left:1%; \" onclick=\"checkUpdate('"+data.userlist[j].phone+"','"+data.userlist[j].userid+"','"+data.userlist[j].realname+"','"+data.userlist[j].position+"','"+data.userlist[j].organizename+"','"+data.userlist[j].organizeid+"','"+data.userlist[j].manageid+"')\">修改</i>";
								if(data.userlist[j].isinvite == 1){
									temp += "<i class=\"ico_yaoqing2\" style=\" display: block;float:right;  line-height:30px; margin-left:1%;\" onclick=\"checkCall('"+data.userlist[j].phone+"','"+data.userlist[j].userid+"','"+data.userlist[j].realname+"')\">邀请</i>";
								}else{	
									temp += "<i class=\"ico_yaoqing\" style=\" display: block;float:right;  line-height:30px;  margin-left:1%;\" onclick=\"checkCall('"+data.userlist[j].phone+"','"+data.userlist[j].userid+"','"+data.userlist[j].realname+"')\">邀请</i>";
								}
								if(data.userlist[j].managerole != 2 && data.userlist[j].managerole != 3){
									temp+="<i class=\"ico_shouquan\" style=\" display: block;float:right;  line-height:30px;  margin-left:1%;\" onclick=\"shouquan('"+data.userlist[j].userid+"','"+data.userlist[j].realname+"')\">授权</i><div class=\"clear\"></div></div>";
								}else{
									temp+="<i class=\"ico_shouquan\" style=\" display: block;float:right;  line-height:30px;  margin-left:1%;\"></i><div class=\"clear\"></div></div>";
								}
							}else{
								temp+="<i class=\"ico_shouquan\" style=\" display: block;float:right;  line-height:30px;  margin-left:1%;\"></i><div class=\"clear\"></div></div>";
							}
							
						}
						temp+="</li></ul>";
						$("#nodata").css("display","none");
						$("#organdiv").nextAll().remove();
						$("#organdiv").after(temp);
					}else{
						$("#organdiv").nextAll().remove();
						$("#nodata").css("display","block");
					}
					
					
				}
				panduan();
			}
		})
	}else{
		onloadData();
	}
	
}

function checkStauts(userid,organizeid){
	var param = new Object();
	param.userid = userid;
	param.organizeid =organizeid;
	param.status = 0;
	
		$.ajax({
			type:'post',
			url:projectpath+'/app/updateUserDisable',
			data:param,	
			beforeSend:function(a,b){
				ajaxbefore();
			},
			complete:function(a,b){
				ajaxcomplete();
			},
			success:function(data){
				if(data.status==1){
					swal({
						title : "",
						text : data.message,
						type : "error",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
					
					});
				}else{
					swal({
						title : "",
						text : data.message,
						type : "success",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
						location.href="personnel_list.html";
					});
					
						
				}
			}
		})
	
}

//进入授权页面
function shouquan(userid,realname){
	var noneusermap = {};
	noneusermap['userid'] = userid;
	noneusermap['realname'] = realname;
	JianKangCache.setGlobalData("noneusermap",noneusermap);
	location.href="personnel_power.html";
}

function checkUpdate(phone,userid,realname,position,organizename,organizeid,manageid){
	var usermap = {};
	usermap['phone'] = phone;
	usermap['userid'] = userid;
	usermap['realname'] = realname;
	usermap['position'] = position;
	usermap['organizename'] = organizename;
	usermap['organizeid'] = organizeid;
	usermap['manageid']=manageid;
	JianKangCache.setGlobalData("usermap",usermap);
	location.href="personnel_update.html";
}

function checkAdd(){
	location.href="personnel_add.html";
}

function checkFind(){
	location.href="personnel_list_find.html";
}

function checkedOut(obj){
	if($(obj).attr("class")=="check"){
		$(obj).attr("class","check_ed");
	}else{
		$(obj).attr("class","check");
	}
	
}

function checked(obj){
	if($(obj).attr("class")=="check"){
		$(obj).attr("class","check_ed");
		$("#checkeds a[class=check]").each(function(index){
			if($(this).parent().parent().is(':visible')){
				$(this).attr("class","check_ed");
			}
		})
	}else{
		$(obj).attr("class","check");
		$("#checkeds a[class=check]").each(function(index){
			if($(this).parent().parent().is(':visible')){
				$(this).attr("class","check");
			}
		})
	}
}

//禁用 
function checkData(){
		$("#distable").attr("class","active");
		$("#call").attr("class","");
		if($("#checkeds a[class=check_ed]").length>0){
			var list = [];
			var  param = new Object();
			param.status=0;
			$("#checkeds a[class=check_ed]").each(function(index,dom){
				list[index] = {userid:$(this).attr("userid"),organizeid:$(this).attr("organizeid")}
				param.organizeid =list[0].organizeid;
			})	
			param.list = JSON.stringify(list);
			
			$.ajax({
				type:'post',
				url:projectpath+'/app/updateUserDisable',
				data:param,	
				beforeSend:function(a,b){
					ajaxbefore();
				},
				complete:function(a,b){
					ajaxcomplete();
				},
				success:function(data){
					if(data.status==1){
						swal({
							title : "",
							text : "禁用出错",
							type : "error",
							showCancelButton : false,
							confirmButtonColor : "#ff7922",
							confirmButtonText : "确认",
							cancelButtonText : "取消",
							closeOnConfirm : true
						}, function(){
						
						});
					}else{
							swal({
								title : "",
								text : "禁用成功",
								type : "success",
								showCancelButton : false,
								confirmButtonColor : "#ff7922",
								confirmButtonText : "确认",
								cancelButtonText : "取消",
								closeOnConfirm : true
							}, function(){
								location.href="personnel_list.html";	
							});
							
					}
				}
			})
			
		}else{
				swal({
					title : "",
					text : "请选择一个人员",
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
		}
		
}
//单选邀请
function checkCall(phone,userid,username){
	var  param = new Object();
	param.phone=phone;
	param.organizename=organizeName;
	param.username=username;
	param.userid=userid;
	param.updatename = userInfo.realname;
	$.ajax({
		type:'post',
		url:projectpath+'/app/updateUserInvitation',
		data:param,	
		beforeSend:function(a,b){
			ajaxbefore();
		},
		complete:function(a,b){
			ajaxcomplete();
		},
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				
				});
			}else{
				swal({
					title : "",
					text : data.message,
					type : "success",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					location.href="personnel_list.html";
				});
				
				
			}
		}
	})

}

//多选邀请
function checkCallAll(){
	$("#distable").attr("class","");
	$("#call").attr("class","active");
	if($("#checkeds a[class=check_ed]").length>0){
		var list = [];
		var  param = new Object();
		param.organizename=organizeName;

		$("#checkeds a[class=check_ed]").each(function(index,dom){
			list[index] = {userid:$(this).attr("userid"),phone:$(this).attr("phone"), username:$(this).attr("username")};
		})	
		param.list = JSON.stringify(list);
		param.updatename = userInfo.realname;
		$.ajax({
			type:'post',
			url:projectpath+'/app/updateUserInvitation',
			data:param,	
			beforeSend:function(a,b){
				ajaxbefore();
			},
			complete:function(a,b){
				ajaxcomplete();
			},
			success:function(data){
				if(data.status==1){
					swal({
						title : "",
						text : "邀请失败",
						type : "error",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
					
					});
				}else{
						swal({
							title : "",
							text : data.message,
							type : "success",
							showCancelButton : false,
							confirmButtonColor : "#ff7922",
							confirmButtonText : "确认",
							cancelButtonText : "取消",
							closeOnConfirm : true
						}, function(){
							location.href="personnel_list.html";	
						});
						

				}	
					
			}
		})
		
	}else{
			swal({
				title : "",
				text : "请选择一个人员",
				type : "error",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
			
			});
	
	}
	
}

function goIndex(){
	location.href="business_index.html";
}

</script>
<body onload="onloadData()">

<!-- 查询 -->

	<div id="structure">
		<div class="head_box" >
			<a class="ico_back" onclick="goIndex()">返回</a>
		    <div class="name" >人员管理</div>
		    <div class="link_yellow" onclick="checkAdd()" id="poweradd">新增</div>
		</div>
		<div class="head_none"></div>
		<div class="span_nav">
		<span class="active" >在职人员</span>
	    <span class="last" onclick="checkFind()">禁用人员</span>
	</div>
<div id="checkeds">
		<div class="top_sel">
		    <div class="long"><input type="text" class="t_text" placeholder="请输入关键字" id="realname"></div>
		    <div class="span">&nbsp;</div>
		    <div class="btn"><input type="button" onclick="checkSearch()"></div>
		</div>
		<div class="stru_list">
		  <div class="title" id="organdiv" onclick="onloadData()"></div><div class="clear"></div>
		</div>

	</div>
	<div class="load_more" style="display: none;" id="nodata"><a>暂无数据</a></div>
	<div class="foot_per">
		<span class="first"><b><a class="check" onclick="checked(this)" id="ckout">选择</a><i>全选</i></b></span>
	    <span class="active"  onclick = "checkData()" id="distable">禁用</span>
	    <span id="call" onclick="checkCallAll()">邀请</span>

</div>
</body>
</html>
