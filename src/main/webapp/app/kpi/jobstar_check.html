<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>岗位星值-审批</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/kpi.css">

<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>

<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/showcomment.js"></script>
</head>

<body>
<div id="htmlbody">
<input type="hidden" id="examineuserid">
<span id="examinename" style="display:none"></span>
<div class="head_box">
	<a class="ico_back" onclick="goBackPage();">返回</a>
    <div class="name">岗位星值-审核</div>
</div>
<div class="head_none"></div>
<div class="xx_one">
	<ul>
        <li>所属区域：<i id="organizename"></i></li>
        <li>岗位名称：<i id="gangwei"></i></li>
    </ul>
</div>
<div class="star_list">
	<ul id="evaluate_list">
<!--     	<li><span>仪容仪表</span><b><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start3.png"></em><em><img src="../appcssjs/images/public/start3.png"></em></b></li> -->
<!--         <li><span>微笑服务</span><b><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start3.png"></em><em><img src="../appcssjs/images/public/start3.png"></em></b></li> -->
<!--         <li><span>区域卫生</span><b><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start3.png"></em><em><img src="../appcssjs/images/public/start3.png"></em></b></li> -->
<!--         <li><span>物品摆放</span><b><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start3.png"></em><em><img src="../appcssjs/images/public/start3.png"></em></b></li> -->
<!--         <li><span>餐前准备</span><b><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start3.png"></em><em><img src="../appcssjs/images/public/start3.png"></em></b></li> -->
<!--         <li><span>工作纪律</span><b><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start3.png"></em><em><img src="../appcssjs/images/public/start3.png"></em></b></li> -->
<!--         <li><span>团队意识</span><b><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start2.png"></em><em><img src="../appcssjs/images/public/start3.png"></em><em><img src="../appcssjs/images/public/start3.png"></em></b></li> -->
    </ul>
    <div class="total">合计：<i id="sumstar"></i>星</div>
</div>

<div class="xx_user">
    <div class="txt">
        <span class="name">申请人：<em id="shenqing_name"></em></span>
        <span class="time">填写时间：<em id="shenqing_time"></em></span>
         <div class="clear"></div>
    </div>
    <div class="txt">
        <span class="name">审批人：<em id="shenpi_name"></em></span>
<!--         <span class="time">审批时间：<em id="shenpi_time"></em></span> -->
		<div class="clear"></div>
    </div>
    <div class="txt">
        <span class="name" style="width:98%;text-overflow:ellipsis ; overflow:hidden; white-space:nowrap;">抄送人：<em id="CCusernames"></em></span>
         <div class="clear"></div>
    </div>
    <div class="txt last">
        <span class="name" style="font-weight: bold;">审批意见</span>
        <textarea class="text_area" placeholder="请输入审批意见，最多允许输入800字符" maxlength="800" id="adivce"></textarea>
     </div>   
</div>
<div class="comment">
	<div class="name">共有<em id="comnum">0</em>条评论</div>
    <ul id="comment_list">
    </ul>
</div>
<div class="fbtn_none"></div>
<div class="foot_btn">
	<span name="foot_span" onclick="tongyi(1)" class="active">同意</span>
    <span name="foot_span" onclick="tongyi(2)">拒绝</span>
<!--     <span name="foot_span" onclick="$('#organizeiframe').show();$('#htmlbody').hide();">转发</span> -->
<!--     <span name="foot_span" onclick="comment_opent_close()">评论</span> -->
</div>

<div class="div_mask" style="display: none" id="screen"></div>
<div class="tc_comment" style="display: none" id="commentdiv">
	<div class="name">评论</div>
	<input type="hidden" id="parentid" />
	<input type="hidden" id="parentuserid" />
    <div class="text_box"><textarea id="content"></textarea></div>
    <div class="btn_box">
    	<input type="button" value="提交" class="btn_01" onclick="addComment();">
        <input type="button" value="取消" class="btn_02" onclick="comment_opent_close();">
    </div>
</div>
</div>

<script type="text/javascript">
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
	userInfo = data
});
</script>
<script type="text/javascript" src="../appcssjs/script/selectuser_forward.js"></script>
</body>

<script type="text/javascript">

var evaluateid = appBase.getQueryString("evaluateid");
var userid = appBase.getQueryString("userid");
var examine_createid = "";
$(function(){
	var resourceType = appBase.getQueryString("type");
	//修改未读状态
	intoDetailUpdateRead(userid, evaluateid, resourceType);
	
	var obj = new Object();
	obj.evaluateid = evaluateid;
	obj.userid = userid;
	requestPost('/app/getEvaluateInfo',obj,'detail_'+evaluateid+userid,true,function(resultMap){
		if(resultMap != undefined && resultMap != null){
			var evaluateInfo = resultMap.evaluateInfo;
			var evaluatelist = resultMap.evaluatelist;
			//显示审核项目
			if(evaluatelist.length > 0 && evaluatelist != null){
				var htm = "";
				$.each(evaluatelist,function(i,map){
					var status = map.status;
					if(status == 1 || status == "1"){
						htm += '<li>'+
									'<span style="font-weight:bold;">'+map.projectname+'</span>'+
									'<b><input type="hidden" name="input_star" id="'+map.starid+'_input" starid="'+map.starid+'" sumNum="0"/></b>'+
								'</li>';
					}else{
						var xing = "";
						var starlevel = map.starlevel;
						for(var q=1;q<=5;q++){
							if(q<=starlevel){
								xing += '<em onclick="xuanze(\''+map.starid+'\',\''+q+'\')"><img id="'+map.starid+'_'+q+'" name="img_'+map.starid+'" src="../appcssjs/images/public/start2.png"></em>';
							}else{
								xing += '<em onclick="xuanze(\''+map.starid+'\',\''+q+'\')"><img id="'+map.starid+'_'+q+'" name="img_'+map.starid+'" src="../appcssjs/images/public/start3.png"></em>';
							}
						}
						htm += '<li>'+
										'<span>'+map.projectname+'</span>'+
										'<b>'+
											'<input type="hidden" name="input_star" id="'+map.starid+'_input" starid="'+map.starid+'" sumNum="'+starlevel+'"/>'+
											xing+
											'<font style="font-weight:normal; font-size:12px;" id="'+map.starid+'_starlevel">&nbsp;&nbsp;'+dengji(starlevel)+'</font>'+
										'</b>'+
									'</li>';
					}
				});
				$('#evaluate_list').append(htm);
			}
			//显示审核的基本信息
			if(evaluateInfo != null){
				$('#shenqing_name').text(evaluateInfo.createname);
				$('#shenqing_time').text(appBase.parseDateMinute(evaluateInfo.createtime));
				$('#shenpi_name').text(evaluateInfo.examinename);
				$('#shenpi_time').text(appBase.parseDateMinute(new Date()));
				$('#organizename').text(evaluateInfo.organizename);
				$('#gangwei').text(evaluateInfo.templatename);
				$('#sumstar').text(evaluateInfo.sumstar);
				$('#shenqing_name').attr("onclick","location.href='../member/homepage_info.html?userid="+evaluateInfo.createid+"'");
				$('#shenpi_name').attr("onclick","location.href='../member/homepage_info.html?userid="+evaluateInfo.examineuserid+"'");
				examine_createid = evaluateInfo.createid;
				
				$('#CCusernames').text(evaluateInfo.CCusernames);
			}
		}
	});
	
	obj.resourcetype = 6;
	obj.orderid = evaluateid;
	//查询评论信息
	requestPost("/app/getOrderComment",obj,"",true,function(resultMap){
		if(resultMap != undefined && resultMap != null){
			var commentlist = resultMap.commentlist;
			var commentnum = resultMap.num;
			$('#comnum').text(commentnum);
			showComment(commentlist);
		}
	});
	
	//评论加载更多
	PageHelper({
		url:projectpath+"/app/getOrderComment",
		data:obj,
		success:function(resultMap){
			if(resultMap != undefined && resultMap != null){
				var commentlist = resultMap.commentlist;
				showComment(commentlist);
			}
		}
	}); 
	
	//样式切换
	$('.foot_btn').delegate('span[name="foot_span"]',"click",function(){
		$('span[name="foot_span"]').attr("class","");
		$(this).attr("class","active");
	});
	
});

function dengji(level){
	level = parseInt(level);
	/* if(level == 1){
		return "很差";
	}else if(level == 2){
		return "不差";
	}else if(level == 3){
		return "一般";
	}else if(level == 4){
		return "&nbsp;&nbsp;&nbsp;好";
	}else if(level == 5){
		return "很好";
	} */
	if(level == 1){
		return "一星";
	}else if(level == 2){
		return "二星";
	}else if(level == 3){
		return "三星";
	}else if(level == 4){
		return "四星";
	}else if(level == 5){
		return "五星";
	}
}

//选择项目星级
function xuanze(i,k){
	$('img[name="img_'+i+'"]').attr("src","../appcssjs/images/public/start3.png");
	for(var j=1;j<=k;j++){
		$('#'+i+"_"+j).attr("src","../appcssjs/images/public/start2.png");
	}
	$('#'+i+'_input').attr("sumNum",k);
	$('#'+i+'_starlevel').html("&nbsp;&nbsp;"+dengji(k));
	
	var input = $('input[name="input_star"]');
	var sumstar = "0";
	$.each(input,function(k,item){
		var bn = $(item).attr("sumNum");
		sumstar = parseInt(bn) + parseInt(sumstar);
	});
	$('#sumstar').text(sumstar);
}
function logical(){
	swal({
		title : "",
		text : "确认转发给"+$('#examinename').text()+"？",
		type : "success",
		showCancelButton : true,
		confirmButtonColor : "#ff7922",
		confirmButtonText : "确认",
		cancelButtonText : "取消",
		closeOnConfirm : true
	}, function(){
		userForword(userInfo.companyid,evaluateid,$('#examineuserid').val(),userInfo.userid,6);
	});
}
//添加评论信息
function addComment(){
	var param = new Object();
	param.content = $('#content').val();
	param.userid = userid;
	param.resourceid = evaluateid;
	param.resourcetype = 6;

	addcommentAjax(param);
}

function tongyi(num){
	var obj = new Object();
	var starlist = {"starlist":[]};
	var input = $('input[name="input_star"]');
	$.each(input,function(i,item){
		var star = new Object();
		star.starid = $(item).attr("starid");
		star.evaluateid = evaluateid;
		star.starlevel = $(item).attr("sumNum");
		starlist.starlist[i] = star;
	});
	obj.opinion = $('#adivce').val();
	obj.result = num;
	obj.evaluateid = evaluateid;
	obj.starlist = JSON.stringify(starlist);
	obj.sumstar = $('#sumstar').text();
	
	if(obj.opinion == ""){
		swal({
			title : "",
			text : "审批意见不能为空",
			type : "error",
			showCancelButton : false,
			confirmButtonColor : "#ff7922",
			confirmButtonText : "确认",
			cancelButtonText : "取消",
			closeOnConfirm : true
		}, function(){
			
		});
		return false;
	}
	$.ajax({
		url:projectpath+"/app/examineEvaluate",
		type:"post",
		data:obj,
		success:function(resultMap){
			if(resultMap.status == '0' || resultMap.status == 0){
				changeIsread(examine_createid,evaluateid);
				var title=$('#shenpi_name').text()+"审批了您的岗位自评,请及时查看";
				var url="/kpi/jobstar_detail.html?evaluateid="+evaluateid+"&userid="+examine_createid;
				pushMessage(examine_createid,title,url);
				swal({   
					title: "",   
					text: "<font style=\"color:#ff7922; font-size:28px; margin-left:20px;\">操作成功！</font>",
					type:"success",
					timer: 1000,
					html:true,
					showConfirmButton: false 
				}, function(){
					window.history.go(-1);
 				});
			}else{
				swal({
					title : "",
					text : "网络异常，请稍后重试···",
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				});
			}
		}
	});
}

//公共的查询方法
function requestPost(url,data,identifying,issynchroniz,callback){
	$.ajax({
		url:projectpath+url,
		data:data,
		async:issynchroniz,
		type:"post",
		beforeSend:function(){
			$('#jiazaizhong').show();
		},
		success:function(resultMap){
			//保存到当前路径缓存
			JianKangCache.setData("kpi_",resultMap);
			callback(resultMap);
		},error:function(e){
			//取出缓存数据
			JianKangCache.getData("kpi_",function(resultMap){
				callback(resultMap);
			});
		},complete:function(){
			$('#jiazaizhong').hide();
		}
	});
}
</script>
</html>
