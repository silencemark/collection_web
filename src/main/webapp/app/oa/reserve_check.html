<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>审核备用金申请</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/oa.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
</head>
<script type="text/javascript">
var reserveamountid= getUrlParam("reserveamountid");
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
})
var examineuserid="";
var level = "";
function onloadData(){
	//标记为已读
	readstatus(reserveamountid,userInfo.userid);
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getReserveAmountInfo?reserveamountid='+reserveamountid,
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					
				});
			}else{
				$('#reason').text(data.reserveamountinfo.reason);
				if(data.reserveamountinfo.urgentlevel==1){
					$('#urgentlevel').attr("class","w_green");
					$('#urgentlevel').text("普通");
				}else if(data.reserveamountinfo.urgentlevel==2){
					$('#urgentlevel').attr("class","w_yellow");
					$('#urgentlevel').text("紧急");
				}else if(data.reserveamountinfo.urgentlevel==3){
					$('#urgentlevel').attr("class","w_red");
					$('#urgentlevel').text("非常紧急");
				}
				$('#amount').text(data.reserveamountinfo.amount);
				$('#usetime').text(appBase.parseDate(data.reserveamountinfo.usetime));
				$('#returntime').text(appBase.parseDate(data.reserveamountinfo.returntime));
				$('#remark').text(data.reserveamountinfo.remark);
				$('#examineinfoname').text(data.reserveamountinfo.examinename);
				$('#createname').text(data.reserveamountinfo.createname);
				$('#createtime').text(appBase.parseDateMinute(data.reserveamountinfo.createtime));
				level= data.reserveamountinfo.urgentlevel;
				$('#createname').attr("onclick","location.href='../member/homepage_info.html?userid="+data.reserveamountinfo.createid+"'");
				examineuserid = data.reserveamountinfo.createid;
				$('#examineinfoname').attr("onclick","location.href='../member/homepage_info.html?userid="+data.reserveamountinfo.examineuserid+"'");
				$('#CCusernames').text(data.reserveamountinfo.CCusernames)
			}
		}
	})
	
	//查询评论信息
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getOrderComment?orderid='+reserveamountid+"&resourcetype="+20,
		success:function(data){
			$("#commentnum").text(data.num);
				if(data.commentlist.length > 0){
					var temp="";
					for(var i=0;i<data.commentlist.length;i++){
							temp+="<li><div class=\"xx\"><b><img src=\""+projectpath+data.commentlist[i].headimage+"\" onclick=\"location.href='../member/homepage_info.html?userid="+data.commentlist[i].userid+"'\"  /></b>";
							if(data.commentlist[i].replyname!= ""){
								temp+="<span onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">"+data.commentlist[i].realname+"&nbsp;回复&nbsp;"+data.commentlist[i].replyname+"</span>";
							}else{
								temp+="<span onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">"+data.commentlist[i].realname+"</span>";
							}
							temp+="<i>"+data.commentlist[i].createtime+"</i></div>"+
					            "<div class=\"txt\" onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">"+data.commentlist[i].content+"</div></li>";
					}
					$('#commentul').append(temp);
				}
			}
	})
}

PageHelper({
	url:projectpath+'/app/getOrderComment?orderid='+reserveamountid+"&resourcetype="+20,
	success:function(data){
		if(data.commentlist.length > 0){
			var temp="";
			for(var i=0;i<data.commentlist.length;i++){
					temp+="<li><div class=\"xx\"><b><img src=\""+projectpath+data.commentlist[i].headimage+"\" onclick=\"location.href='../member/homepage_info.html?userid="+data.commentlist[i].userid+"'\"  /></b>";
					if(data.commentlist[i].replyname!= ""){
						temp+="<span onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">"+data.commentlist[i].realname+"&nbsp;回复&nbsp;"+data.commentlist[i].replyname+"</span>";
					}else{
						temp+="<span onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">"+data.commentlist[i].realname+"</span>";
					}
					temp+="<i>"+data.commentlist[i].createtime+"</i></div>"+
			            "<div class=\"txt\" onclick=\"initaddcomment('"+data.commentlist[i].commentid+"','"+data.commentlist[i].userid+"')\">"+data.commentlist[i].content+"</div></li>";
			}
			$('#commentul').append(temp);
		}
	}
}); 

function examineorder(result){
	if($('#opinion').val()==""){
		swal({
			title : "",
			text : "请输入审批意见",
			type : "error",
			showCancelButton : false,
			confirmButtonColor : "#ff7922",
			confirmButtonText : "确认",
			cancelButtonText : "取消",
			closeOnConfirm : true
		}, function(){
			
		});
		return;
	}
	$.ajax({
		type:'post',
		beforeSend:function(a,b){
			ajaxbefore();
		},
		complete:function(a,b){
			ajaxcomplete();
		},
		dataType:'json',
		url:projectpath+'/app/examineReserveAmount?reserveamountid='+reserveamountid+"&userid="+userInfo.userid+"&result="+result+"&opinion="+$('#opinion').val()+"&level="+level,
		success:function(data){
			if(data.status == '0' || data.status == 0){
				changeIsread(examineuserid,reserveamountid);
				swal({   
					title: "",   
					text: "<font style=\"color:#ff7922; font-size:28px; margin-left:20px;\">操作成功！</font>",
					type:"success",
					timer: 1000,
					html:true,
					showConfirmButton: false 
				}, function(){
					window.history.go(-1);
 				});
			}else{
				swal({
					title : "",
					text : "网络异常，请稍后重试···",
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
				});
			}
		}
	})
}

function logical(){
	swal({
		title : "",
		text : "确认转发给"+$('#examinename').text()+"？",
		type : "success",
		showCancelButton : false,
		confirmButtonColor : "#ff7922",
		confirmButtonText : "确认",
		cancelButtonText : "取消",
		closeOnConfirm : true
	}, function(){
		userForword(userInfo.companyid,reserveamountid,$('#examineuserid').val(),userInfo.userid,20);
		location.reload(false);
	});
}
</script>
<body onload="onloadData()">
<div id="htmlbody">
<input type="hidden" id="examineuserid">
<span id="examinename" style="display:none"></span>
<div class="head_box">
	<a class="ico_back"  onclick="goBackPage()">返回</a>
    <div class="name">审核备用金申请</div>
<!--     <div class="link_yellow" >发送</div> -->
</div>
<div class="head_none"></div>
<div class="detail_box">
	<ul>
        <li>
        	<span class="em">事由</span>
            <div class="clear"></div>
            <p id="reason"></p>
        </li> 
        <li><span>紧急程度</span><i class="w_green" id="urgentlevel">普通</i></li><!--w_yellow w_red-->
        <li><span>申请金额</span><i class="w_yellow" id="amount"></i></li>
        <li><span>使用日期</span><i id="usetime"></i></li>
        <li><span>归还日期</span><i id="returntime"></i></li>
        <li>
        	<span class="em">备注</span>
            <div class="clear"></div>
            <p id="remark"></p>
        </li>
    </ul>
</div>
<div class="xx_user">
    <div class="txt">
        <span class="name">申请人：<em id="createname"></em></span>
        <span class="time">填写时间：<em id="createtime"></em></span>
         <div class="clear"></div>
    </div>
    <div class="txt">
        <span class="name">审批人：<em id="examineinfoname"></em></span>
<!--         <span class="time">审批时间：<em id="nowtime"></em></span> -->
		 <div class="clear"></div>
    </div>
    <div class="txt">
        <span class="name" style="width:98%;text-overflow:ellipsis ; overflow:hidden; white-space:nowrap;">抄送人：<em id="CCusernames"></em></span>
         <div class="clear"></div>
    </div>
    <div class="txt last">
        <span class="name" style="font-weight: bold;">审批意见</span>
        <div class="clear"></div>
        <textarea class="text_area" placeholder="请输入审批意见，最多允许输入800字符" maxlength="800" id="opinion"></textarea>
     </div> 
</div>
<div class="comment">
	<div class="name">共有<em id="commentnum">0</em>条评论</div>
    <ul id="commentul">
    </ul>
</div>

<div class="fbtn_none"></div>
<div class="foot_btn">
	<span class="active" onclick="examineorder(1)">同意</span>
    <span onclick="examineorder(0)">拒绝</span>
<!--     <span onclick="initforwarding()">转发</span> -->
<!--     <span onclick="initaddcomment();">评论</span> -->
</div>

<div class="div_mask" style="display: none"></div>
<div class="tc_comment" style="display: none" id="commentdiv">
	<div class="name">评论</div>
	<input type="hidden" id="parentid" />
		<input type="hidden" id="parentuserid" />
    <div class="text_box"><textarea id="content"></textarea></div>
    <div class="btn_box">
    	<input type="button" value="提交" class="btn_01" onclick="addcomment();">
        <input type="button" value="取消" class="btn_02" onclick="cancel();">
    </div>
</div>
<script type="text/javascript">
var actiontype;
function addcomment(){
	if($('#content').val()==""){
		swal({
			title : "",
			text : "请填写评论内容",
			type : "error",
			showCancelButton : false,
			confirmButtonColor : "#ff7922",
			confirmButtonText : "确认",
			cancelButtonText : "取消",
			closeOnConfirm : true
		}, function(){
			
		});
		return;
	}
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/insertComment?userid='+userInfo.userid+'&content='+$('#content').val()+'&resourceid='+reserveamountid+'&resourcetype=20&parentid='+$('#parentid').val(),
		beforeSend:function(a,b){
			ajaxbefore();
		},
		complete:function(a,b){
			ajaxcomplete();
		},
		success:function(data){
			if(data.status==1){
				swal({
					title : "",
					text : data.message,
					type : "error",
					showCancelButton : false,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					
				});
			}else{
				changeIsread(examineuserid,reserveamountid);
				if(parentid!=""){
					changeIsread($('#parentuserid').val(),reserveamountid);
				}
				/* swal({
					title : "",
					text : "评论成功",
					type : "success",
					showCancelButton : true,
					confirmButtonColor : "#ff7922",
					confirmButtonText : "确认",
					cancelButtonText : "取消",
					closeOnConfirm : true
				}, function(){
					
				}); */
				if(actiontype==1){
					location.reload(false);
				}else{
					$('.div_mask').hide();
					$('#commentdiv').hide();
					$('#organizeiframe').show();
					$('#htmlbody').hide();
				}
			}
		}
	})
}
function initaddcomment(parentid,parentuserid){
	actiontype=1;
	$('#content').val("");
	$('#parentid').val(parentid);
	$('#parentuserid').val(parentuserid);
	$('.div_mask').show();
	$('#commentdiv').show();
}
function cancel(){
	$('#content').val("");
	$('#parentid').val("");
	$('#parentuserid').val("");
	$('.div_mask').hide();
	$('#commentdiv').hide();
}
function initforwarding(parentid,parentuserid){
	actiontype=0;
	$('#content').val("");
	$('#parentid').val(parentid);
	$('#parentuserid').val(parentuserid);
	$('.div_mask').show();
	$('#commentdiv').show();
}
</script>
</div>
<script type="text/javascript" src="../appcssjs/script/selectuser_forward.js"></script>



</body>
</html>
