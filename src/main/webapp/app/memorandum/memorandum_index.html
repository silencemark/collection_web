<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>主页</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/memo.css">
<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script>  
<script type="text/javascript" src="../appcssjs/script/tab.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>

<script type="text/javascript" src="../appcssjs/script/appendjs.js"></script>
<script type="text/javascript" src="../appcssjs/script/cache.js"></script>

<script type="text/javascript" src="../appcssjs/script/constant.js"></script>

</head>
<script src="https://api.map.baidu.com/api?v=2.0&ak=wBYHoaC0rzxp8zqGCdx9WXxa&s=1" type="text/javascript"></script>
<script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/convertor.js"></script>
<script type="text/javascript">
var userInfo;
JianKangCache.getGlobalData('userinfo',function(data){
		userInfo=data;
})
var latitude = 31.24916171; // 纬度，浮点数，范围为90 ~ -90
var longitude = 121.48789949; // 经度，浮点数，范围为180 ~ -180。
function getbaidu(){
	var geolocation = new BMap.Geolocation();
	geolocation.getCurrentPosition(function(r){
		if(this.getStatus() == BMAP_STATUS_SUCCESS){
			longitude = r.point.lng;
			latitude = r.point.lat; 
		}
// 		alert("----------成功获取到经纬度");
		$.ajax({
			type:'post',
			dataType:'json',
			url:projectpath+'/app/getcity?lat='+latitude+'&lng='+longitude+'&userid='+userInfo.userid,
			success:function(data){
// 				alert("根据经纬度成功获取到城市天气信息");
				if(data.weathermap.weatherurl != null){
					$('#weatherurl').attr("src","../appcssjs/images/memo/weather_"+data.weathermap.weatherurl+".png");
				}
				$('#weathername').html(data.weathermap.cityname);
				$('#weatherStatus').text(data.weathermap.weathername);
				$('#temperature').text(data.weathermap.temperature);
				$('#weekdate').html(data.weathermap.week+"<br/>"+data.weathermap.datetime);
			}
		});
	},function(error){
		$.ajax({
			type:'post',
			dataType:'json',
			url:projectpath+'/app/getcity?lat='+latitude+'&lng='+longitude+'&userid='+userInfo.userid,
			success:function(data){
// 				alert("根据经纬度成功获取到城市天气信息");
				if(data.weathermap.weatherurl != null){
					$('#weatherurl').attr("src","../appcssjs/images/memo/weather_"+data.weathermap.weatherurl+".png");
				}
				$('#weathername').html(data.weathermap.cityname);
				$('#weatherStatus').text(data.weathermap.weathername);
				$('#temperature').text(data.weathermap.temperature);
				$('#weekdate').html(data.weathermap.week+"<br/>"+data.weathermap.datetime);
			}
		});
	},{enableHighAccuracy: false});
}
function onloaddata(){
	//更新底部新消息数量
	$.ajax({
		type:"post",
		dataType:"json",
		url:projectpath+"/app/getChatRecordStatusCount",
		data:{ 
			userid:userInfo.userid
		},
		success:function(data){
			if(data.success && data.count>0){
				$('#messagecount').text(data.count);
				$('#messagecount').show(); 
			}else{
				$('#messagecount').hide(); 
			}
		}
	})
}
function onloadData(){
	//更新底部新消息数量
	onloaddata();
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getWeather?userid='+userInfo.userid,
		success:function(data){
			 if(data.status==1){
// 				alert("城市信息失效，重新获取");
				 getbaidu();
			}else{
// 				alert("城市信息获取成功");
				if(data.weathermap.weatherurl != null){
					$('#weatherurl').attr("src","../appcssjs/images/memo/weather_"+data.weathermap.weatherurl+".png");
				}
				$('#weathername').html(data.weathermap.cityname);
				$('#weatherStatus').text(data.weathermap.weathername);
				$('#temperature').text(data.weathermap.temperature);
				$('#weekdate').html(data.weathermap.week+"<br/>"+data.weathermap.datetime);
			} 
		}
	})
	
	$.ajax({
		type:'post',
		dataType:'json',
		url:projectpath+'/app/getMemorandumList?companyid='+userInfo.companyid+'&createid='+userInfo.userid,
		success:function(data){
			if(data.memorandumlist.length > 0){
				var temp="";
				for(var i=0;i<data.memorandumlist.length;i++){
					temp+="<li onclick=\"location.href=\'meno_detail.html?memorandumid="+data.memorandumlist[i].memorandumid+"\'\"><div class=\"point\"></div><i>"+data.memorandumlist[i].hourtime+"</i><span class=\"word_hidden\">"+data.memorandumlist[i].content+"</span></li>";
				}
				$('#memoul').html(temp);
			}else{
				$('.ul_head').hide();
				$('#memoul').html("");
			}
		}
	})
}
PageHelper({
	url:projectpath+'/app/getMemorandumList?companyid='+userInfo.companyid+'&createid='+userInfo.userid,
	success:function(data){
		if(data.memorandumlist.length > 0){
			var temp="";
			for(var i=0;i<data.memorandumlist.length;i++){
				temp+="<li onclick=\"location.href=\'meno_detail.html?memorandumid="+data.memorandumlist[i].memorandumid+"\'\"><div class=\"point\"></div><i>"+data.memorandumlist[i].hourtime+"</i><span class=\"word_hidden\">"+data.memorandumlist[i].content+"</span></li>";
			}
			$('#memoul').append(temp);
		}
	}
});  
/**
 * 扫描登录
 */
function inputScan(){
	     cordova.plugins.barcodeScanner.scan(function (result) {
	    	 var value = result.text;
	    	 var format = result.format;
	    	 var cancelled = result.cancelled;
	    	 if(format=="QR_CODE"){
	    		 //当前扫描为路径
	    		 if(value ==null || value==""){
	    			 return;
	    		 }else if(value.indexOf("https://")==0 || value.indexOf("http://")==0 ||value.indexOf("www.")==0){
	    			 if(value.indexOf("www.")==0){
	    				 value = "http://"+value;
	    			 }
	    			 showContent(value,"info");
	    			 return;
	    		 }else{
	    			 try{
	    				 value = JSON.parse(value);
	    				 //登录
	    				 if(value.scantype=="scanlogin"){
	    					 ScanLogin(value);
	    				 }else{
	    					 showContent(value,"info");
	    				 }
	    			 }catch(e){
	    				 showContent(value,"info");
	    			 }
	    		 }
	    	 }
		},function (error) {
			showContent("调用相机失败！","error");
		});
}
function showContent(value,type){
	swal({
		title : "",
		text : value,
		type : type,
		showCancelButton : false,
		confirmButtonColor : "#ff7922",
		confirmButtonText : "确认",
		cancelButtonText : "取消",
		closeOnConfirm : true
	}, function(){
	
	});
}
function ScanLogin(data){
	$.ajax({
		type:'post',
		dataType:'json',
		data:{
			status:0,
			scantype:"smcg",
			RegId:data.RegId,
			msg:"扫描成功"
		},
		async: false,
		url:projectpath+'/app/dwrlogin',
		success:function(data){ }
	})
	 swal({
			title : "",
			text : "确定通过扫一扫在PC端登陆吗？",
			type : "info",
			showCancelButton : true,
			confirmButtonColor : "#ff7922",
			confirmButtonText : "确认",
			cancelButtonText : "取消",
			closeOnConfirm: false,
			closeOnCancel: false
		}, function(isConfirm){
			if(isConfirm){
				$.ajax({
					type:'post',
					dataType:'json',
					data:{
						status:1,
						scantype:"smdl",
						RegId:data.RegId,
						code:userInfo.userid,
						msg:"允许登录"
					},
					url:projectpath+'/app/dwrlogin',
					success:function(data){
						if(data.success){
							setTimeout(function(){
								showContent("PC端登录成功！","success"); 
							},500)
							
						}else{
							setTimeout(function(){
								showContent("授权失败！","error");
							},500)
						}
					},error:function(){
						setTimeout(function(){
							showContent("授权失败！","error");
						},500)
					}
				})
			}else{
				$.ajax({
					type:'post',
					dataType:'json',
					data:{
						status:2,
						scantype:"smdl",
						RegId:data.RegId,
						code:userInfo.userid,
						msg:"不允许登录"
					},
					url:projectpath+'/app/dwrlogin',
					success:function(data){ 
					},error:function(){ 
					}
				})
				setTimeout(function(){
					showContent("取消授权成功！","success"); 
				},500)
			}
		})
}
</script>
<body onload="onloadData()">
<div class="head_box">
	<a class="ico_sys" onclick="inputScan()">扫一扫</a>
    <div class="name">备忘录</div>
    <a class="ico_cal" onclick="location.href='calendar.html'">日历</a>
</div>
<div class="head_none"></div>
<div class="memo_top" style="height:188px;">
	<div class="box">
    	<div class="xx_l">
    		<span style="line-height:30px; font-size:25px; width:110px; text-align:center;" id="weathername"></span>
    		<div class="clear"></div>
        	<span id="temperature" style="line-height:70px; font-size:60px;"></span>
            <div class="clear"></div>
            <em id="weekdate" style="text-align:center;"></em>
        </div>
        <div class="xx_r" style="width:50%; margin-top:10px;"><img style="width:80px; float:right;" src="" id="weatherurl"></div>
        <div style="float: right; text-align:right; line-height:48px; height:48px; font-size:18px;text-overflow:ellipsis ; overflow:hidden; white-space:nowrap; width:120px;" id="weatherStatus"></div>
        <div class="clear"></div>
    </div>
</div>

<div class="memo_list">
	<div class="name">
    	<span>今日安排</span>
        <a onclick="location.href='meno_add.html'">添加</a>
    </div>
    <div class="li_list">
    	<div class="ul_head"></div>
    	<ul id="memoul">
        </ul>        
        <div class="ul_foot"></div>
    </div>
</div>

<div class="bt_none"></div>
<div class="bt_menu">
	<ul>
    	<li><a href="../login/index.html"><b class="bg_home"></b><span>首页</span></a></li>
        <li><a href="../message/index.html"><b class="bg_msg"></b><span>消息</span></a><em id="messagecount" style="display:none"></em></li>
        <li class="dq"><a><b class="bg_memo"></b><span>备忘录</span></a></li>
        <li><a href="../share/index.html"><b class="bg_share"></b><span>分享圈</span></a><em id="sharenum" style="display: none;"></em></li>
        <li><a href="../member/member_index.html"><b class="bg_user"></b><span>我的</span></a></li>
    </ul>
</div>
<script type="text/javascript">
	$(function(){
		var param = new Object();
		param.createid = userInfo.userid;
		$.ajax({
			url:projectpath+"/app/getShareNotReadNumByUser",
			type:"post",
			data:param,
			success:function(data){
				var num = data.num;
				if(num > 0){
					$('#sharenum').show().text(num);
				}
			}
		});
	});
</script>
</body>
</html>
