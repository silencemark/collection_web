<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>主页</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" >
<!-- 强制让文档的宽度与设备的宽度保持1:1，并且文档最大的宽度比例是1.0，且不允许用户点击屏幕放大浏览 -->
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width, minimal-ui">
<!-- iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="../appcssjs/style/artEditor.css">

<link type="text/css" rel="stylesheet" href="../appcssjs/style/public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/page_public.css">
<link type="text/css" rel="stylesheet" href="../appcssjs/style/share.css">

<script type="text/javascript" src="../appcssjs/script/jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="../appcssjs/sweetalert/dist/sweetalert.css">
<script src="../appcssjs/sweetalert/dist/sweetalert-dev.js"></script> 

<script type="text/javascript" src="../appcssjs/script/cache.js"></script>
<script type="text/javascript" src="../appcssjs/script/page.js"></script>
<script type="text/javascript" src="../appcssjs/script/constant.js"></script>
<script type="text/javascript" src="../appcssjs/script/appbase.js"></script>

<script src="../appcssjs/script/artEditor.min.js"></script>
</head>

<body>
<div class="head_box">
	<a class="ico_back" onclick="window.history.go(-1)">返回</a>
    <div class="name">新建分享</div>
    <div class="link_yellow" onclick="addShare()">发送</div>
</div>
<div class="head_none"></div>
<div class="detail_box">
	<ul>
    	<li>
        	<span class="em">分享内容</span>
            <div class="clear"></div>
<!--             <p><textarea class="text_area" placeholder="请输入分享内容，最多允许输入800字符" maxlength="800" id="content"></textarea></p> -->
			<div>
		        <div class="publish-article-content">
		            <div class="article-content" id="content"></div>
		        </div>
		    </div>
            <div class="img_list">
                <div id="imgslist">
            		
            	</div>
                <div class="img_add" onclick="uploadimage(3)">添加图片</div>
                <div class="clear"></div>
            </div>
        </li>
    </ul>
</div>
<script type="text/javascript">
	
	$(function(){
		"use strict";
        $('#content').artEditor({
            imgTar: '#imageUpload',
            limitSize: 5,   // 兆
            showServer: false,
            uploadUrl: '',
            data: {},
            uploadField: 'image',
            placeholader: '<p>请输入分享内容，最多允许输入800字符</p>',
            validHtml: ["br"],
            uploadSuccess: function(res) {
                return res.path;
            },
            uploadError: function(res) {
                console.log(res);
            }
        });
	});
	
	var userInfo = "";
	JianKangCache.getGlobalData('userinfo',function(data){
		userInfo = data;
	});
	
	var pagetype = appBase.getQueryString("pagetype");
	
	function onPhotoDataSuccess(imageData,fileSize) {
		$('#imgslist').append('<div class="img" imgurl="'+imageData+'" filesize="'+fileSize+'"><b><img src="'+projectpath+imageData+'"></b><div class="del" onclick="$(this).parent().remove()">删除</div></div>');
	}

	function uploadimage(num){
		var imglist = $('#imgslist').find('div[class="img"]');
		if(imglist.length < num){
			getPhoto(pictureSource.PHOTOLIBRARY,{type:15});
		}else{
			swal({
				title : "",
				text : "最多只能上传"+num+"张图片！",
				type : "warning",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
			});
		}
	}
	
	function addShare(){
		var imgs = "";
		var imglist = $('#imgslist').find('div[class="img"]');
		$.each(imglist,function(i,item){
			imgs += $(item).attr("imgurl")+",";
		});
		var param = new Object();
		param.content = $('#content').html();
		param.images = imgs;
		param.createid = userInfo.userid;
		param.companyid = userInfo.companyid;
		
		if(param.content == ""){
			swal({
				title : "",
				text : "分享信息不能为空！",
				type : "warning",
				showCancelButton : false,
				confirmButtonColor : "#ff7922",
				confirmButtonText : "确认",
				cancelButtonText : "取消",
				closeOnConfirm : true
			}, function(){
			});
			return false;
		}
		
		$.ajax({
			url:projectpath+"/app/insertShare",
			type:"post",
			data:param,
			success:function(resultMap){
				if(resultMap.status == 0 || resultMap.status == '0'){
					swal({
						title : "",
						text : "分享成功！",
						type : "success",
						showCancelButton : false,
						confirmButtonColor : "#ff7922",
						confirmButtonText : "确认",
						cancelButtonText : "取消",
						closeOnConfirm : true
					}, function(){
						setTimeout(function(){     
							if(pagetype == "index"){
								location.href="index.html";
							}else if(pagetype == "someone_index"){
								window.history.go(-1);
							}
						}, 1000);
					});
				}
			}
		});
	}
</script>
</body>
</html>
